# 5. Actrix å®‰å…¨ä¸è®¤è¯ä½“ç³»

æœ¬ç« èŠ‚æ¦‚è¿° Actrix ç³»ç»Ÿçš„å®Œæ•´å®‰å…¨è®¤è¯æ¶æ„ï¼ŒåŒ…æ‹¬æ³¨å†Œã€è®¤è¯ã€TURN è®¤è¯ã€å‡­è¯æ›´æ–°å’Œå¯†é’¥è½®æ¢äº”ä¸ªæ ¸å¿ƒæµç¨‹ã€‚

## 5.1 ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

Actrix è®¤è¯ç³»ç»Ÿç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  actr   â”‚â”€â”€â”€â”€â–¶â”‚  Signaling   â”‚â”€â”€â”€â”€â–¶â”‚  AIS   â”‚â”€â”€â”€â”€â–¶â”‚   KS   â”‚
â”‚ å®¢æˆ·ç«¯   â”‚     â”‚  ä¿¡ä»¤æœåŠ¡å™¨   â”‚     â”‚ è®¤è¯æœåŠ¡â”‚     â”‚å¯†é’¥æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                   â”‚             â”‚
     â”‚                  â”‚                   â”‚             â”‚
     â”‚                  â–¼                   â–¼             â–¼
     â”‚              è·¯ç”±è½¬å‘            å‡­è¯ç­¾å‘       å¯†é’¥ç®¡ç†
     â”‚              å‡­è¯éªŒè¯            èº«ä»½éªŒè¯       å¯†é’¥è½®æ¢
     â”‚
     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     TURN     â”‚
                â”‚  ä¸­ç»§æœåŠ¡å™¨   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                  åª’ä½“ä¸­ç»§è®¤è¯
                  LRU ç¼“å­˜
```

**æ ¸å¿ƒç»„ä»¶èŒè´£**ï¼š

| ç»„ä»¶ | èŒè´£ | å…³é”®åŠŸèƒ½ |
|-----|------|---------|
| **actr å®¢æˆ·ç«¯** | èº«ä»½ç®¡ç† | æŒæœ‰å‡­è¯ã€å‘èµ·è®¤è¯ã€TURN è¿æ¥ |
| **Signaling** | è·¯ç”±è½¬å‘ | æ¶ˆæ¯è·¯ç”±ã€å‡­è¯éªŒè¯ã€å®¹å¿æœŸåˆ¤æ–­ |
| **AIS** | å‡­è¯ç­¾å‘ | ç”Ÿæˆå‡­è¯ã€èº«ä»½éªŒè¯ã€å¯†é’¥ç¼“å­˜ |
| **KS** | å¯†é’¥ç®¡ç† | ç”Ÿæˆå¯†é’¥å¯¹ã€å¯†é’¥è½®æ¢ã€å®¹å¿æœŸé…ç½® |
| **TURN** | åª’ä½“ä¸­ç»§ | NAT ç©¿é€ã€PSK è®¤è¯ã€ç¼“å­˜ä¼˜åŒ– |

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

| æ¦‚å¿µ | è¯´æ˜ |
|-----|------|
| **ActrId** | å…¨å±€å”¯ä¸€çš„ Actor æ ‡è¯†ç¬¦ï¼ˆSnowflake ç®—æ³•ç”Ÿæˆï¼‰ |
| **Credential** | åŠ å¯†çš„èº«ä»½å‡­è¯ï¼ˆECIES åŠ å¯†çš„ IdentityClaimsï¼‰ |
| **PSK** | é¢„å…±äº«å¯†é’¥ï¼Œç”¨äº TURN è®¤è¯ï¼ˆ32 å­—èŠ‚éšæœºæ•°ï¼‰ |
| **Key ID** | å¯†é’¥ç‰ˆæœ¬æ ‡è¯†ç¬¦ï¼Œæ”¯æŒå¯†é’¥è½®æ¢ |
| **Realm** | å®‰å…¨åŸŸ/ç§Ÿæˆ·ï¼Œç”¨äºå¤šç§Ÿæˆ·éš”ç¦» |
| **Tolerance Period** | å®¹å¿æœŸï¼Œå¯†é’¥è¿‡æœŸåçš„ç¼“å†²æ—¶é—´ï¼ˆé»˜è®¤ 3600 ç§’ï¼‰ |

---

## 5.2 å®Œæ•´è®¤è¯æµç¨‹å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰

```mermaid
sequenceDiagram
    participant A as actrå®¢æˆ·ç«¯
    participant S as Signaling
    participant AIS as AIS
    participant KS as KS
    participant T as TURN

    %% æ³¨å†Œæµç¨‹
    Note over A,KS: 1. æ³¨å†Œæµç¨‹ (é¦–æ¬¡æ¥å…¥)
    A->>S: RegisterRequest
    S->>AIS: è½¬å‘æ³¨å†Œè¯·æ±‚
    AIS->>KS: è·å–å½“å‰å…¬é’¥ (ç¼“å­˜10åˆ†é’Ÿ)
    KS-->>AIS: è¿”å›å…¬é’¥
    AIS->>AIS: ç”Ÿæˆ ActrId + PSK<br/>åŠ å¯† Credential
    AIS-->>S: è¿”å›èº«ä»½å‡­è¯
    S-->>A: actr_id + credential + psk

    %% ä¸šåŠ¡è®¤è¯
    Note over A,S: 2. ä¸šåŠ¡è¯·æ±‚è®¤è¯
    A->>S: ä¸šåŠ¡è¯·æ±‚ + credential
    S->>S: éªŒè¯ credential<br/>(ç¼“å­˜å¯†é’¥)
    alt éªŒè¯æˆåŠŸ
        S-->>A: ä¸šåŠ¡å“åº”
    else å‡­è¯è¿‡æœŸ
        S-->>A: éœ€è¦æ›´æ–°å‡­è¯
    end

    %% TURNè®¤è¯
    Note over A,T: 3. TURN è®¤è¯
    A->>A: æ„é€  TURN username<br/>(Claims + encrypted PSK)
    A->>T: TURN Allocate Request
    T->>T: è§£å¯†è·å– PSK<br/>(LRUç¼“å­˜è®¤è¯å¯†é’¥)
    T-->>A: åˆ†é…ä¸­ç»§åœ°å€

    %% å‡­è¯æ›´æ–°
    Note over A,AIS: 4. å‡­è¯æ›´æ–° (è¿‡æœŸå‰5åˆ†é’Ÿ)
    A->>S: CredentialUpdateRequest<br/>(æºå¸¦æ—§å‡­è¯)
    S->>S: éªŒè¯æ—§å‡­è¯
    S->>AIS: è¯·æ±‚æ–°å‡­è¯
    AIS->>AIS: ç­¾å‘æ–°å‡­è¯<br/>(ä¿æŒ actr_id + psk ä¸å˜)
    AIS-->>S: æ–°å‡­è¯
    S-->>A: credential + expires_at

    %% å¯†é’¥è½®æ¢
    Note over AIS,KS: 5. å¯†é’¥è½®æ¢ (åå°å®šæ—¶ä»»åŠ¡)
    AIS->>AIS: æ£€æµ‹å¯†é’¥å°†è¿‡æœŸ<br/>(æå‰10åˆ†é’Ÿ)
    AIS->>KS: ç”Ÿæˆæ–°å¯†é’¥
    KS->>KS: ç”Ÿæˆå¯†é’¥å¯¹<br/>å­˜å‚¨åˆ°æ•°æ®åº“
    KS-->>AIS: key_id + public_key
    AIS->>AIS: æ›´æ–°æœ¬åœ°ç¼“å­˜
    Note over KS: æ—§å¯†é’¥è¿›å…¥å®¹å¿æœŸ<br/>(é»˜è®¤1å°æ—¶)
```

---

## 5.3 æ ¸å¿ƒæµç¨‹è¯¦è§£

### 5.3.1 æ³¨å†Œæµç¨‹

**ç›®çš„**ï¼šé¦–æ¬¡æ¥å…¥ç³»ç»Ÿï¼Œè·å–èº«ä»½å‡­è¯

**å…³é”®æ­¥éª¤**ï¼š
1. actr å‘é€ `RegisterRequest`ï¼ˆåŒ…å« actr_typeã€realmï¼‰
2. Signaling éªŒè¯ Realm æœ‰æ•ˆæ€§
3. AIS ä» KS è·å–å½“å‰å…¬é’¥ï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼‰
4. AIS ç”Ÿæˆå”¯ä¸€ ActrIdï¼ˆSnowflake ç®—æ³•ï¼‰
5. AIS ç”Ÿæˆéšæœº PSKï¼ˆ32 å­—èŠ‚ï¼‰
6. AIS ä½¿ç”¨å…¬é’¥åŠ å¯† IdentityClaimsï¼Œç”Ÿæˆ Credential
7. è¿”å› `actr_id` + `credential` + `psk`

**ç¼“å­˜ä¼˜åŒ–**ï¼š
- CurrentKeyCacheï¼ˆAISï¼‰ï¼š10 åˆ†é’Ÿ TTL
- å‡å°‘ 99% çš„ KS è°ƒç”¨

**å…³é”®ä»£ç ä½ç½®**ï¼š
- `actrix/crates/signaling/src/server.rs` (Realm éªŒè¯)
- `actrix/crates/ais/src/issuer.rs` (å‡­è¯ç­¾å‘)

ğŸ‘‰ **è¯¦ç»†æ–‡æ¡£**ï¼š[5.1-registration-flow.md](./5.1-registration-flow.md)

---

### 5.3.2 ä¸šåŠ¡è¯·æ±‚è®¤è¯

**ç›®çš„**ï¼šéªŒè¯æ¯æ¬¡ä¸šåŠ¡è¯·æ±‚çš„èº«ä»½åˆæ³•æ€§

**å…³é”®æ­¥éª¤**ï¼š
1. actr å‘é€ `ActrToSignaling` æ¶ˆæ¯ï¼ˆæºå¸¦ credentialï¼‰
2. Signaling æå– `token_key_id`
3. Signaling ä» SQLite ç¼“å­˜æˆ– KS è·å–å¯†é’¥ä¿¡æ¯ï¼ˆåŒ…å« `secret_key`ã€`expires_at`ã€`tolerance_seconds`ï¼‰
4. Signaling ä½¿ç”¨ ECIES è§£å¯† credential
5. Signaling éªŒè¯ Claimsï¼ˆrealm_idã€actor_idã€è¿‡æœŸæ—¶é—´ï¼‰
6. Signaling åˆ¤æ–­å¯†é’¥æ˜¯å¦åœ¨å®¹å¿æœŸå†…ï¼š
   - å¦‚æœ `expires_at < now <= expires_at + tolerance_seconds`ï¼Œåˆ™åœ¨å®¹å¿æœŸ
   - å¦‚æœ `now > expires_at + tolerance_seconds`ï¼Œå¯†é’¥å·²å®Œå…¨å¤±æ•ˆ
7. å¦‚æœå¯†é’¥åœ¨å®¹å¿æœŸå†…ï¼Œå‘ actr å‘é€ç»­æœŸæç¤º
8. è®¤è¯æˆåŠŸåå¤„ç†ä¸šåŠ¡é€»è¾‘

**ç¼“å­˜ä¼˜åŒ–**ï¼š
- KeyCacheï¼ˆSignalingï¼‰ï¼šSQLite æŒä¹…åŒ–ç¼“å­˜ï¼ˆæ”¯æŒå¤šç‰ˆæœ¬å¯†é’¥ï¼‰
- ç¼“å­˜åŒ…å«ï¼š`secret_key`ã€`expires_at`ã€`tolerance_seconds`
- ç¼“å­˜å‘½ä¸­ç‡ > 95%

**å®¹å¿æœŸæœºåˆ¶**ï¼š
- KS è¿”å›çœŸå®çš„ `expires_at`ï¼ˆä¸å†åŒ…å«å®¹å¿æœŸï¼‰
- KS åŒæ—¶è¿”å› `tolerance_seconds`ï¼ˆé»˜è®¤ 3600 ç§’ï¼‰
- Signaling æ ¹æ® `expires_at` å’Œ `tolerance_seconds` è‡ªè¡Œåˆ¤æ–­æ˜¯å¦åœ¨å®¹å¿æœŸ
- å®¹å¿æœŸå†…çš„å¯†é’¥å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œä½†ä¼šæç¤ºå®¢æˆ·ç«¯æ›´æ–°å‡­è¯
- è¶…è¿‡å®¹å¿æœŸçš„å¯†é’¥å°†è¢«æ‹’ç»

**å®¹å¿æœŸåˆ¤æ–­é€»è¾‘**ï¼š
```rust
// expires_at: å¯†é’¥è¿‡æœŸæ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
// tolerance_seconds: å®¹å¿æœŸæ—¶é•¿ï¼ˆç§’ï¼‰
// now: å½“å‰æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰

let in_tolerance_period = if expires_at > 0 {
    // åœ¨å®¹å¿æœŸå†…ï¼šå·²è¿‡æœŸä½†æœªè¶…è¿‡å®¹å¿æœŸ
    expires_at < now && now <= expires_at + tolerance_seconds
} else {
    false // æ°¸ä¸è¿‡æœŸçš„å¯†é’¥ä¸åœ¨å®¹å¿æœŸ
};
```

**å…³é”®ä»£ç ä½ç½®**ï¼š
- `actrix/crates/common/src/aid/credential/validator.rs` (å®¹å¿æœŸåˆ¤æ–­)
- `actrix/crates/common/src/aid/key_cache.rs` (SQLite ç¼“å­˜)
- `actrix/crates/signaling/src/authenticator.rs` (è®¤è¯æµç¨‹)

ğŸ‘‰ **è¯¦ç»†æ–‡æ¡£**ï¼š[5.2-authentication-flow.md](./5.2-authentication-flow.md)

---

### 5.3.3 TURN è®¤è¯

**ç›®çš„**ï¼šé€šè¿‡ TURN åè®®å»ºç«‹åª’ä½“ä¸­ç»§è¿æ¥

**å…³é”®æ­¥éª¤**ï¼š
1. actr æ„é€  TURN usernameï¼ˆJSON æ ¼å¼çš„ Claimsï¼‰
   - `tenant_id`ï¼šç§Ÿæˆ· ID
   - `key_id`ï¼šåŠ å¯†å¯†é’¥ ID
   - `encrypted_token`ï¼šåŠ å¯†çš„ Tokenï¼ˆåŒ…å« PSKï¼‰
2. actr å‘é€ TURN Allocate Request
3. TURN æœåŠ¡å™¨æ£€æŸ¥ LRU ç¼“å­˜ï¼ˆå®¹é‡ 4096ï¼‰
4. ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼Œè§£å¯† Token è·å– PSK
5. è®¡ç®—è®¤è¯å¯†é’¥ï¼š`MD5(username:realm:psk)`
6. ç¼“å­˜è®¤è¯å¯†é’¥ä¾›åç»­ä½¿ç”¨
7. éªŒè¯ç§Ÿæˆ·çŠ¶æ€ï¼Œåˆ†é…ä¸­ç»§åœ°å€

**ç¼“å­˜ä¼˜åŒ–**ï¼š
- LRU Cacheï¼ˆTURNï¼‰ï¼š4096 æ¡ç›®
- ç¼“å­˜å‘½ä¸­ç‡ > 90%
- æ€§èƒ½æå‡ 9.6 å€

**å…³é”®ä»£ç ä½ç½®**ï¼š
- `actrix/crates/turn/src/authenticator.rs`
- `actr/crates/protocol/src/turn.rs`

ğŸ‘‰ **è¯¦ç»†æ–‡æ¡£**ï¼š[5.3-turn-authentication.md](./5.3-turn-authentication.md)

---

### 5.3.4 å‡­è¯æ›´æ–°

**ç›®çš„**ï¼šåœ¨å‡­è¯è¿‡æœŸå‰æ— ç¼ç»­æœŸï¼Œä¿æŒèº«ä»½è¿ç»­æ€§

**å…³é”®æ­¥éª¤**ï¼š
1. actr ç›‘æµ‹å‡­è¯å³å°†è¿‡æœŸï¼ˆé»˜è®¤æå‰ 5 åˆ†é’Ÿï¼‰
2. actr å‘é€ `CredentialUpdateRequest`ï¼ˆæºå¸¦æ—§å‡­è¯ï¼‰
3. Signaling éªŒè¯æ—§å‡­è¯çš„æœ‰æ•ˆæ€§
4. Signaling å‘ AIS è¯·æ±‚æ–°å‡­è¯
5. AIS æŸ¥è¯¢ actr_id çš„ç°æœ‰ä¿¡æ¯ï¼ˆéªŒè¯ä¸€è‡´æ€§ï¼‰
6. AIS è·å–å½“å‰å…¬é’¥ï¼ˆå¯èƒ½å·²è½®æ¢ï¼‰
7. AIS ç­¾å‘æ–°å‡­è¯ï¼ˆ**ä¿æŒ actr_id å’Œ PSK ä¸å˜**ï¼‰
8. è¿”å›æ–° credential å’Œ expires_at

**è¿ç»­æ€§ä¿è¯**ï¼š

| å­—æ®µ | æ³¨å†Œæ—¶ | ç»­æœŸå | è¯´æ˜ |
|------|--------|--------|------|
| actr_id | ç”Ÿæˆ | **ä¸å˜** âœ… | èº«ä»½è¿ç»­æ€§ |
| psk | ç”Ÿæˆ | **ä¸å˜** âœ… | åŠ å¯†å¯†é’¥ä¸€è‡´ |
| key_id | å½“å‰å¯†é’¥ | **å¯èƒ½å˜** | å¯†é’¥è½®æ¢æ—¶æ›´æ–° |
| expires_at | T+1h | **å»¶é•¿** | ç»­æœŸç›®çš„ |

**å…³é”®ä»£ç ä½ç½®**ï¼š
- `actrix/crates/signaling/src/credential_verifier.rs`
- `actrix/crates/ais/src/issuer.rs`

ğŸ‘‰ **è¯¦ç»†æ–‡æ¡£**ï¼š[5.4-credential-update.md](./5.4-credential-update.md)

---

### 5.3.5 å¯†é’¥è½®æ¢

**ç›®çš„**ï¼šå®šæœŸæ›´æ¢åŠ å¯†å¯†é’¥ï¼Œé™ä½å¯†é’¥æ³„éœ²é£é™©

**å…³é”®æ­¥éª¤**ï¼š
1. AIS åå°ä»»åŠ¡æ¯ 10 åˆ†é’Ÿæ£€æŸ¥å¯†é’¥çŠ¶æ€
2. æ£€æµ‹åˆ°å¯†é’¥å°†åœ¨ 10 åˆ†é’Ÿå†…è¿‡æœŸ
3. AIS å‘ KS å‘èµ· `GenerateKeyRequest`
4. KS ç”Ÿæˆæ–° ECC å¯†é’¥å¯¹ï¼ˆsecp256k1ï¼‰
5. KS å­˜å‚¨å¯†é’¥åˆ° SQLite æ•°æ®åº“
6. KS è¿”å› `key_id` + `public_key` + `expires_at`
7. AIS æ›´æ–° CurrentKeyCache
8. æ—§å¯†é’¥è¿›å…¥å®¹å¿æœŸï¼ˆé»˜è®¤ 1 å°æ—¶ï¼‰

**æ—¶é—´çº¿ç¤ºä¾‹**ï¼š

```
T0: ç”Ÿæˆ key_id=5, expires_at=T0+24h
â”œâ”€ T0+23h50m: AIS æ£€æµ‹åˆ°å³å°†è¿‡æœŸ
â”‚  â””â”€ è§¦å‘ç”Ÿæˆ key_id=6
â”‚  â””â”€ AIS åˆ‡æ¢åˆ°ä½¿ç”¨ key_id=6
â”‚
â”œâ”€ T0+24h: key_id=5 è¿‡æœŸï¼Œè¿›å…¥å®¹å¿æœŸ
â”‚  â””â”€ æ—§å‡­è¯ä»å¯éªŒè¯ âœ…
â”‚
â””â”€ T0+25h: å®¹å¿æœŸç»“æŸ
   â””â”€ key_id=5 å®Œå…¨å¤±æ•ˆ
```

**å®¹å¿æœŸä½œç”¨**ï¼š
- ä¿æŠ¤å·²ç­¾å‘çš„å‡­è¯
- å®¹é”™ç¼“å†²ï¼ˆæ—¶é’Ÿåå·®ã€ç¼“å­˜ä¼ æ’­å»¶è¿Ÿï¼‰
- å¹³æ»‘è¿‡æ¸¡ï¼ˆé›¶ä¸­æ–­è½®æ¢ï¼‰

**å…³é”®ä»£ç ä½ç½®**ï¼š
- `actrix/crates/ais/src/storage.rs` (è½®æ¢æ£€æµ‹)
- `actrix/crates/ks/src/handlers.rs` (å¯†é’¥ç”Ÿæˆ)

ğŸ‘‰ **è¯¦ç»†æ–‡æ¡£**ï¼š[5.5-key-rotation.md](./5.5-key-rotation.md)