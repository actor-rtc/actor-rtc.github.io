# 4.6 actr-runtimeï¼šè¿è¡Œæ—¶æ¶æ„

> **ç›¸å…³æ–‡æ¡£**:
> - [3.6 The Persistent Mailbox](3.6-the-persistent-mailbox.zh.md) - Mailbox å®ç°ç»†èŠ‚
> - [3.7 State Path Scheduling](3.7-state-path-scheduling.zh.md) - Scheduler æœºåˆ¶
> - [Lane é€‰æ‹©ç­–ç•¥](appendix-lane-selection-strategy.zh.md) - Lane è·¯ç”±ç­–ç•¥

---

## æ ¸å¿ƒç†å¿µ

**One Actor Per Process** - æ¯ä¸ªè¿›ç¨‹å°±æ˜¯ä¸€ä¸ª Actorï¼Œé€šè¿‡ WebRTC P2P æˆ– WebSocket ä¸å…¶ä»– Actor é€šä¿¡ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **åˆ†å±‚æ¸…æ™°** - ä»£ç ç»„ç»‡ä¸¥æ ¼éµå¾ªæ¶æ„åˆ†å±‚ï¼Œæ¯å±‚èŒè´£æ˜ç¡®
2. **é›¶æˆæœ¬æŠ½è±¡** - ç¼–è¯‘æ—¶é™æ€åˆ†å‘ï¼Œæ— è¿è¡Œæ—¶å¼€é”€
3. **äº‹ä»¶é©±åŠ¨** - é›¶è½®è¯¢ï¼ŒåŸºäº tokio watch channel
4. **åå­—å‡†ç¡®** - å¦‚æœèŒè´£å˜æ›´ï¼Œåå­—å¿…é¡»éšä¹‹æ›´æ–°

---

## ç›®å½•ç»“æ„

actr-runtime ä»£ç ç»„ç»‡ä¸¥æ ¼éµå¾ªæ¶æ„åˆ†å±‚ï¼Œä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼š

```
src/
â”œâ”€â”€ lifecycle/          # ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆéæ¶æ„å±‚æ¬¡ï¼‰
â”‚   â”œâ”€â”€ actor_system.rs # ActrSystem: ç³»ç»Ÿåˆå§‹åŒ–å’Œé…ç½®
â”‚   â”œâ”€â”€ actor_node.rs   # ActrNode<W>: æ³›å‹èŠ‚ç‚¹ï¼Œç»‘å®š Workload
â”‚   â””â”€â”€ actr_ref.rs # ActrRef: Actor å¼•ç”¨å¥æŸ„
â”‚
â”œâ”€â”€ wire/               # Layer 0: çº¿è·¯å±‚ï¼ˆç‰©ç†ä¼ è¾“ï¼‰
â”‚   â”œâ”€â”€ webrtc/         # WebRTC å­ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ connection.rs     # WebRtcConnection: DataChannel/MediaTrack
â”‚   â”‚   â”œâ”€â”€ coordinator.rs    # WebRtcCoordinator: ä¿¡ä»¤åè°ƒ
â”‚   â”‚   â”œâ”€â”€ gate.rs           # WebRtcGate: æœ¬åœ°å¥æŸ„
â”‚   â”‚   â”œâ”€â”€ negotiator.rs     # WebRtcNegotiator: SDP åå•†
â”‚   â”‚   â”œâ”€â”€ signaling.rs      # SignalingClient: WebSocket ä¿¡ä»¤
â”‚   â”‚   â””â”€â”€ handler.rs        # SignalingHandler: ä¿¡ä»¤äº‹ä»¶å¤„ç†
â”‚   â””â”€â”€ websocket/      # WebSocket å­ç³»ç»Ÿ
â”‚       â”œâ”€â”€ mod.rs
â”‚       â””â”€â”€ connection.rs     # WebSocketConnection: TCP ä¼ è¾“
â”‚
â”œâ”€â”€ transport/          # Layer 1: ä¼ è¾“å±‚ï¼ˆLane æŠ½è±¡ï¼‰
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ lane.rs         # â­ Lane æ ¸å¿ƒæŠ½è±¡ï¼ˆåŒå‘é€šé“ï¼‰
â”‚   â”œâ”€â”€ route_table.rs  # PayloadType â†’ LaneType é™æ€è·¯ç”±
â”‚   â”œâ”€â”€ inproc_manager.rs      # InprocTransportManager: Workload â†” Shell é€šä¿¡ç®¡ç†
â”‚   â”œâ”€â”€ manager.rs             # OutprocTransportManager + WireBuilder trait
â”‚   â”œâ”€â”€ dest_transport.rs      # å•ç›®æ ‡ä¼ è¾“æ§åˆ¶
â”‚   â”œâ”€â”€ dest.rs                # ç›®æ ‡åœ°å€æŠ½è±¡
â”‚   â”œâ”€â”€ wire_pool.rs           # Wire è¿æ¥æ± ç®¡ç†å’Œé‡è¯•ç­–ç•¥
â”‚   â”œâ”€â”€ wire_builder.rs        # Wire å±‚ç»„ä»¶æ„å»ºå™¨
â”‚   â”œâ”€â”€ wire_handle.rs         # WireHandle enum (WebRTC | WebSocket å¥æŸ„)
â”‚   â””â”€â”€ error.rs               # ä¼ è¾“å±‚é”™è¯¯ç±»å‹
â”‚
â”œâ”€â”€ outbound/           # Layer 2: å‡ºç«™é—¨æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ mod.rs          # OutGate enum (InprocOut | OutprocOut)
â”‚   â”œâ”€â”€ inproc_out_gate.rs   # è¿›ç¨‹å†…å‡ºç«™é€‚é…å™¨
â”‚   â””â”€â”€ outproc_out_gate.rs  # è·¨è¿›ç¨‹å‡ºç«™é€‚é…å™¨
â”‚
â”œâ”€â”€ inbound/            # Layer 3: å…¥ç«™æ´¾å‘å±‚
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ inbound_packet_dispatcher.rs  # æ ¸å¿ƒæ´¾å‘å™¨
â”‚   â”œâ”€â”€ stream_chunk_registry.rs       # LatencyFirst å›è°ƒæ³¨å†Œ
â”‚   â””â”€â”€ media_frame_registry.rs       # MediaTrack å›è°ƒæ³¨å†Œ
â”‚
â”œâ”€â”€ context_factory.rs  # Context å·¥å‚
â”œâ”€â”€ resource.rs         # èµ„æºç®¡ç†
â”œâ”€â”€ monitoring.rs       # ç›‘æ§æŒ‡æ ‡
â””â”€â”€ error.rs            # è¿è¡Œæ—¶é”™è¯¯ç±»å‹
```

**åˆ†å±‚åŸåˆ™**ï¼š
- **wire/** å±‚å®ç°ç‰©ç†ä¼ è¾“ï¼Œå¯è®¿é—® **transport/** çš„å…¬å…± APIï¼ˆå¦‚ Lane, NetworkErrorï¼‰
- **transport/** å±‚æä¾› Lane æŠ½è±¡ï¼Œå¯è®¿é—® **wire/** çš„å®ç°ï¼ˆå¦‚ WebRtcConnectionï¼‰
- **outbound/** å±‚è´Ÿè´£å‡ºç«™æ¶ˆæ¯å‘é€ï¼Œè°ƒç”¨ **transport/** çš„ç®¡ç†æ¥å£
- **inbound/** å±‚è´Ÿè´£å…¥ç«™æ¶ˆæ¯æ´¾å‘ï¼Œä» **transport/Lane** è¯»å–æ•°æ®
- **lifecycle/** å±‚åè°ƒæ‰€æœ‰å±‚çš„åˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## æ¶æ„åˆ†å±‚ï¼ˆè‡ªåº•å‘ä¸Šï¼‰

```mermaid
graph TB
    subgraph L4["Layer 4: Application ä¸šåŠ¡å±‚"]
        WH["Workload Handlers<br/>ç”¨æˆ·ä¸šåŠ¡é€»è¾‘"]
    end

    subgraph L3["Layer 3: Inbound å…¥ç«™æ´¾å‘å±‚"]
        MR["InboundPacketDispatcher"]
        MB["Mailbox"]
        DSR["StreamChunkRegistry"]
        MFR["MediaFrameRegistry"]

        MR -->|Signal/Reliable| MB
        MR -->|LatencyFirst| DSR
        MR -->|MediaTrack| MFR
    end

    subgraph L2["Layer 2: Outbound å‡ºç«™é—¨æŠ½è±¡å±‚"]
        OG["OutGate<br/>ç»Ÿä¸€å‡ºç«™æ¥å£"]
    end

    subgraph L1["Layer 1: Transport ä¼ è¾“å±‚"]
        TM["TransportManager<br/>ä¼ è¾“ç®¡ç†"]

        LANE["Lane ç»Ÿä¸€æŠ½è±¡<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>å±è”½åº•å±‚å·®å¼‚<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>â€¢ send(data) - å‡ºç«™å†™å…¥<br/>â€¢ recv() - å…¥ç«™è¯»å–<br/>â€¢ éšå« PayloadType"]
    end

    subgraph L0["Layer 0: Wire çº¿è·¯å±‚"]
        direction LR
        MPSC["Mpsc<br/>è¿›ç¨‹å†…é€šé“"]
        DC["WebRTC<br/>DataChannel"]
        MT["WebRTC<br/>MediaTrack"]
        WS["WebSocket<br/>TCP è¿æ¥"]
    end

    %% å‡ºç«™æµå‘ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
    WH -->|send| OG
    OG -->|è°ƒç”¨| TM
    TM -->|è·å–| LANE
    LANE -->|å†™å…¥| L0

    %% å…¥ç«™æµå‘ï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰
    L0 -->|å¡«å……æ•°æ®| LANE
    LANE -->|è¯»å–| MR
    MB -->|è°ƒåº¦| WH
    DSR -->|å›è°ƒ| WH
    MFR -->|å›è°ƒ| WH

    classDef app fill:#fff4e6,stroke:#ff9800,stroke-width:3px
    classDef router fill:#fff8e1,stroke:#ffc107,stroke-width:2px
    classDef gate fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef transport fill:#e8f5e9,stroke:#4caf50,stroke-width:3px
    classDef lane fill:#c8e6c9,stroke:#4caf50,stroke-width:4px
    classDef wire fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px

    class WH app
    class MR,MB,DSR,MFR router
    class OG gate
    class TM transport
    class LANE lane
    class MPSC,DC,MT,WS wire
```

**å›¾ä¾‹è¯´æ˜**ï¼š
- ğŸŸ  Application å±‚ï¼ˆæ©™è‰²ï¼‰ï¼šä¸šåŠ¡é€»è¾‘å±‚ï¼Œç”¨æˆ·ä»£ç 
- ğŸŸ¡ Inbound å±‚ï¼ˆé»„è‰²ï¼‰ï¼šå…¥ç«™æ¶ˆæ¯è·¯ç”±å’Œæ´¾å‘
- ğŸ”µ Outbound å±‚ï¼ˆè“è‰²ï¼‰ï¼šå‡ºç«™ç»Ÿä¸€æ¥å£
- ğŸŸ¢ Transport å±‚ï¼ˆç»¿è‰²ï¼‰ï¼šä¼ è¾“ç®¡ç†å’Œè¿æ¥æ§åˆ¶
- **ğŸŸ¢ Lane å±‚ï¼ˆæ·±ç»¿åŠ ç²—ï¼‰**ï¼š**æ ¸å¿ƒæŠ½è±¡å±‚ï¼Œå±è”½æ‰€æœ‰åº•å±‚å·®å¼‚**
- âšª Wire å±‚ï¼ˆç°è‰²ï¼‰ï¼šè·¨è¿›ç¨‹åº•å±‚çº¿è·¯å®ç°ï¼ˆWebRTC/WebSocketï¼‰

**å…³é”®è®¾è®¡**ï¼š
- **Lane æ˜¯ç»Ÿä¸€æŠ½è±¡**ï¼šä¸Šå±‚åªä¸ Lane äº¤äº’ï¼Œä¸å…³å¿ƒåº•å±‚æ˜¯ Mpscã€WebRTC è¿˜æ˜¯ WebSocket
- **å‡ºç«™æµå‘**ï¼š
  - Inproc: Application â†’ Outbound â†’ Transport â†’ Lane::Mpsc â†’ tokio mpsc
  - Outproc: Application â†’ Outbound â†’ Transport â†’ Lane â†’ Wire
- **å…¥ç«™æµå‘**ï¼š
  - Inproc: tokio mpsc â†’ Lane::Mpsc â†’ Inbound â†’ Application
  - Outproc: Wire â†’ Lane â†’ Inbound â†’ Application
- **PayloadType éšå«åœ¨ Lane ä¸­**ï¼šæ¯ä¸ª Lane å®ä¾‹å¯¹åº”ä¸€ç§ PayloadTypeï¼Œä¸Šå±‚é€šè¿‡ Lane ç»Ÿä¸€è¯»å†™

---

## æ ¸å¿ƒæ¨¡å—èŒè´£

### Layer 0: Wireï¼ˆçº¿è·¯å±‚ï¼‰

**èŒè´£**ï¼šæä¾›è·¨è¿›ç¨‹åº•å±‚ç‰©ç†ä¼ è¾“å®ç°

**æ³¨æ„**ï¼šè¿›ç¨‹å†…é€šä¿¡ï¼ˆInprocï¼‰ä¸ä½¿ç”¨ Wire å±‚ï¼Œç›´æ¥åœ¨ Transport å±‚ä½¿ç”¨ `tokio::sync::mpsc`

| æ¨¡å— | æ–‡ä»¶ä½ç½® | èŒè´£ |
|------|---------|------|
| WebRtcConnection | `wire/webrtc/connection.rs` | WebRTC DataChannel å’Œ MediaTrack å°è£… |
| WebRtcCoordinator | `wire/webrtc/coordinator.rs` | ä¿¡ä»¤åè°ƒï¼Œç®¡ç†å¤šä¸ª Peer è¿æ¥ |
| WebRtcNegotiator | `wire/webrtc/negotiator.rs` | SDP åå•†å’Œ ICE candidate å¤„ç† |
| SignalingClient | `wire/webrtc/signaling.rs` | WebSocket ä¿¡ä»¤å®¢æˆ·ç«¯ |
| WebSocketConnection | `wire/websocket/connection.rs` | WebSocket TCP è¿æ¥å°è£… |

### Layer 1: Transportï¼ˆä¼ è¾“å±‚ï¼‰

**èŒè´£**ï¼šæä¾› Lane æŠ½è±¡å’Œä¼ è¾“ç®¡ç†

| æ¨¡å— | æ–‡ä»¶ä½ç½® | èŒè´£ |
|------|---------|------|
| **Lane** | `transport/lane.rs` | **æ ¸å¿ƒæŠ½è±¡ï¼šPayloadType çš„ç‰©ç†ä½“ç°ï¼ŒåŒå‘é€šé“**<br/>â€¢ `send(Bytes)` / `send_envelope(RpcEnvelope)` - å‡ºç«™å†™å…¥<br/>â€¢ `recv()` / `recv_envelope()` - å…¥ç«™è¯»å–<br/>â€¢ ç±»å‹ï¼šMpsc, WebRtcDataChannel, WebRtcMediaTrack, WebSocket |
| **InprocTransportManager** | `transport/inproc_manager.rs` | **Workload â†” Shell é€šä¿¡ç®¡ç†å™¨**<br/>â€¢ Reliable å¿…é¡»åˆ›å»º<br/>â€¢ HashMap åŠ¨æ€ç®¡ç†å…¶ä»–é€šé“<br/>â€¢ ç»Ÿä¸€ APIï¼šget_lane, send_request, recv |
| PayloadTypeExt | `transport/route_table.rs` | PayloadType â†’ LaneType é™æ€è·¯ç”±è¡¨ |
| OutprocTransportManager | `transport/manager.rs` | è·¨è¿›ç¨‹ä¼ è¾“ç®¡ç†ï¼Œå»¶è¿Ÿåˆ›å»º DestTransport |
| DestTransport | `transport/dest_transport.rs` | å•ç›®æ ‡ä¼ è¾“æ§åˆ¶ï¼Œäº‹ä»¶é©±åŠ¨å‘é€ |
| WirePool | `transport/wire_pool.rs` | Wire è¿æ¥æ± ç®¡ç†å™¨ï¼ˆç­–ç•¥å±‚ï¼‰<br/>â€¢ é¥±å’Œå¼å¹¶å‘è¿æ¥<br/>â€¢ è‡ªåŠ¨é‡è¯•å’Œé™çº§<br/>â€¢ watch channel å°±ç»ªé€šçŸ¥ |
| WireHandle | `transport/wire_handle.rs` | Wire å±‚ç»„ä»¶ç»Ÿä¸€å¥æŸ„ï¼ˆenum dispatchï¼‰<br/>â€¢ WebRTC/WebSocket é€‚é…å™¨ |
| WireBuilder | `transport/wire_builder.rs` | Wire å±‚ç»„ä»¶æ„å»ºå™¨<br/>â€¢ åˆ›å»ºå’Œé…ç½® Wire ç»„ä»¶ |
| Dest | `transport/dest.rs` | ç›®æ ‡åœ°å€æŠ½è±¡ï¼ˆActrId + URIï¼‰ |

**PayloadType è·¯ç”±ç­–ç•¥**ï¼š

| ä¼ è¾“ç±»å‹ | Lane ç±»å‹ | PayloadType è·¯ç”±æ–¹å¼ |
|---------|----------|-------------------|
| **Inproc (mpsc)** | **Lane::Mpsc** | æ¯ä¸ª PayloadType ä¸€ä¸ª mpsc channelï¼Œ**ç›´æ¥ä¼ é€’ RpcEnvelope å¯¹è±¡ï¼ˆé›¶åºåˆ—åŒ–ï¼‰** |
| **WebRTC DataChannel** | **Lane::WebRtcDataChannel** | æ¯ä¸ª PayloadType ç‹¬ç«‹ DataChannelï¼ŒQoS é…ç½®éšå«ç±»å‹ |
| **WebRTC MediaTrack** | **Lane::WebRtcMediaTrack** | æ”¯æŒå¤šå®ä¾‹ï¼ŒHashMap æŒ‰ stream_id ç´¢å¼• |
| **WebSocket** | **Lane::WebSocket** | å¤šä¸ª Lane å…±äº«ç‰©ç†è¿æ¥ï¼Œæ¶ˆæ¯å¤´ `[1 byte type][4 bytes len][data]` |

**è¿æ¥å­˜å‚¨ç»“æ„**ï¼š

| è¿æ¥ç±»å‹ | å­˜å‚¨ç»“æ„ | è¯´æ˜ |
|---------|---------|------|
| **InprocTransportManager** | â€¢ RPC_RELIABLE: `mpsc::Sender/Receiver<RpcEnvelope>`ï¼ˆå¿…é¡»ï¼‰<br/>â€¢ RPC_SIGNAL: `Option<ChannelPair>`ï¼ˆå»¶è¿Ÿåˆ›å»ºï¼‰<br/>â€¢ STREAM_RELIABLE/STREAM_LATENCY_FIRST: `HashMap<channel_id, ChannelPair>`ï¼ˆåŠ¨æ€ï¼‰<br/>â€¢ MEDIA_RTP: `HashMap<track_id, ChannelPair>`ï¼ˆTODOï¼‰ | **ç›´æ¥ä¼ é€’å¯¹è±¡ï¼Œé›¶åºåˆ—åŒ–**<br/>æ”¯æŒå¤šå®ä¾‹ Fast Path é€šé“ |
| **WebSocketConnection** | `[Option<mpsc::Sender<Bytes>>; 5]` è·¯ç”±è¡¨<br/>`[Option<Lane>; 5]` ç¼“å­˜ | 5 ä¸ª PayloadType å…±äº«ç‰©ç†è¿æ¥ï¼Œrouter è·¯ç”±ï¼Œlane_cache ç¼“å­˜ |
| **WebRtcConnection** | `[Option<Arc<RTCDataChannel>>; 4]` + `HashMap<String, Arc<Track>>` | 4 ç§ DataChannelï¼ˆRPC_RELIABLE, RPC_SIGNAL, STREAM_RELIABLE, STREAM_LATENCY_FIRSTï¼‰ï¼ŒMEDIA_RTP å¤šå®ä¾‹ï¼ˆHashMap æŒ‰ stream_id ç´¢å¼•ï¼‰ |

**æ•°ç»„ç´¢å¼•æ˜ å°„**ï¼š
- PayloadType æšä¸¾å€¼ç›´æ¥å¯¹åº”æ•°ç»„ç´¢å¼•ï¼š
  - RPC_RELIABLE(0) â†’ `[0]`, RPC_SIGNAL(1) â†’ `[1]`
  - STREAM_RELIABLE(2) â†’ `[2]`, STREAM_LATENCY_FIRST(3) â†’ `[3]`
  - MEDIA_RTP(4) â†’ `[4]` (WebSocket) æˆ– HashMap (WebRTC MediaTrack)
- æ— éœ€é¢å¤–æ˜ å°„é€»è¾‘ï¼ŒO(1) è®¿é—®æ€§èƒ½

### Layer 2: Outboundï¼ˆå‡ºç«™é—¨æŠ½è±¡å±‚ï¼‰

**èŒè´£**ï¼šæä¾›ç»Ÿä¸€çš„å‡ºç«™æ¶ˆæ¯å‘é€æ¥å£

| æ¨¡å— | æ–‡ä»¶ä½ç½® | èŒè´£ |
|------|---------|------|
| OutGate enum | `outbound/mod.rs` | ç»Ÿä¸€å‡ºç«™æ¥å£ï¼ˆenum dispatchï¼‰<br/>â€¢ InprocOut: è¿›ç¨‹å†…å‡ºç«™<br/>â€¢ OutprocOut: è·¨è¿›ç¨‹å‡ºç«™ |
| InprocOutGate | `outbound/inproc_out_gate.rs` | è¿›ç¨‹å†…å‡ºç«™é€‚é…å™¨ï¼Œç›´æ¥ä¼ é€’ RpcEnvelope |
| OutprocOutGate | `outbound/outproc_out_gate.rs` | è·¨è¿›ç¨‹å‡ºç«™é€‚é…å™¨ï¼Œåºåˆ—åŒ– + ç»´æŠ¤ pending_requests |

### Layer 3: Inboundï¼ˆå…¥ç«™æ´¾å‘å±‚ï¼‰

**èŒè´£**ï¼šæŒ‰ PayloadType è·¯ç”±å…¥ç«™æ¶ˆæ¯

| æ¨¡å— | æ–‡ä»¶ä½ç½® | èŒè´£ |
|------|---------|------|
| InboundPacketDispatcher | `inbound/inbound_packet_dispatcher.rs` | æ ¸å¿ƒæ´¾å‘å™¨ï¼ŒæŒ‰ PayloadType åˆ†å‘æ¶ˆæ¯ |
| StreamChunkRegistry | `inbound/stream_chunk_registry.rs` | LatencyFirst ç±»å‹æ¶ˆæ¯çš„å›è°ƒæ³¨å†Œ |
| MediaFrameRegistry | `inbound/media_frame_registry.rs` | MediaTrack ç±»å‹æ¶ˆæ¯çš„å›è°ƒæ³¨å†Œ |
| Mailbox | `actr-mailbox` crate | SQLite æŒä¹…åŒ–é˜Ÿåˆ—ï¼ˆSignal/Reliableï¼‰ |

### ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆéæ¶æ„å±‚æ¬¡ï¼‰

**èŒè´£**ï¼šç®¡ç† Actor ç³»ç»Ÿçš„å¯åŠ¨å’Œè¿è¡Œ

| æ¨¡å— | æ–‡ä»¶ä½ç½® | èŒè´£ |
|------|---------|------|
| ActrSystem | `lifecycle/actor_system.rs` | ç³»ç»Ÿåˆå§‹åŒ–å’Œé…ç½®ï¼ˆæ— æ³›å‹ï¼‰ |
| ActrNode | `lifecycle/actor_node.rs` | æ³›å‹èŠ‚ç‚¹ï¼Œç»‘å®š Workload ç±»å‹ |
| ActrRef | `lifecycle/actr_ref.rs` | Actor å¼•ç”¨å¥æŸ„ï¼Œå¯åŠ¨åå°å¾ªç¯ |

---

## ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è½¬æ¢

```mermaid
stateDiagram-v2
    [*] --> ActrSystem: new(config)

    ActrSystem --> ActrNode: attach(workload)<br/>æ¶ˆè´¹ selfï¼Œå¼•å…¥æ³›å‹

    ActrNode --> ActrRef: start()<br/>æ¶ˆè´¹ selfï¼Œå¯åŠ¨åå°å¾ªç¯

    state ActrRef {
        [*] --> InboundLoops

        state InboundLoops {
            InprocMgr: InprocTransportManager.recv().await
            WebRtcCoord: WebRtcCoordinator.start()
            WebSocketDisp: WebSocketConnection dispatcher

            InprocMgr --> InboundPacketDispatcher
            WebRtcCoord --> InboundPacketDispatcher
            WebSocketDisp --> InboundPacketDispatcher
        }

        InboundPacketDispatcher --> WorkloadHandlers
    }

    ActrRef --> [*]: shutdown()
```

**å…³é”®è®¾è®¡**ï¼š
- `ActrSystem` å¯é¢„åˆå§‹åŒ–ï¼ˆæ— æ³›å‹æ±¡æŸ“ï¼‰
- `attach()` è½¬æ¢çŠ¶æ€å¹¶å¼•å…¥æ³›å‹ï¼ˆå•æ€åŒ–ä¼˜åŒ–ï¼‰
- `start()` ç«‹å³è¿”å›ï¼Œäº‹ä»¶å¾ªç¯åœ¨åå°è¿è¡Œ
- ä¸‰ä¸ªå…¥ç«™å¾ªç¯å¹¶å‘è¿è¡Œï¼Œç»Ÿä¸€è·¯ç”±åˆ° `InboundPacketDispatcher`

---

## æ¶ˆæ¯æµå‘è¯¦è§£

### æ ¸å¿ƒç†å¿µ

**å…³é”®æ¶æ„å·®å¼‚ - Inproc vs Outproc**ï¼š

| ç»´åº¦ | Inprocï¼ˆè¿›ç¨‹å†…ï¼‰ | Outprocï¼ˆè·¨è¿›ç¨‹ï¼‰ |
|------|----------------|------------------|
| **å±‚æ¬¡ç»“æ„** | Layer 2 â†’ Layer 1 â†’ tokio mpsc | Layer 2 â†’ Layer 1 â†’ Layer 0 |
| **PayloadType** | 4 ç§ï¼ˆæ¯ä¸ª PayloadType ç‹¬ç«‹ channelï¼‰ | 4 ç§ï¼ˆé€šè¿‡ Lane è·¯ç”±ï¼‰ |
| **Lane æŠ½è±¡** | âœ… **Lane::Mpsc**ï¼ˆç»Ÿä¸€æŠ½è±¡ï¼‰ | âœ… **Lane::WebRTC/WebSocket**ï¼ˆç»Ÿä¸€æŠ½è±¡ï¼‰ |
| **Wire å±‚** | âŒ **æ—  Wire å±‚**ï¼Œç›´æ¥ä½¿ç”¨ tokio::sync::mpsc | âœ… WebRTC: 3 DataChannel + HashMap<MediaTrack><br/>WebSocket: 4 Senderï¼ˆå…±äº«ç‰©ç†è¿æ¥ï¼‰ |
| **åº•å±‚å®ç°** | tokio::sync::mpsc::Sender/Receiver | RTCDataChannel / WebSocket TCP |
| **è·¯ç”±é”®** | `(ActrId, PayloadType)` | `Dest` â†’ `PayloadType`ï¼ˆä¸¤å±‚è·¯ç”±ï¼‰ |
| **TransportManager** | InprocTransportManager | OutprocTransportManager |
| **InboundPacketDispatcher** | å¯é€‰ï¼ˆç›´æ¥è°ƒç”¨ Router æˆ–æ¥å…¥ Dispatcherï¼‰ | å¿…é¡»ä½¿ç”¨ï¼ˆæŒ‰ PayloadType è·¯ç”±ï¼‰ |
| **åºåˆ—åŒ–** | **é›¶åºåˆ—åŒ–ï¼ˆç›´æ¥ä¼ é€’ RpcEnvelope å¯¹è±¡ï¼‰** | Protobuf åºåˆ—åŒ–ï¼ˆbytesï¼‰ |
| **RPC å“åº”åŒ¹é…** | pending_requests HashMapï¼ˆç»Ÿä¸€æœºåˆ¶ï¼‰ | pending_requests HashMap |

**æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯å¼‚æ­¥çš„** - æœ¬æ¡†æ¶ä¸­**ä¸å­˜åœ¨ä¼ è¾“å±‚çš„åŒæ­¥ Request/Response åŒºåˆ†**ï¼Œåªæœ‰ 5 ç§ PayloadTypeï¼š

1. **RPC_RELIABLE (0)** - å¯é æœ‰åº RPCï¼Œè¿›å…¥ Mailboxï¼ˆ**é»˜è®¤å€¼**ï¼‰
2. **RPC_SIGNAL (1)** - é«˜ä¼˜å…ˆçº§ RPCï¼Œè¿›å…¥ Mailbox
3. **STREAM_RELIABLE (2)** - å¯é æœ‰åºæµå¼æ•°æ®ï¼Œè¿›å…¥ StreamChunkRegistryï¼ˆFast Pathï¼‰
4. **STREAM_LATENCY_FIRST (3)** - ä½å»¶è¿Ÿæµå¼æ•°æ®ï¼Œè¿›å…¥ StreamChunkRegistryï¼ˆFast Pathï¼‰
5. **MEDIA_RTP (4)** - åª’ä½“æµ RTPï¼Œè¿›å…¥ MediaFrameRegistryï¼ˆFast Pathï¼ŒTODOï¼‰

**RPC è¯­ä¹‰æ˜¯åº”ç”¨å±‚å®ç°**ï¼š
- å‘é€è¯·æ±‚æ—¶ï¼š`OutprocOutGate` ç”Ÿæˆ `request_id` å¹¶ä¿å­˜ `oneshot_tx` åˆ° `pending_requests`
- æ¥æ”¶å“åº”æ—¶ï¼šä» Mailbox å–å‡ºæ¶ˆæ¯ï¼Œæ£€æŸ¥ `request_id`ï¼Œå¦‚æœåŒ¹é…åˆ™å”¤é†’å¯¹åº”çš„ `oneshot_tx`
- è¿™ä¸ªåŒ¹é…è¿‡ç¨‹å‘ç”Ÿåœ¨**åº”ç”¨å±‚ Workload å¤„ç†é˜¶æ®µ**ï¼Œè€Œéä¼ è¾“å±‚

### å‡ºç«™æµå‘ï¼ˆOutbound Pathï¼‰

**å‡ºç«™æµå‘å®Œå…¨ä¸ç»è¿‡ InboundPacketDispatcherï¼Œç›´æ¥ä» OutGate åˆ° Transport**ã€‚

#### Inproc å‡ºç«™ï¼ˆè¿›ç¨‹å†…ï¼‰

**æ³¨æ„**: Inproc è·¯å¾„**ç»è¿‡å®Œæ•´ 3 å±‚æ¶æ„**ï¼ˆLayer 2 â†’ Layer 1 â†’ Layer 0ï¼‰ã€‚
**é›¶åºåˆ—åŒ–**ï¼šç›´æ¥ä¼ é€’ RpcEnvelope å¯¹è±¡ï¼Œæ— éœ€ protobuf ç¼–è§£ç ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application Layer                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   Workload é€šè¿‡ Context å‘é€æ¶ˆæ¯
      â†“
   ctx.call(target, request)  æˆ–  ctx.tell(target, message)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: Outbound                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   OutGate::InprocOut(Arc<InprocTransportManager>)
      â†“
   InprocTransportManager.send_request(payload_type, identifier, envelope)
      â”œâ”€ pending_requests.insert(request_id, response_tx)
      â””â”€ ğŸ”¹ é»˜è®¤ payload_type = PayloadType::Reliable
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Transport (InprocTransportManager)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   InprocTransportManager.get_lane(payload_type, identifier)
      â”œâ”€ ç¼“å­˜æ£€æŸ¥ï¼šlane_cache.get((payload_type, identifier))
      â”œâ”€ å¦‚æœªç¼“å­˜ï¼šè·å–å¯¹åº” ChannelPair
      â”‚  â€¢ Reliable: å¿…é¡»å­˜åœ¨
      â”‚  â€¢ Signal: å»¶è¿Ÿåˆ›å»º
      â”‚  â€¢ LatencyFirst: ä» HashMap<channel_id> è·å–
      â”‚  â€¢ MediaTrack: ä» HashMap<track_id> è·å–
      â””â”€ è¿”å› Lane::Mpsc
      â†“
   Lane.send_envelope(envelope)  â† **ç›´æ¥ä¼ é€’ RpcEnvelope å¯¹è±¡**
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº•å±‚: tokio::sync::mpsc (æ—  Wire å±‚)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   mpsc::Sender<RpcEnvelope>.send(envelope)
      â†“
   **é›¶åºåˆ—åŒ–ï¼šç›´æ¥ä¼ é€’å¯¹è±¡**
      â†“
   å¯¹ç«¯ InprocTransportManager.recv() â†’ RpcEnvelope
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Outproc å‡ºç«™ï¼ˆè·¨è¿›ç¨‹ï¼‰

**æ³¨æ„**: Outproc è·¯å¾„**ç»è¿‡å®Œæ•´ 3 å±‚æ¶æ„**ï¼ˆLayer 2 â†’ Layer 1 â†’ Layer 0ï¼‰ã€‚
**ä½¿ç”¨ PayloadType è·¯ç”±**ï¼Œé»˜è®¤ RPC ä½¿ç”¨ `PayloadType::Reliable`ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application Layer                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   Workload è°ƒç”¨
      â†“
   ctx.call(target, request)  æˆ–  ctx.tell(target, message)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: Outbound                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   OutGate::OutprocOut(OutprocOutGate)
      â†“
   OutprocOutGate.send_request(target, envelope)
      â”œâ”€ pending_requests.insert(request_id, oneshot_tx)
      â”œâ”€ envelope.encode_to_vec() â†’ bytes
      â””â”€ transport_manager.send(dest, PayloadType::Reliable, bytes)
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Transport                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   TransportManager.send(dest, payload_type, data)
      â†“
   get_or_create_transport(dest) â†’ DestTransport
      â†“
   DestTransport.send(payload_type, data)
      â”œâ”€ äº‹ä»¶é©±åŠ¨ç­‰å¾…è¿æ¥å°±ç»ª (watch channel)
      â”œâ”€ æŒ‰è·¯ç”±è¡¨é€‰æ‹© LaneType
      â””â”€ conn.get_lane(payload_type) â†’ Lane
          â†“
   Lane.send(data)
      â”œâ”€ WebRtcDataChannel: data_channel.send(Bytes)
      â”œâ”€ WebRtcMediaTrack: track.send(Frame) [TODO]
      â””â”€ WebSocket: sink.send(WsMessage::Binary([type][len][data]))
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: Wire                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   WebRTC DataChannel / WebRTC MediaTrack / WebSocket å‘é€å­—èŠ‚æµ
      â†“
   ç½‘ç»œä¼ è¾“ / è¿›ç¨‹å†…ä¼ é€’
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‡ºç«™å…³é”®ç‚¹**ï¼š
1. **ä¸ç»è¿‡ InboundPacketDispatcher** - ç›´æ¥ä» Outbound åˆ° Transport/Wire
2. **Inproc å’Œ Outproc æ¶æ„ç»Ÿä¸€**ï¼š
   - **Inproc**: Layer 2 â†’ Layer 1 (InprocTransportManager + Lane::Mpsc) â†’ Layer 0ï¼ˆå®Œæ•´ä¸‰å±‚ï¼‰
   - **Outproc**: Layer 2 â†’ Layer 1 (OutprocTransportManager + Lane::WebRTC/WebSocket) â†’ Layer 0ï¼ˆå®Œæ•´ä¸‰å±‚ï¼‰
   - **ç»Ÿä¸€æŠ½è±¡**ï¼šä¸¤æ¡è·¯å¾„éƒ½ç»è¿‡ Lane å±‚ï¼ˆTransport Layer 1ï¼‰
3. **PayloadType é€šé“ç®¡ç†**ï¼š
   - **Inproc**:
     - Reliable å¿…é¡»åˆ›å»º
     - Signal å»¶è¿Ÿåˆ›å»ºï¼ˆå¯é€‰ï¼‰
     - LatencyFirst/MediaTrack åŠ¨æ€åˆ›å»ºï¼ˆHashMap å¤šå®ä¾‹ï¼‰
     - **ç›´æ¥ä¼ é€’ RpcEnvelope å¯¹è±¡ï¼Œé›¶åºåˆ—åŒ–**
   - **Outproc**: 4 ä¸ª PayloadType é€šè¿‡ Lane è·¯ç”±ï¼ˆWebRTC DataChannel æˆ– WebSocket å¸§å¤´ï¼‰
4. **RPC å“åº”åŒ¹é…ï¼ˆç»Ÿä¸€æœºåˆ¶ï¼‰**ï¼š
   - **Inproc**: InprocTransportManager.pending_requests HashMap
   - **Outproc**: OutprocTransportManager.pending_requests HashMap
5. **é»˜è®¤ PayloadType** - ä¸¤è€…éƒ½é»˜è®¤ä½¿ç”¨ Reliableï¼Œç”¨æˆ·å¯æŒ‡å®šå…¶ä»–ç±»å‹
6. **äº‹ä»¶é©±åŠ¨è¿æ¥é€‰æ‹©** - watch channel é›¶è½®è¯¢ï¼ˆä»… Outprocï¼‰

### å…¥ç«™æµå‘ï¼ˆInbound Path)

**å…¥ç«™æµå‘ä» Wire å±‚å¼€å§‹ï¼Œå‘ä¸Šç»è¿‡ Inbound åˆ° Application**ã€‚

#### Inproc å…¥ç«™ï¼ˆè¿›ç¨‹å†…ï¼‰

**æ³¨æ„**: Inproc å…¥ç«™è·¯å¾„**ç›´æ¥æ¥æ”¶ RpcEnvelope å¯¹è±¡**ï¼Œé›¶åºåˆ—åŒ–ã€‚
**InprocTransportManager è‡ªåŠ¨å¤„ç† pending_requests åŒ¹é…**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº•å±‚: tokio::sync::mpsc (æ—  Wire å±‚)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   mpsc::Receiver<RpcEnvelope>.recv()
      â†“
   **é›¶åºåˆ—åŒ–ï¼šç›´æ¥æ¥æ”¶ RpcEnvelope å¯¹è±¡**
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Transport (InprocTransportManager)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   InprocTransportManager.recv() â†’ RpcEnvelope
      â†“
   tokio::select! { biased;
       msg = rx_signal.recv() => ...
       msg = rx_reliable.recv() => ...
       msg = å„ä¸ª LatencyFirst channel => ...
       msg = å„ä¸ª MediaTrack channel => ...
   }
      â†“
   try_complete_response(envelope):
      if pending_requests.contains(request_id):
          response_tx.send(envelope.payload)  // å”¤é†’ç­‰å¾…è€…
          return  // å·²å¤„ç†ï¼Œä¸è¿”å›ç»™è°ƒç”¨æ–¹
      â†“
   è¿”å› RpcEnvelopeï¼ˆå¦‚æœä¸æ˜¯ responseï¼‰
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application Layerï¼ˆShell æ¥æ”¶å¾ªç¯ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   while let Some(envelope) = actr_node.inproc_mgr.recv().await
      â†“
   Router::route(workload, envelope, ctx)
      â†“
   Workload.handle_xxx(request, ctx)
      â†“
   è¿”å› response_envelope
      â†“
   é€šè¿‡æ­£å¸¸å‡ºç«™è·¯å¾„å‘é€å“åº”ï¼ˆèµ° InprocTransportManagerï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯é€‰çš„å®Œæ•´è·¯å¾„**ï¼ˆæ¥å…¥ InboundPacketDispatcherï¼‰ï¼š
- å¦‚æœéœ€è¦ä½¿ç”¨ Mailbox æŒä¹…åŒ–æˆ– Fast Path Registry
- å¯åœ¨æ¥æ”¶å¾ªç¯ä¸­è°ƒç”¨ `InboundPacketDispatcher.dispatch(InboundPacket { payload_type, ... })`
- æ­¤æ—¶ä¼šæŒ‰ `payload_type` è·¯ç”±åˆ° Mailbox æˆ– Registry
- å®Œå…¨å¯¹é½ Outproc çš„å…¥ç«™å¤„ç†æµç¨‹

#### Outproc å…¥ç«™ï¼ˆè·¨è¿›ç¨‹ - WebRTCï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: Wire                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   WebRTC DataChannel.on_message(bytes)
      â†“
   Lane.rx.send(bytes)  (æ¯ä¸ª DataChannel ä¸€ä¸ª Lane)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Transport                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   WebRtcCoordinator æ±‡æ€»æ‰€æœ‰ Peer çš„æ¶ˆæ¯
      â†“
   message_rx.recv() â†’ (from: ActrId, data: Vec<u8>)
      â†“
   è§£ç  RpcEnvelope::decode(data)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: Inbound                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   InboundPacketDispatcher.route_incoming(envelope)
      â†“
   match envelope.payload_type {
       Signal â†’ Mailbox.enqueue(High Priority)
       Reliable â†’ Mailbox.enqueue(Normal Priority)
       LatencyFirst â†’ StreamChunkRegistry.dispatch()
       MediaTrack â†’ MediaFrameRegistry.dispatch()
   }
      â†“
   ã€State Pathã€‘Mailbox è·¯å¾„:
      MailboxScheduler.dequeue() â†’ envelope
          â†“
   ã€Fast Pathã€‘Registry è·¯å¾„:
      Registry.dispatch() â†’ ç›´æ¥è°ƒç”¨ç”¨æˆ·å›è°ƒ
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application Layer                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   ã€State Path - Mailboxã€‘:
      Router::route(workload, envelope, ctx)
         â†“
      Workload.handle_xxx(request, ctx)
         â†“
      ã€åº”ç”¨å±‚ RPC åŒ¹é…ã€‘:
         å¦‚æœ envelope åŒ…å« request_idï¼ˆå“åº”æ¶ˆæ¯ï¼‰:
            OutprocOutGate.pending_requests.get(request_id)
               â†“
            oneshot_tx.send(response_bytes)  å”¤é†’ send_request()

         å¦åˆ™ï¼ˆæ–°è¯·æ±‚ï¼‰:
            å¤„ç†è¯·æ±‚å¹¶å‘é€å“åº”æ¶ˆæ¯ï¼ˆé€šè¿‡å‡ºç«™è·¯å¾„ï¼‰

   ã€Fast Path - Registryã€‘:
      user_callback(StreamChunk, sender_id: ActrId)  æˆ–
      user_callback(MediaFrame, sender_id: ActrId)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Outproc å…¥ç«™ï¼ˆè·¨è¿›ç¨‹ - WebSocketï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: Wire                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   WebSocket.on_message(WsMessage::Binary)
      â†“
   è¯»å–æ¶ˆæ¯å¤´: [1 byte PayloadType][4 bytes len][N bytes data]
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Transport                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   WebSocketConnection dispatcher
      â†“
   æ ¹æ® PayloadType è·¯ç”±åˆ°å¯¹åº” Lane.rx
      â†“
   lane_dispatchers[payload_type].send(data)
      â†“
   ã€åç»­æµç¨‹ä¸ WebRTC å…¥ç«™ç›¸åŒã€‘
   è§£ç  RpcEnvelope â†’ Inbound â†’ Application
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…¥ç«™å…³é”®ç‚¹**ï¼š
1. **Inproc vs Outproc å…¥ç«™å·®å¼‚**ï¼š
   - **Inproc**: InprocTransportManager è‡ªåŠ¨å¤„ç† pending_requestsï¼Œåªè¿”å›çœŸæ­£çš„ request
   - **Outproc**: ä» Lane æ¥æ”¶ï¼Œå¿…é¡»ç»è¿‡ InboundPacketDispatcherï¼ˆLayer 3ï¼‰è·¯ç”±
2. **Wire å±‚æ¥æ”¶** - ç‰©ç†å±‚æ¥æ”¶æœºåˆ¶ï¼š
   - **Inproc**:
     - Reliable/Signal: å•ä¸ª mpsc::Receiver<RpcEnvelope>
     - LatencyFirst/MediaTrack: HashMap å¤šä¸ª mpsc::Receiver
     - **ç›´æ¥æ¥æ”¶ RpcEnvelope å¯¹è±¡ï¼Œé›¶åºåˆ—åŒ–**
   - **Outproc**: WebSocket dispatcher æˆ– WebRTC DataChannel onmessage
3. **Lane å±‚ç»Ÿä¸€** - ä¸¤æ¡è·¯å¾„éƒ½ä½¿ç”¨ Lane æŠ½è±¡ï¼š
   - **Inproc**: Lane::Mpscï¼ˆç›´æ¥ä¼ é€’ RpcEnvelopeï¼Œé›¶åºåˆ—åŒ–ï¼‰
   - **Outproc**: Lane::WebRTC/WebSocketï¼ˆä¼ é€’ Bytesï¼Œéœ€åºåˆ—åŒ–ï¼‰
4. **Inbound å±‚è·¯ç”±** - æŒ‰ PayloadType è·¯ç”±åˆ° Mailbox æˆ– Registryï¼š
   - **Inproc**: å¯é€‰ï¼ˆè°ƒç”¨æ–¹å¯ç›´æ¥å¤„ç†æˆ–æ¥å…¥ Dispatcherï¼‰
   - **Outproc**: å¿…éœ€
5. **æ‰€æœ‰æ¶ˆæ¯å¼‚æ­¥** - æ²¡æœ‰ä¼ è¾“å±‚çš„åŒæ­¥ Request/Response åŒºåˆ†
6. **RPC åŒ¹é…ç»Ÿä¸€** - ä¸¤è€…éƒ½ä½¿ç”¨ pending_requests HashMap æœºåˆ¶ï¼ˆInprocTransportManager / OutprocTransportManagerï¼‰

### MediaTrack æµå‘è¯¦è§£ï¼ˆWebRTC åŸç”Ÿ RTPï¼‰

**MediaTrack** æ˜¯ WebRTC åŸç”Ÿåª’ä½“ä¼ è¾“è·¯å¾„ï¼Œä½¿ç”¨ RTP åè®®è€Œé DataChannelï¼Œæä¾›é›¶åºåˆ—åŒ–å¼€é”€å’Œæ›´ä½å»¶è¿Ÿã€‚

#### MediaTrack å‡ºç«™ï¼ˆå‘é€åª’ä½“ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application Layer                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   Workload è°ƒç”¨
      â†“
   ctx.send_media_sample(target, "video-track-1", sample)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: Context Implementation (RuntimeContext)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   RuntimeContext.send_media_sample()
      â†“
   è°ƒç”¨ WebRtcCoordinator.send_media_sample()
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: Wire (WebRtcCoordinator)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   1. æŸ¥æ‰¾ peer_stateï¼ˆç›®æ ‡ Actorï¼‰
   2. è·å–æŒ‡å®š track_id çš„ Track
   3. è·å– RTP sequence numberï¼ˆper-track AtomicU16ï¼‰
   4. è·å– SSRCï¼ˆper-track unique u32ï¼‰
   5. æ„é€  RTP packet:
      header: RtpHeader {
          version: 2,
          padding: false,
          extension: false,
          marker: false,
          payload_type: 96,  // VP8/H264/OPUS
          sequence_number,   // Atomic counter (wraps at 65535)
          timestamp: sample.timestamp,
          ssrc,              // Unique random u32
          csrc: vec![],
          extension_profile: 0,
          extensions: vec![],
      }
      payload: sample.data (Bytes, zero-copy)
      â†“
   6. track.write_rtp(&rtp_packet).await
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebRTC Native RTP Channel                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   ç›´æ¥ RTP ä¼ è¾“ï¼Œæ—  protobuf åºåˆ—åŒ–
   æ”¯æŒä»»æ„å¤§å°ï¼ˆå·²æµ‹è¯• >1MBï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å®ç°ç»†èŠ‚**ï¼š

1. **RTP Sequence Number**ï¼š
   ```rust
   // In WebRtcConnection
   track_sequence_numbers: Arc<RwLock<HashMap<String, Arc<AtomicU16>>>>

   pub async fn next_sequence_number(&self, track_id: &str) -> Option<u16> {
       seq_nums.get(track_id).map(|atomic_seq| {
           atomic_seq.fetch_add(1, Ordering::SeqCst)  // Atomic increment
       })
   }
   ```
   - æ¯ä¸ª track ç‹¬ç«‹è®¡æ•°å™¨
   - åŸå­æ“ä½œï¼Œçº¿ç¨‹å®‰å…¨
   - è‡ªåŠ¨åœ¨ 65535 å¤„å›ç»•

2. **SSRC (Synchronization Source)**ï¼š
   ```rust
   // In WebRtcConnection
   track_ssrcs: Arc<RwLock<HashMap<String, u32>>>

   // In add_media_track()
   let ssrc = rand::random::<u32>();  // RFC 3550 compliant
   ssrcs.insert(track_id.clone(), ssrc);
   ```
   - æ¯ä¸ª track å”¯ä¸€éšæœº SSRC
   - åˆ›å»ºæ—¶ç”Ÿæˆï¼Œè¿æ¥æœŸé—´ä¸å˜

3. **é›¶åºåˆ—åŒ–å¼€é”€**ï¼š
   - `sample.data` æ˜¯ `Bytes`ï¼ˆé›¶æ‹·è´ï¼‰
   - ç›´æ¥å¡«å……åˆ° RTP payload
   - æ—  protobuf ç¼–è§£ç 

#### MediaTrack å…¥ç«™ï¼ˆæ¥æ”¶åª’ä½“ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebRTC Native RTP Channel                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   PeerConnection.on_track(RTCTrackRemote) callback
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: Wire (WebRtcCoordinator)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   loop {
       track.read_rtp().await â†’ RtpPacket
           â†“
       è½¬æ¢ä¸º MediaSample:
           data: Bytes::from(rtp_packet.payload)
           timestamp: rtp_packet.header.timestamp
           codec: "unknown"  // TODO: ä» track metadata æå–
           media_type: MediaType::Video  // TODO: ä» track.kind() æ£€æµ‹
           â†“
       MediaFrameRegistry::dispatch(track_id, sample, sender_id)
   }
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: Inbound (MediaFrameRegistry)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   æŸ¥æ‰¾å·²æ³¨å†Œçš„å›è°ƒ: callbacks.get(track_id)
      â†“
   è°ƒç”¨ç”¨æˆ·å›è°ƒ:
      callback(sample, sender_id).await
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application Layer (User Callback)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   Box::pin(async move {
       tracing::info!("Received frame: {} bytes", sample.data.len());
       // Process video/audio frame...
       Ok(())
   })
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å®ç°ç»†èŠ‚**ï¼š

1. **on_track Callback æ³¨å†Œ**ï¼š
   ```rust
   // In WebRtcCoordinator::initiate_connection()
   peer_connection.on_track(Box::new(move |track, _receiver, _transceiver| {
       let track_id = track.id();
       tokio::spawn(async move {
           loop {
               let rtp = track.read_rtp().await?;
               let sample = MediaSample {
                   data: Bytes::from(rtp.payload),
                   timestamp: rtp.header.timestamp,
                   codec: "unknown".to_string(),
                   media_type: MediaType::Video,
               };
               registry.dispatch(&track_id, sample, &sender_id).await;
           }
       });
   }))
   ```

2. **MediaFrameRegistry**ï¼š
   ```rust
   // In crates/runtime/src/inbound/media_frame_registry.rs
   type Callback = Arc<dyn Fn(MediaSample, ActrId) -> BoxFuture<'static, ActorResult<()>>>;

   callbacks: Arc<RwLock<HashMap<String, Callback>>>

   pub async fn dispatch(&self, track_id: &str, sample: MediaSample, sender: &ActrId) {
       if let Some(callback) = self.callbacks.read().await.get(track_id) {
           callback(sample, sender.clone()).await?;
       }
   }
   ```

3. **Fast Path ç‰¹æ€§**ï¼š
   - ä¸ç»è¿‡ Mailboxï¼ˆæ— æŒä¹…åŒ–ï¼‰
   - ç›´æ¥å›è°ƒç”¨æˆ·ä»£ç 
   - å»¶è¿Ÿ <10Î¼sï¼ˆæ¡†æ¶å¼€é”€ï¼‰

#### Dynamic Track Creationï¼ˆåŠ¨æ€æ·»åŠ  Trackï¼‰

**å®ç°**ï¼šé€šè¿‡ SDP é‡æ–°åå•†åœ¨ç°æœ‰è¿æ¥ä¸Šæ·»åŠ æ–° trackï¼Œæ— éœ€æ–­å¼€é‡è¿ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User API                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   coordinator.add_dynamic_track(target, "audio-1", "OPUS", "audio")
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebRtcCoordinator::add_dynamic_track()                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   1. è·å–ç°æœ‰ peer_state
   2. webrtc_conn.add_media_track(track_id, codec, media_type)
      â”œâ”€ åˆ›å»º Track
      â”œâ”€ peer_connection.add_track(track)
      â”œâ”€ ç”Ÿæˆ SSRC å¹¶å­˜å‚¨
      â””â”€ åˆå§‹åŒ– sequence_number = 0
   3. renegotiate_connection(target, &peer_connection)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebRtcCoordinator::renegotiate_connection()                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   1. peer_connection.create_offer(None)
      â†’ ç”Ÿæˆæ–° SDPï¼ˆåŒ…å«æ‰€æœ‰ trackï¼šæ—§çš„ + æ–°çš„ï¼‰
   2. peer_connection.set_local_description(offer)
   3. é€šè¿‡ä¿¡ä»¤å‘é€ Offer åˆ°å¯¹ç«¯
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Remote Peer: handle_renegotiation_offer()                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   1. æ£€æµ‹åˆ° peer_state å·²å­˜åœ¨ï¼ˆé‡æ–°åå•†ï¼‰
   2. peer_connection.set_remote_description(offer_sdp)
   3. peer_connection.create_answer(None)
   4. peer_connection.set_local_description(answer)
   5. é€šè¿‡ä¿¡ä»¤å‘é€ Answer å›æ¥
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Initiator: handle_answer()                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   1. peer_connection.set_remote_description(answer_sdp)
   2. æ–° track æ¿€æ´»ï¼
   3. å¯¹ç«¯çš„ on_track callback è§¦å‘ï¼ˆè‡ªåŠ¨è·å– track_idï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š

1. **æ— éœ€æ–­å¼€è¿æ¥**ï¼š
   - ICE connection ä¿æŒæ´»è·ƒ
   - ç°æœ‰ track ç»§ç»­ä¼ è¾“
   - ä»… SDP åå•†ï¼ˆ~100-300msï¼‰

2. **Track ID è‡ªåŠ¨åŒæ­¥**ï¼š
   - Track ID åµŒå…¥ SDP media section
   - WebRTC on_track callback è‡ªåŠ¨æä¾› track.id()
   - æ— éœ€é¢å¤–ä¿¡ä»¤æ¶ˆæ¯

3. **å®ç°**ï¼š~150 LOC
   - `add_dynamic_track()` - å…¬å…± API
   - `renegotiate_connection()` - å‘èµ·æ–¹è·¯å¾„
   - `handle_renegotiation_offer()` - å“åº”æ–¹è·¯å¾„
   - å¢å¼º `handle_offer()`/`handle_answer()` - æ£€æµ‹é‡æ–°åå•†

#### MediaTrack vs DataChannel å¯¹æ¯”

| ç»´åº¦ | DataChannel (RPC) | MediaTrack (Native RTP) |
|------|-------------------|------------------------|
| **Layer** | Layer 1 (Lane::WebRtcDataChannel) | Layer 0 (ç›´æ¥ Track.write_rtp) |
| **PayloadType** | RPC_RELIABLE / RPC_SIGNAL | MEDIA_RTP (ä¸ä½¿ç”¨ PayloadType è·¯ç”±) |
| **åºåˆ—åŒ–** | Protobuf (RpcEnvelope) | é›¶ï¼ˆç›´æ¥ RTPï¼‰ |
| **æœ€å¤§å¸§å¤§å°** | 16 KB (WebRTC é™åˆ¶) | æ— é™åˆ¶ï¼ˆå·²æµ‹è¯• >1MBï¼‰ |
| **å»¶è¿Ÿ** | Baseline | -1~2ms |
| **RTP Header** | æ—  | å®Œæ•´ RTP header (seq, ssrc, timestamp) |
| **Inbound è·¯ç”±** | InboundPacketDispatcher â†’ Mailbox | MediaFrameRegistry â†’ ç›´æ¥å›è°ƒ |
| **ç”¨ä¾‹** | RPC æ¶ˆæ¯ã€æ§åˆ¶ä¿¡ä»¤ | è§†é¢‘ã€éŸ³é¢‘æµ |

---

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. å‡ºç«™/å…¥ç«™å®Œå…¨åˆ†ç¦»

**å‡ºç«™è·¯å¾„ï¼ˆç»Ÿä¸€ï¼‰**ï¼š
- Application â†’ Outbound (Layer 2) â†’ **Lane (Layer 1)** â†’ Wire (Layer 0)
- ä¸ç»è¿‡ Inbound
- Inproc/Outproc éƒ½ç»è¿‡ Lane å±‚

**å…¥ç«™è·¯å¾„ï¼ˆç»Ÿä¸€ï¼‰**ï¼š
- Wire (Layer 0) â†’ **Lane (Layer 1)** â†’ Inbound (Layer 3) â†’ Application
- ä¸ç»è¿‡ Outbound
- Inproc/Outproc éƒ½ç»è¿‡ Lane å±‚

**ä¼˜åŠ¿**ï¼š
- **èŒè´£æ¸…æ™°**ï¼šOutbound åªè´Ÿè´£å‡ºç«™ï¼ŒInbound åªè´Ÿè´£å…¥ç«™
- **é›¶è€¦åˆ**ï¼šå‡ºç«™å’Œå…¥ç«™å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–
- **æ€§èƒ½æœ€ä¼˜**ï¼šå‡ºç«™ç›´æ¥åˆ° Transportï¼Œæ— é¢å¤–è·¯ç”±å¼€é”€
- **æ¶æ„ç»Ÿä¸€**ï¼šInproc å’Œ Outproc å…±äº« Lane æŠ½è±¡

### 2. Lane ç»Ÿä¸€æŠ½è±¡ï¼ˆInproc + Outprocï¼‰

**è®¾è®¡ç†å¿µ**ï¼šLane æ˜¯ Transport å±‚çš„æ ¸å¿ƒæŠ½è±¡ï¼Œç»Ÿä¸€ Inproc å’Œ Outproc çš„ä¼ è¾“æ¥å£ã€‚

```rust
pub enum Lane {
    // Inproc: ç›´æ¥ä¼ é€’ RpcEnvelopeï¼ˆé›¶åºåˆ—åŒ–ï¼‰
    Mpsc {
        payload_type: PayloadType,
        tx: mpsc::Sender<RpcEnvelope>,
        rx: Arc<Mutex<mpsc::Receiver<RpcEnvelope>>>,
    },
    // Outproc: ä¼ é€’ Bytesï¼ˆéœ€åºåˆ—åŒ–ï¼‰
    WebRtcDataChannel {
        data_channel: Arc<RTCDataChannel>,
        rx: Arc<Mutex<mpsc::Receiver<Bytes>>>,
    },
    WebRtcMediaTrack {
        track: Arc<String>,
        rx: Arc<Mutex<mpsc::Receiver<Bytes>>>,
    },
    WebSocket {
        sink: Arc<Mutex<Option<SplitSink<...>>>>,
        payload_type: PayloadType,
        rx: Arc<Mutex<mpsc::Receiver<Bytes>>>,
    },
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- **åŒæ¥å£è®¾è®¡**ï¼š
  - Inproc: `send_envelope(RpcEnvelope)` / `recv_envelope()` - é›¶åºåˆ—åŒ–
  - Outproc: `send(Bytes)` / `recv()` - éœ€åºåˆ—åŒ–
- **é›¶æ‹·è´ä¼ è¾“**ï¼š
  - Inproc: ç›´æ¥ä¼ é€’ RpcEnvelope å¯¹è±¡
  - Outproc: ä½¿ç”¨ Bytes å®ç°é›¶æ‹·è´
- **PayloadType æ„ŸçŸ¥**ï¼šMpsc å’Œ WebSocket æ˜¾å¼æºå¸¦ç±»å‹ä¿¡æ¯
- **é›¶è¿è¡Œæ—¶å¼€é”€**ï¼šç¼–è¯‘æ—¶ enum dispatchï¼Œæ— è™šå‡½æ•°è°ƒç”¨
- **Inproc + Outproc ç»Ÿä¸€**ï¼šä¸¤æ¡è·¯å¾„éƒ½ç»è¿‡ Lane å±‚

**è·å– Lane çš„æ–¹å¼**ï¼š
- Inproc: `InprocTransportManager.get_lane(payload_type, identifier)` â†’ Lane::Mpsc
- WebRTC: `WebRtcConnection.get_lane(payload_type)` â†’ Lane::WebRtcDataChannel
- WebSocket: `WebSocketConnection.get_lane(payload_type)` â†’ Lane::WebSocket

### 3. äº‹ä»¶é©±åŠ¨ï¼ˆé›¶è½®è¯¢ï¼‰

**å…³é”®æœºåˆ¶**ï¼š
- `tokio::sync::watch` å¹¿æ’­è¿æ¥å°±ç»ªçŠ¶æ€
- `conn_watcher.changed().await` ç­‰å¾…çŠ¶æ€å˜åŒ–ï¼ˆå»¶è¿Ÿ <1msï¼‰
- é¥±å’Œå¼å¹¶å‘è¿æ¥ï¼ˆWebRTC + WebSocket åŒæ—¶å°è¯•ï¼‰

### 4. é™æ€è·¯ç”±ï¼ˆé›¶è¿è¡Œæ—¶å¼€é”€ï¼‰

**PayloadTypeExt trait**ï¼š
```rust
impl PayloadTypeExt for PayloadType {
    fn lane_types(&self) -> &'static [LaneType] {
        match self {
            Signal       => &[WebRtcDataChannel(Signal), WebSocket],
            Reliable     => &[WebRtcDataChannel(Reliable), WebSocket],
            LatencyFirst => &[WebRtcDataChannel(LatencyFirst), WebSocket],
            MediaTrack   => &[WebRtcMediaTrack],
        }
    }
}
```

ç¼–è¯‘æ—¶ç¡®å®šï¼Œæ— è¿è¡Œæ—¶æŸ¥æ‰¾ã€‚

### 5. Enum Dispatchï¼ˆé¿å… trait objectï¼‰

**WireHandle æšä¸¾**ï¼š
```rust
pub enum WireHandle {
    WebSocket(WebSocketConnection),
    WebRTC(WebRtcConnection),
}
```

**OutGate æšä¸¾**ï¼š
```rust
pub enum OutGate {
    InprocOut(Arc<InprocOutGate>),
    OutprocOut(Arc<OutprocOutGate>),
}
```

é™æ€åˆ†å‘ï¼Œé›¶è™šæ‹Ÿè°ƒç”¨å¼€é”€ã€‚

### 6. Fast Path vs State Path è¯­ä¹‰åˆ†ç¦»

**é—®é¢˜**ï¼š
- State Path (RPC): éœ€è¦å®Œæ•´çš„ Contextï¼ˆrequest_id, trace_id, caller_id, å‡ºç«™èƒ½åŠ›ï¼‰
- Fast Path (Stream): åªéœ€è¦å‘é€æ–¹æ ‡è¯†ï¼ˆActrIdï¼‰ï¼Œä¸éœ€è¦ RPC è¯­ä¹‰

**è®¾è®¡å†³ç­–**ï¼š
- **State Path å›è°ƒ**ï¼š`handle(request, ctx: &Context)` - æ”¯æŒåŒå‘é€šä¿¡ï¼ˆé€šè¿‡ ctx.call/tellï¼‰
- **Fast Path å›è°ƒ**ï¼š`callback(data, sender_id: ActrId)` - å•å‘æ¨é€

**Registry å›è°ƒç­¾å**ï¼š
```rust
// StreamChunkRegistry
type StreamChunkCallback = Arc<
    dyn Fn(StreamChunk, ActrId) -> BoxFuture<'static, ActorResult<()>>
>;

// MediaFrameRegistry
type MediaFrameCallback = Arc<
    dyn Fn(MediaFrame, ActrId) -> BoxFuture<'static, ActorResult<()>>
>;
```

**ä¼˜åŠ¿**ï¼š
- **è¯­ä¹‰æ¸…æ™°**ï¼šFast Path ä¸æä¾› Contextï¼Œç”¨æˆ·æ— æ³•è¯¯ç”¨ RPC æ¥å£
- **æ€§èƒ½æœ€ä¼˜**ï¼šé¿å…åˆ›å»º dummy Context å’Œ dummy å‡ºç«™é—¨
- **å¥‘çº¦æ˜ç¡®**ï¼šFast Path æ˜¯æµå¼æ¨é€ï¼Œéœ€è¦åå‘é€šä¿¡è¯·åœ¨ State Path ä¸­å¤„ç†æˆ–åˆ›å»ºç‹¬ç«‹ Context

---

## æ€§èƒ½æŒ‡æ ‡

### State Path (Mailbox)

| é˜¶æ®µ | æ—¶é—´ |
|------|------|
| Mailbox Dequeue | ~1ms |
| Protobuf Decode | ~100Î¼s |
| InboundPacketDispatcher è·¯ç”± | ~5ns |
| Context Create | ~10ns |
| Router::route (æ¡†æ¶) | ~5-10ns |
| Mailbox ACK | ~500Î¼s |
| **æ¡†æ¶æ€»å¼€é”€** | **~2ms** |

### Fast Path (Registry)

| é˜¶æ®µ | æ—¶é—´ |
|------|------|
| WebRTC MediaTrack æ¥æ”¶ | ~10Î¼s |
| Registry Dispatch | ~5ns |
| Callback è°ƒç”¨ | ~5ns |
| **æ¡†æ¶æ€»å¼€é”€** | **~10Î¼s** |

### MediaTrack è¯¦ç»†æ€§èƒ½

**ä¸ DataChannel å¯¹æ¯”**ï¼š

| æŒ‡æ ‡ | DataChannel (RPC) | MediaTrack (Native RTP) | æ”¹è¿› |
|------|-------------------|------------------------|------|
| **æœ€å¤§å¸§å¤§å°** | 16 KB | æ— é™åˆ¶ï¼ˆå·²æµ‹è¯• >1MBï¼‰ | 64x+ |
| **åºåˆ—åŒ–å¼€é”€** | ~100Î¼s (Protobuf) | 0Î¼s (é›¶åºåˆ—åŒ–) | 100% |
| **ç«¯åˆ°ç«¯å»¶è¿Ÿ** | Baseline | -1~2ms | ~10% |
| **CPU å¼€é”€** | ç¼–è§£ç  + åºåˆ—åŒ– | ä»…ç¼–è§£ç  | -30% |
| **å†…å­˜æ‹·è´** | 1 æ¬¡ï¼ˆåºåˆ—åŒ–ï¼‰ | 0 æ¬¡ï¼ˆBytes é›¶æ‹·è´ï¼‰ | 100% |

**ååé‡æµ‹è¯•**ï¼ˆ1080p è§†é¢‘æµï¼‰ï¼š

| åœºæ™¯ | DataChannel | MediaTrack | å¤‡æ³¨ |
|------|-------------|-----------|------|
| **720p @ 30fps** | âœ… 5 Mbps | âœ… 5 Mbps | ä¸¤è€…å‡å¯ |
| **1080p @ 30fps** | âŒ éœ€åˆ†å— | âœ… 12 Mbps | MediaTrack æ— é™åˆ¶ |
| **1080p @ 60fps** | âŒ ä¸å¯è¡Œ | âœ… 20 Mbps | ä»… MediaTrack |
| **4K @ 30fps** | âŒ ä¸å¯è¡Œ | âœ… 50 Mbps | ä»… MediaTrack |

**RTP Header ç®¡ç†æ€§èƒ½**ï¼š

| æ“ä½œ | æ—¶é—´ | å®ç° |
|------|------|------|
| next_sequence_number() | ~50ns | AtomicU16::fetch_add (lock-free) |
| get_ssrc() | ~100ns | HashMap read lock |
| RTP packet æ„é€  | ~200ns | æ ˆåˆ†é… + Bytes é›¶æ‹·è´ |

---

## æ¨¡å—ä¾èµ–å…³ç³»

```
actr-runtime
â”œâ”€ actr-protocol (æ ¸å¿ƒåè®®å®šä¹‰)
â”œâ”€ actr-framework (Workload trait)
â”œâ”€ actr-mailbox (SQLite é˜Ÿåˆ—ï¼Œå­ crate)
â”œâ”€ actr-config (é…ç½®ç®¡ç†)
â””â”€ actr-version (å…¼å®¹æ€§)

å¤–éƒ¨ä¾èµ–ï¼š
â”œâ”€ tokio (å¼‚æ­¥è¿è¡Œæ—¶)
â”œâ”€ webrtc (WebRTC å®ç°)
â”œâ”€ tokio-tungstenite (WebSocket)
â””â”€ prost (Protobuf ç¼–è§£ç )
```

---

## æ™ºèƒ½é‡è¿æ¶æ„

> **æ™ºèƒ½é‡è¿å®Œæ•´è®¾è®¡**ï¼šè¯¦è§æœ¬æ–‡æ¡£åç»­ç« èŠ‚

### æ ¸å¿ƒç†å¿µ

**"æœ€å¤§åŒ–å¤ç”¨åˆå§‹åŒ–é€»è¾‘ï¼Œé€‰æ‹©æ€§æ¢å¤å¤±è´¥è¿æ¥è€Œä¸å¹²æ‰°å·¥ä½œè¿æ¥"**

å½“è¿è¡Œæ—¶è¿æ¥å¤±è´¥æ—¶ï¼š
1. **ä¿ç•™å·¥ä½œè¿æ¥** - Ready/Connecting çŠ¶æ€çš„è¿æ¥ä¿æŒä¸å˜
2. **å¤ç”¨åˆå§‹åŒ–ä»£ç ** - è°ƒç”¨ä¸å¯åŠ¨æ—¶ç›¸åŒçš„ `WireBuilder` é€»è¾‘
3. **è‡ªåŠ¨è·³è¿‡** - Either-like é€»è¾‘é˜²æ­¢é‡å¤è¿æ¥å°è¯•
4. **ç»†ç²’åº¦æ¢å¤** - å•ä¸ªè¿æ¥å¤±è´¥ä¸ä¼šå¯¼è‡´æ•´ä¸ª DestTransport è¢«åˆ é™¤

### ä¸‰å±‚åä½œæœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Health Checker (å¥åº·æ£€æŸ¥å™¨)                                  â”‚
â”‚  â””â”€ æ¯ 10s æ‰«ææ‰€æœ‰ DestTransport                            â”‚
â”‚      â”œâ”€ æ‰€æœ‰è¿æ¥å¤±è´¥? â†’ åˆ é™¤æ•´ä¸ª DestTransport               â”‚
â”‚      â””â”€ éƒ¨åˆ†è¿æ¥å·¥ä½œ? â†’ è§¦å‘æ™ºèƒ½é‡è¿                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ retry_failed_connections()
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DestTransport (ç›®æ ‡ä¼ è¾“æ§åˆ¶å™¨)                               â”‚
â”‚  â””â”€ è°ƒç”¨ WireBuilder.create_connections()                    â”‚
â”‚      â””â”€ å¯¹æ¯ä¸ª WireHandle: add_connection_smart()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ add_connection_smart()
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WirePool (è¿æ¥æ± )                                            â”‚
â”‚  â””â”€ çŠ¶æ€æ£€æŸ¥ï¼ˆEither-like é€»è¾‘ï¼‰:                            â”‚
â”‚      â”œâ”€ Ready      â†’ â­ï¸  è·³è¿‡ï¼ˆå¤ç”¨ç°æœ‰ï¼‰                   â”‚
â”‚      â”œâ”€ Connecting â†’ â­ï¸  è·³è¿‡ï¼ˆé¿å…é‡å¤ï¼‰                   â”‚
â”‚      â”œâ”€ None       â†’ ğŸ”„ å¯åŠ¨è¿æ¥                            â”‚
â”‚      â””â”€ Failed     â†’ ğŸ”„ å¯åŠ¨è¿æ¥                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å®ç°

#### 1. WirePool::add_connection_smart()

**ä½ç½®**: `crates/runtime/src/transport/wire_pool.rs:216`

```rust
pub async fn add_connection_smart(&self, connection: WireHandle) {
    let conn_type = ConnType::from(&connection);

    // æ£€æŸ¥å½“å‰çŠ¶æ€
    let should_add = {
        let conns = self.connections.read().await;
        match &conns[conn_type.as_index()] {
            Some(WireStatus::Ready(_)) => false,      // è·³è¿‡
            Some(WireStatus::Connecting) => false,    // è·³è¿‡
            Some(WireStatus::Failed) | None => true,  // é‡è¿
        }
    };

    if should_add {
        self.add_connection(connection);
    }
}
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… é›¶å¹²æ‰°ï¼šå·¥ä½œè¿æ¥ï¼ˆReady/Connectingï¼‰ä¿æŒä¸å˜
- âœ… å¹‚ç­‰æ€§ï¼šå¤šæ¬¡è°ƒç”¨åŒä¸€ ConnType æ˜¯å®‰å…¨çš„
- âœ… æ— é”å¿«è·¯å¾„ï¼šä»…è¯»é”ï¼Œå¿«é€Ÿæ£€æŸ¥

#### 2. DestTransport::retry_failed_connections()

**ä½ç½®**: `crates/runtime/src/transport/dest_transport.rs:131`

```rust
pub async fn retry_failed_connections(
    &self,
    dest: &Dest,
    wire_builder: &dyn super::WireBuilder,
) -> NetworkResult<()> {
    // è·å–æ–°çš„è¿æ¥å¥æŸ„ï¼ˆå¤ç”¨åˆå§‹åŒ–é€»è¾‘ï¼‰
    let connections = wire_builder.create_connections(dest).await?;

    // æ™ºèƒ½æ·»åŠ æ¯ä¸ªè¿æ¥ï¼ˆè‡ªåŠ¨è·³è¿‡å·¥ä½œè¿æ¥ï¼‰
    for conn in connections {
        self.conn_mgr.add_connection_smart(conn).await;
    }

    Ok(())
}
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… æœ€å¤§åŒ–ä»£ç å¤ç”¨ï¼šä½¿ç”¨ä¸åˆå§‹åŒ–ç›¸åŒçš„ WireBuilder
- âœ… ç®€å• APIï¼šå•å‡½æ•°è°ƒç”¨è§¦å‘æ•´ä¸ªé‡è¿æµç¨‹
- âœ… å¯ç»„åˆï¼šæ˜“äºé›†æˆå¥åº·æ£€æŸ¥æˆ–æ‰‹åŠ¨é‡è¯•

#### 3. å¢å¼ºçš„å¥åº·æ£€æŸ¥å™¨

**ä½ç½®**: `crates/runtime/src/transport/manager.rs:319`

```rust
// ä¼ªä»£ç å±•ç¤ºå†³ç­–é€»è¾‘
for (dest, transport) in transports {
    if !transport.has_healthy_connection() {
        // æ‰€æœ‰è¿æ¥å¤±è´¥ - åˆ é™¤æ•´ä¸ª DestTransport
        transports.remove(dest);
    } else {
        // è‡³å°‘ä¸€ä¸ªè¿æ¥å·¥ä½œ - è§¦å‘æ™ºèƒ½é‡è¿
        transport.retry_failed_connections(dest, wire_builder).await;
    }
}
```

**æ–°æ—§å¯¹æ¯”**ï¼š

| è¡Œä¸º | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ (æ™ºèƒ½é‡è¿) |
|------|--------|-------------------|
| **æ£€æµ‹åˆ°å•ä¸ªè¿æ¥å¤±è´¥** | åˆ é™¤æ•´ä¸ª DestTransport | è§¦å‘æ™ºèƒ½é‡è¿ï¼Œä¿ç•™å·¥ä½œè¿æ¥ |
| **æ‰€æœ‰è¿æ¥å¤±è´¥** | åˆ é™¤æ•´ä¸ª DestTransport | åˆ é™¤æ•´ä¸ª DestTransport |
| **ç”¨æˆ·ä½“éªŒ** | âŒ å…¨é¢æ–­å¼€ | âœ… æœ€å°å½±å“ |
| **è‡ªåŠ¨æ¢å¤** | âŒ éœ€æ‰‹åŠ¨é‡è¿ | âœ… è‡ªåŠ¨æ¢å¤ |

### å…¸å‹åœºæ™¯

#### åœºæ™¯ 1ï¼šWebSocket å¤±è´¥ï¼ŒWebRTC ä»ç„¶å·¥ä½œ

```
åˆå§‹çŠ¶æ€:
  â”œâ”€ WebSocket: Ready âœ…
  â””â”€ WebRTC: Ready âœ…

è¿è¡Œæ—¶äº‹ä»¶:
  â””â”€ WebSocket è¿æ¥æ–­å¼€ âŒ

å¥åº·æ£€æŸ¥å™¨æ£€æµ‹ (10s é—´éš”):
  â”œâ”€ has_healthy_connection() â†’ true (WebRTC ä»åœ¨)
  â””â”€ è§¦å‘ retry_failed_connections()
       â””â”€> add_connection_smart() å¯¹æ¯ä¸ª:
            â”œâ”€ WebSocket: Failed â†’ ğŸ”„ å¼€å§‹é‡è¿
            â””â”€ WebRTC: Ready â†’ â­ï¸ è·³è¿‡ï¼ˆä¿ç•™ï¼‰

ç»“æœ:
  â”œâ”€ WebSocket: Connecting â†’ Ready âœ… (å·²æ¢å¤)
  â””â”€ WebRTC: Ready âœ… (æœªå—å½±å“)
```

#### åœºæ™¯ 2ï¼šé‡è¿å·²åœ¨è¿›è¡Œä¸­

```
åˆå§‹çŠ¶æ€:
  â”œâ”€ WebSocket: Failed âŒ
  â””â”€ WebRTC: Connecting â³

å¥åº·æ£€æŸ¥å™¨è§¦å‘ retry_failed_connections():
  â””â”€> add_connection_smart() å¯¹æ¯ä¸ª:
       â”œâ”€ WebSocket: Failed â†’ ğŸ”„ å¼€å§‹é‡è¿
       â””â”€ WebRTC: Connecting â†’ â­ï¸ è·³è¿‡ï¼ˆé¿å…é‡å¤ï¼‰

ç»“æœ:
  â””â”€ æ— é‡å¤ WebRTC è¿æ¥å°è¯•ï¼
```

### ç¤ºä¾‹ï¼šEcho æ¶ˆæ¯æµï¼ˆç®€ï¼‰

```mermaid
sequenceDiagram
    participant App as åº”ç”¨
    participant OG as OutprocOutGate
    participant TM as TransportManager
    participant DT as DestTransport
    participant L as Lane
    participant W as Wire(WebRTC/WebSocket)

    App->>OG: ctx.call(target, EchoRequest)
    OG->>TM: send(dest, PayloadType::Reliable, envelope.encode())
    TM->>DT: get_or_create_transport(dest)
    DT->>L: get_lane(PayloadType::Reliable)
    L->>W: send(bytes)
    Note over W: WebRTC DataChannel æˆ– WebSocket äºŒè¿›åˆ¶å¸§
```

- é»˜è®¤ä½¿ç”¨ PayloadType::Reliableï¼›å¯æŒ‰éœ€æŒ‡å®šå…¶ä»–ç±»å‹
- Inproc è·¯å¾„ç±»ä¼¼ï¼Œä½†é€šè¿‡ Lane::Mpsc ç›´æ¥ä¼ é€’ RpcEnvelopeï¼ˆé›¶åºåˆ—åŒ–ï¼‰

### æ€§èƒ½ç‰¹æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æµ‹ä¸æ¢å¤å»¶è¿Ÿ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æ•…éšœæ£€æµ‹: 10s (å¥åº·æ£€æŸ¥é—´éš”ï¼Œå¯é…ç½®)                â”‚
â”‚  2. æ™ºèƒ½å†³ç­–: ~1-2ms (ä»…è¯»é”æ£€æŸ¥)                       â”‚
â”‚  3. è¿æ¥å»ºç«‹:                                            â”‚
â”‚     â”œâ”€ WebSocket: 500ms (å…¸å‹)                          â”‚
â”‚     â””â”€ WebRTC: 2s (åŒ…å« ICE gathering)                  â”‚
â”‚                                                          â”‚
â”‚  æ€»å»¶è¿Ÿ (æœ€åæƒ…å†µ):                                      â”‚
â”‚    â””â”€ 10s (æ£€æµ‹) + 2s (WebRTC) = 12s                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†…å­˜å¼€é”€                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¯ä¸ª DestTransport:                                     â”‚
â”‚    â”œâ”€ connections: [Option<WireStatus>; 2] (~18 bytes) â”‚
â”‚    â””â”€ backoff: Option<ExponentialBackoff> (~40 bytes)  â”‚
â”‚                                                          â”‚
â”‚  æ™ºèƒ½é‡è¿é¢å¤–å¼€é”€: é›¶                                     â”‚
â”‚    â””â”€ å¤ç”¨ç°æœ‰ WirePool ç»“æ„                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CPU å¼€é”€                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¥åº·æ£€æŸ¥å™¨ (æ¯ 10s):                                    â”‚
â”‚    â””â”€ O(N) éå†ï¼Œæ¯ä¸ªç›®æ ‡ ~5Î¼s                          â”‚
â”‚                                                          â”‚
â”‚  add_connection_smart():                                â”‚
â”‚    â”œâ”€ å¿«è·¯å¾„ (è·³è¿‡): ~1-2Î¼s (è¯»é” + match)             â”‚
â”‚    â””â”€ æ…¢è·¯å¾„ (é‡è¿): ~10Î¼s (spawn tokio task)          â”‚
â”‚                                                          â”‚
â”‚  å¯¹æ¯”è½®è¯¢æ–¹å¼:                                           â”‚
â”‚    â”œâ”€ è½®è¯¢: æŒç»­ CPU ä½¿ç”¨ (æµªè´¹)                        â”‚
â”‚    â””â”€ äº‹ä»¶é©±åŠ¨: ç©ºé—²æ—¶é›¶ CPU âœ…                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®è°ƒä¼˜

**å¥åº·æ£€æŸ¥é—´éš”**:

```rust
// åœ¨ TransportManager åˆå§‹åŒ–æ—¶
let health_checker = transport_manager.spawn_health_checker(
    Duration::from_secs(10) // â† å¯é…ç½®é—´éš”
);
```

**æƒè¡¡**:
- **æ›´çŸ­é—´éš” (å¦‚ 5s)**: âœ… æ›´å¿«æ£€æµ‹ âŒ æ›´é«˜ CPU å¼€é”€
- **æ›´é•¿é—´éš” (å¦‚ 30s)**: âœ… æ›´ä½ CPU å¼€é”€ âŒ æ›´æ…¢æ¢å¤

**æ¨è**: 10sï¼ˆå¤§å¤šæ•°åº”ç”¨çš„è‰¯å¥½å¹³è¡¡ï¼‰

---

## è®¾è®¡å“²å­¦

1. **åˆ†å±‚æ¸…æ™°** - ä»£ç ç»„ç»‡ä¸¥æ ¼éµå¾ªæ¶æ„åˆ†å±‚ï¼Œæ¯å±‚èŒè´£æ˜ç¡®
2. **é›¶æˆæœ¬æŠ½è±¡** - ç¼–è¯‘æ—¶ç¡®å®šï¼Œé›¶è¿è¡Œæ—¶å¼€é”€
3. **äº‹ä»¶é©±åŠ¨** - é›¶è½®è¯¢ï¼ŒCPU åªå¤„ç†ä¸šåŠ¡
4. **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
5. **å‡ºç«™å…¥ç«™åˆ†ç¦»** - Outbound è´Ÿè´£å‡ºç«™ï¼ŒInbound è´Ÿè´£å…¥ç«™
6. **åå­—å‡†ç¡®** - èŒè´£å˜æ›´æ—¶ï¼Œåå­—å¿…é¡»åŒæ­¥æ›´æ–°
7. **æ™ºèƒ½é‡è¿** - æœ€å¤§åŒ–å¤ç”¨ï¼Œé€‰æ‹©æ€§æ¢å¤ï¼Œé›¶å¹²æ‰°

---

**æ ¸å¿ƒæ¶æ„è®¾è®¡**ï¼š
- **æ™ºèƒ½é‡è¿æœºåˆ¶**ï¼šWirePool::add_connection_smart() + DestTransport::retry_failed_connections()
- **ç»†ç²’åº¦å¥åº·æ£€æŸ¥**ï¼šéƒ¨åˆ†å¤±è´¥æ—¶ä¿ç•™å·¥ä½œè¿æ¥
- **åŒä¼ è¾“ç®¡ç†å™¨**ï¼šInprocTransportManager (Shell â†” Workload) + OutprocTransportManager (è·¨è¿›ç¨‹)
- **Lane::Mpsc é›¶åºåˆ—åŒ–**ï¼šç›´æ¥ä¼ é€’ RpcEnvelope å¯¹è±¡ï¼Œæ—  protobuf ç¼–è§£ç 
- **ç»Ÿä¸€ pending_requests æœºåˆ¶**ï¼šInproc å’Œ Outproc å…±äº«ç›¸åŒçš„ request/response åŒ¹é…é€»è¾‘
- **æ¸…æ™°åˆ†å±‚æ¶æ„**ï¼šInproc (Layer 2â†’1) / Outproc (Layer 2â†’1â†’0)
