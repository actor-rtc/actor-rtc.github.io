# actrï¼šå¼€å‘å·¥å…·é“¾

## 1. èŒè´£å®šä½

`actr` æ˜¯ actr ç”Ÿæ€ç³»ç»Ÿçš„æ ¸å¿ƒå¼€å‘å·¥å…·é“¾ï¼Œè´Ÿè´£å°†å¼€å‘è€…çš„æ„å›¾ï¼ˆ`Actr.toml`ï¼‰è½¬åŒ–ä¸ºå¯æ„å»ºã€å¯è¿è¡Œçš„ Actor é¡¹ç›®ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š
- é¡¹ç›®ç®¡ç†ï¼š`init`, `install`, `gen`, `run`
- ä»£ç ç”Ÿæˆï¼šè°ƒç”¨ `protoc-gen-actorframework` æ’ä»¶
- ä¾èµ–ç®¡ç†ï¼šç”Ÿæˆå’Œç»´æŠ¤ `actr.lock.toml`
- è„šæœ¬æ‰§è¡Œï¼šè¿è¡Œç”¨æˆ·å®šä¹‰çš„å‘½ä»¤

**è¾¹ç•Œ**ï¼š
- æ˜¯å¼€å‘è€…å·¥å…·ï¼Œä¸æ˜¯æ¡†æ¶è¿è¡Œæ—¶çš„ä¸€éƒ¨åˆ†
- ä¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘
- ä¸ç›´æ¥å‚ä¸ Actor é€šä¿¡

## 2. å‘½ä»¤æ€»è§ˆ

| å‘½ä»¤ | åŠŸèƒ½ | ä¾èµ–çš„æ ¸å¿ƒæœåŠ¡ |
|------|------|----------------|
| `actr init <name>` | åˆ›å»ºæ–°é¡¹ç›®è„šæ‰‹æ¶ | FileService |
| `actr install` | è§£æä¾èµ–ï¼Œç”Ÿæˆé”æ–‡ä»¶ | ConfigService<br/>NetworkService |
| `actr gen` | ç”Ÿæˆ Rust ä»£ç  | ConfigService<br/>CodegenService |
| `actr run [script]` | æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ | ConfigService |

## 3. æ¶æ„è®¾è®¡

### 3.1 æœåŠ¡ç»„åˆæ¶æ„

`actr` é‡‡ç”¨æœåŠ¡ç»„åˆæ¨¡å¼ï¼Œæ¯ä¸ªå‘½ä»¤é€šè¿‡ç»„åˆæ ¸å¿ƒæœåŠ¡æ¥å®ŒæˆåŠŸèƒ½ã€‚

```mermaid
graph TD
    subgraph "å‘½ä»¤å±‚"
        direction LR
        InitCmd[init]
        InstallCmd[install]
        GenCmd[gen]
        RunCmd[run]
    end

    subgraph "æ ¸å¿ƒæœåŠ¡å±‚"
        direction LR
        ConfigSvc[ConfigService]
        NetworkSvc[NetworkService]
        CodegenSvc[CodegenService]
        FileSvc[FileService]
    end

    subgraph "ä¾èµ–å±‚"
        direction LR
        Config[actr-config]
        Protocol[actr-protocol]
        Version[actr-version]
    end

    InitCmd --> FileSvc
    InstallCmd --> ConfigSvc & NetworkSvc
    GenCmd --> ConfigSvc & CodegenSvc
    RunCmd --> ConfigSvc

    ConfigSvc --> Config
    NetworkSvc --> Protocol
    CodegenSvc --> Protocol & Version
    FileSvc --> Config
```

### 3.2 æ ¸å¿ƒæœåŠ¡

#### ConfigServiceï¼ˆé…ç½®ç®¡ç†ï¼‰
- è¯»å–å’ŒéªŒè¯ `Actr.toml`
- ç®¡ç†é”æ–‡ä»¶çš„è¯»å†™
- æä¾›é…ç½®é¡¹è®¿é—®æ¥å£

#### NetworkServiceï¼ˆç½‘ç»œæ“ä½œï¼‰
- ä¸ä¿¡ä»¤æœåŠ¡å™¨é€šä¿¡
- æ‰§è¡Œ `DiscoveryRequest`, `RouteCandidatesRequest`
- å¤„ç†ç½‘ç»œè¿æ¥æ€§æ£€æŸ¥

#### CodegenServiceï¼ˆä»£ç ç”Ÿæˆï¼‰
- è°ƒç”¨ `protoc` å’Œ `protoc-gen-actorframework`
- ä½¿ç”¨ `actr-version` è®¡ç®—æœåŠ¡æŒ‡çº¹
- ç®¡ç†ç”Ÿæˆçš„ä»£ç æ–‡ä»¶

#### FileServiceï¼ˆæ–‡ä»¶æ“ä½œï¼‰
- ç”Ÿæˆé¡¹ç›®æ¨¡æ¿
- ç®¡ç†æœ¬åœ°ç¼“å­˜
- æ–‡ä»¶å¤åˆ¶å’Œç›®å½•æ“ä½œ

## 4. å‘½ä»¤è¯¦è§£

### 4.1 actr init

åˆ›å»ºæ–°é¡¹ç›®è„šæ‰‹æ¶ã€‚

**æ‰§è¡Œæµç¨‹**ï¼š
```mermaid
graph TD
    A[actr init name] --> B{æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨}
    B -->|å·²å­˜åœ¨| C[æŠ¥é”™é€€å‡º]
    B -->|ä¸å­˜åœ¨| D[åˆ›å»ºé¡¹ç›®ç›®å½•]
    D --> E[ç”Ÿæˆ Actr.toml]
    E --> F[ç”Ÿæˆ proto/ ç›®å½•å’Œç¤ºä¾‹æ–‡ä»¶]
    F --> G[ç”Ÿæˆ src/main.rs æ¨¡æ¿]
    G --> H[ç”Ÿæˆ Cargo.toml]
    H --> I[ç”Ÿæˆ .gitignore]
    I --> J[å®Œæˆ]
```

**ç”Ÿæˆçš„é¡¹ç›®ç»“æ„**ï¼š
```
<name>/
â”œâ”€â”€ Actr.toml           # é¡¹ç›®é…ç½®
â”œâ”€â”€ Cargo.toml          # Rust é¡¹ç›®é…ç½®
â”œâ”€â”€ proto/
â”‚   â””â”€â”€ echo.v1.proto   # ç¤ºä¾‹ Proto æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main.rs         # å…¥å£æ–‡ä»¶æ¨¡æ¿
â””â”€â”€ .gitignore
```

**ç¤ºä¾‹**ï¼š
```bash
$ actr init my-service
Creating project: my-service
  âœ“ Generated Actr.toml
  âœ“ Generated proto/echo.v1.proto
  âœ“ Generated src/main.rs
  âœ“ Generated Cargo.toml
Project created successfully!

$ cd my-service
$ tree
.
â”œâ”€â”€ Actr.toml
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ proto
â”‚   â””â”€â”€ echo.v1.proto
â””â”€â”€ src
    â””â”€â”€ main.rs
```

### 3.3. ä¾èµ–ç®¡ç†

#### **`actr install`**
npmé£æ ¼çš„æœåŠ¡çº§ä¾èµ–ç®¡ç† (check-first æ¶æ„)

æ­¤å‘½ä»¤é‡‡ç”¨**éªŒè¯ä¼˜å…ˆ**çš„ä¸¤é˜¶æ®µå®‰è£…æµç¨‹ï¼Œç¡®ä¿é…ç½®å®Œæ•´æ€§å’ŒåŸå­æ€§æ“ä½œï¼š

**æ¨¡å¼1ï¼šæ·»åŠ æ–°ä¾èµ– (npm install <package>)**
```bash
# æ·»åŠ æœåŠ¡ä¾èµ–ï¼ˆäº¤äº’å¼é€‰æ‹© fingerprintï¼‰
actr install acme+user-service

# æ·»åŠ ä¾èµ–å¹¶æŒ‡å®šåˆ«å
actr install my_api --actr-type acme+user-service

# ç›´æ¥æŒ‡å®š fingerprint
actr install user-service --fingerprint service_semantic:abc123...
```

**æ¨¡å¼2ï¼šå®‰è£…é…ç½®çš„ä¾èµ– (npm install)**
```bash
# å®‰è£…Actr.tomlä¸­é…ç½®çš„æ‰€æœ‰æœåŠ¡ä¾èµ–ï¼ˆä¼˜å…ˆä½¿ç”¨lockæ–‡ä»¶ä¸­çš„å·²å®‰è£…ç‰ˆæœ¬ï¼‰
actr install

# å¼ºåˆ¶æ›´æ–°æ‰€æœ‰ä¾èµ–ï¼ˆå¿½ç•¥lockæ–‡ä»¶ï¼Œé‡æ–°è§£æå’Œå®‰è£…æ‰€æœ‰ä¾èµ–ï¼‰
actr install --force-update
```

#### **ä¾èµ–æ ¼å¼æ”¯æŒ**

`actr install` å‘½ä»¤åŠ `[dependencies]` éƒ¨åˆ†æ”¯æŒçš„ä¾èµ–å£°æ˜æ ¼å¼ï¼š

1.  **ç©ºå£°æ˜ + äº¤äº’å¼é€‰æ‹©**ï¼ˆæ¨èï¼‰:
    ```bash
    actr install user-service
    ```
    å®‰è£…æœ€æ–°çš„ acme:user-service

    è¿™ä¼šåœ¨ `Actr.toml` ä¸­æ·»åŠ ï¼š
    ```toml
    [dependencies]
    user-service = {}  # ç©ºå£°æ˜ï¼Œfingerprint å†™å…¥ lock æ–‡ä»¶
    ```

2.  **ä½¿ç”¨åˆ«åå¹¶æŒ‡å®š `actr_type`**:
    ```bash
    actr install my_user_api --actr-type acme+user-service
    ```
    è¿™ä¼šç”Ÿæˆï¼š
    ```toml
    [dependencies]
    my_user_api = { actr_type = "acme+user-service" }
    ```

3.  **ç›´æ¥æŒ‡å®š fingerprint**ï¼ˆç”¨äºç²¾ç¡®é”å®šï¼‰:
    ```bash
    actr install user-service --fingerprint service_semantic:abc123...
    ```
    è¿™ä¼šç”Ÿæˆï¼š
    ```toml
    [dependencies]
    user-service = { fingerprint = "service_semantic:abc123..." }
    ```
è¿™ç§è®¾è®¡ç¡®ä¿äº†ä¾èµ–çš„å¯é‡ç°æ€§å’Œå®‰å…¨æ€§ã€‚

#### **Check-First å·¥ä½œæµç¨‹**

é‡‡ç”¨**éªŒè¯ä¼˜å…ˆ**çš„ä¸¤é˜¶æ®µæµç¨‹ï¼Œç¡®ä¿é…ç½®å®Œæ•´æ€§ï¼š

##### **ğŸ” é˜¶æ®µ1: å®Œæ•´éªŒè¯**
```bash
actr install user-service
  â”œâ”€ ğŸ“‹ è§£æä¾èµ–è§„èŒƒ
  â”œâ”€ ğŸ” æœåŠ¡å‘ç° (DiscoveryRequest)
  â”œâ”€ ğŸ¯ fingerprint é€‰æ‹©ï¼ˆäº¤äº’å¼æˆ–è‡ªåŠ¨ï¼‰
  â”œâ”€ ğŸŒ ç½‘ç»œè¿é€šæ€§æµ‹è¯• (NetworkValidator)
  â”œâ”€ ğŸ” æŒ‡çº¹å®Œæ•´æ€§éªŒè¯ (FingerprintValidator)
  â”œâ”€ âš–ï¸ ä¾èµ–å†²çªåˆ†æï¼ˆfingerprint ä¸€è‡´æ€§æ£€æŸ¥ï¼‰
  â””â”€ âœ… ç”Ÿæˆå®‰è£…è®¡åˆ’

# å¦‚æœéªŒè¯å¤±è´¥ï¼Œå‘½ä»¤åœ¨æ­¤é€€å‡ºï¼Œä¸ä¿®æ”¹ä»»ä½•æ–‡ä»¶
```

##### **ğŸ“ é˜¶æ®µ2: åŸå­æ€§å®‰è£…**
```bash
# ä»…åœ¨éªŒè¯å®Œå…¨é€šè¿‡åæ‰§è¡Œ
  â”œâ”€ ğŸ’¾ å¤‡ä»½å½“å‰é…ç½®
  â”œâ”€ ğŸ“ æ›´æ–° Actr.toml é…ç½®
  â”œâ”€ ğŸ“¦ ç¼“å­˜ proto æ–‡ä»¶
  â”œâ”€ ğŸ”’ æ›´æ–° actr.lock.toml
  â””â”€ âœ… æ¸…ç†å¤‡ä»½æ–‡ä»¶ (æˆåŠŸ) æˆ– ğŸ”„ æ¢å¤å¤‡ä»½ (å¤±è´¥)
```

##### **æ ¸å¿ƒä¼˜åŠ¿**
- âœ… **é…ç½®ä¿æŠ¤**: å¤±è´¥æ—¶ä¸ä¼šæ±¡æŸ“é…ç½®æ–‡ä»¶
- âœ… **é”™è¯¯æå‰**: åœ¨ä¿®æ”¹å‰å‘ç°æ‰€æœ‰é—®é¢˜
- âœ… **åŸå­æ“ä½œ**: è¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å›æ»š
- âœ… **å¤ç”¨éªŒè¯**: install å¤ç”¨ check å‘½ä»¤çš„éªŒè¯é€»è¾‘

#### **æ ¸å¿ƒèŒè´£**

`install` å‘½ä»¤çš„æ ¸å¿ƒæ˜¯è§£æ `Actr.toml` ä¸­çš„ `[dependencies]`ï¼Œä»ç½‘ç»œä¸­å‘ç°å¹¶è·å–åŒ¹é…çš„**æœåŠ¡çº§ä¾èµ–**ï¼Œæœ€ç»ˆå°†é€‰æ‹©çš„ä¾èµ–ç‰ˆæœ¬ç²¾ç¡®åœ°é”å®šåœ¨ `actr.lock.toml` æ–‡ä»¶ä¸­ã€‚

#### **æœåŠ¡çº§ä¾èµ–Installå·¥ä½œæµ**

å½“ `actr install` è¿è¡Œæ—¶ï¼Œå®ƒä¼šä¸ºæ¯ä¸ªæœåŠ¡çº§ä¾èµ–æ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š

1.  **æœåŠ¡å‘ç°**: é€šè¿‡å‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€ `actr.DiscoveryRequest` è·å–æœåŠ¡ç›®å½•ã€‚
    ```rust
    // è¯·æ±‚å¯ç”¨æœåŠ¡åˆ—è¡¨
    DiscoveryRequest {
        manufacturer: Some("my-org".to_string()),
        limit: Some(64),
    }
    ```

2.  **é€‰æ‹©ç­–ç•¥**: æ”¶åˆ° `DiscoveryResponse` åï¼Œæ ¹æ®è¿”å›çš„ `TypeEntries` æ‰§è¡Œæ™ºèƒ½é€‰æ‹©ã€‚
    *   **ç²¾ç¡®åŒ¹é…**: é¦–å…ˆåŒ¹é… `ActrType` ä¸é”æ–‡ä»¶ä¸­çš„æœåŠ¡ç±»å‹ã€‚
    *   **æŒ‡çº¹éªŒè¯**: å¦‚æœ `actr.lock.toml` ä¸­æŒ‡å®šäº†æŒ‡çº¹ï¼Œå¿…é¡»ç²¾ç¡®åŒ¹é… `service_fingerprint` å­—æ®µã€‚
    *   **ç‰ˆæœ¬æƒé‡**: åœ¨æ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„å®ä¾‹ä¸­ï¼Œä¼˜å…ˆé€‰æ‹©æœ€æ–°çš„å…¼å®¹ç‰ˆæœ¬ã€‚

3.  **è·¯ç”±å€™é€‰è·å–ï¼ˆå¯é€‰ï¼‰**: å¦‚æœéœ€è¦è¿›ä¸€æ­¥ç¡®å®šç›®æ ‡å®ä¾‹ï¼Œå¯å‘é€ `RouteCandidatesRequest`ã€‚
    ```rust
    // è¯·æ±‚ç‰¹å®šæœåŠ¡ç±»å‹çš„æœ€ä¼˜å®ä¾‹åˆ—è¡¨
    RouteCandidatesRequest {
        target_type: ActrType {
            manufacturer: "my-org".into(),
            name: "user-service".into(),
        },
        criteria: Some(NodeSelectionCriteria {
            candidate_count: 3,
            ranking_factors: vec![NodeRankingFactor::      BEST_DEPENDENCY_HEALTH = 2;],
            minimal_dependency_requirement: None,
            minimal_health_requirement: None,
        }),
    }
    ```

4.  **é”æ–‡ä»¶æ›´æ–°**: å°†æœ€ç»ˆé€‰å®šçš„æœåŠ¡æŒ‡çº¹å’Œå…ƒæ•°æ®å†™å…¥ `actr.lock.toml`ï¼Œç¡®ä¿æ„å»ºå¯é‡ç°æ€§ã€‚

#### **`actr discovery`**
å‘ç°ç½‘ç»œä¸­å¯ç”¨çš„ Actor æœåŠ¡ (å¤ç”¨æ¶æ„ + check-first)

```bash
# åˆ—å‡ºå‘ç°çš„æœåŠ¡
actr discovery

# å¸¦è¿‡æ»¤çš„æœåŠ¡å‘ç°
actr discovery --filter "user-*"

# æ˜¾ç¤ºè¯¦ç»†æœåŠ¡ä¿¡æ¯
actr discovery --verbose
```

**äº¤äº’å¼ç•Œé¢ï¼š**
```
ğŸ” å‘ç°çš„ Actor æœåŠ¡ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡åç§°        â”‚ Tags             â”‚ ç®€ä»‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ echo-service    â”‚ latest, stable   â”‚ ç®€å•çš„å›å£°æœåŠ¡ï¼Œç”¨äºæµ‹è¯•è¿é€šæ€§  â”‚
â”‚ chat-room       â”‚ latest           â”‚ å¤šäººèŠå¤©å®¤æœåŠ¡                  â”‚
â”‚ file-storage    â”‚ stable           â”‚ åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨æœåŠ¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†’ ä½¿ç”¨ â†‘â†“ é€‰æ‹©æœåŠ¡ï¼Œå›è½¦æŸ¥çœ‹é€‰é¡¹ï¼Œq é€€å‡º

é€‰æ‹© echo-service åçš„é€‰é¡¹ï¼š
[1] æŸ¥çœ‹æœåŠ¡è¯¦æƒ…ï¼ˆfingerprintã€å‘å¸ƒæ—¶é—´ï¼‰
[2] å¯¼å‡º proto æ–‡ä»¶
[3] æ·»åŠ åˆ°é…ç½®æ–‡ä»¶
```

##### **å¤ç”¨æ¶æ„å·¥ä½œæµ**

é€‰æ‹© "æ·»åŠ åˆ°é…ç½®æ–‡ä»¶" åçš„å®Œæ•´æµç¨‹ï¼š

1. **ğŸ“ é…ç½®æ›´æ–°**: å°†é€‰æ‹©çš„æœåŠ¡æ·»åŠ åˆ° Actr.toml
2. **ğŸ” è‡ªåŠ¨éªŒè¯**: å¤ç”¨ ConfigService.validate å’Œ NetworkService éªŒè¯é€»è¾‘
   - æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
   - ç½‘ç»œè¿é€šæ€§æµ‹è¯•
   - æŒ‡çº¹å®Œæ•´æ€§éªŒè¯
3. **âš–ï¸ å¤±è´¥å¤„ç†**: å¦‚æœéªŒè¯å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»šé…ç½®ä¿®æ”¹
4. **ğŸ¤” ç”¨æˆ·ç¡®è®¤**: è¯¢é—®æ˜¯å¦ç«‹å³å®‰è£…éªŒè¯é€šè¿‡çš„ä¾èµ–
5. **ğŸ“¦ å¯é€‰å®‰è£…**: ç»„åˆ FileService å’Œ ConfigService æ‰§è¡ŒåŸå­æ€§å®‰è£…

**ç¤ºä¾‹äº¤äº’æµç¨‹ï¼š**
```bash
âœ… å·²æ·»åŠ  echo-service åˆ°é…ç½®æ–‡ä»¶

ğŸ” æ­£åœ¨éªŒè¯æ–°ä¾èµ–...
  â”œâ”€ ğŸ“‹ æœåŠ¡å­˜åœ¨æ€§æ£€æŸ¥ âœ…
  â”œâ”€ ğŸŒ ç½‘ç»œè¿é€šæ€§æµ‹è¯• âœ…
  â””â”€ ğŸ” æŒ‡çº¹å®Œæ•´æ€§éªŒè¯ âœ…

ğŸ¤” æ˜¯å¦ç«‹å³å®‰è£…æ­¤ä¾èµ–ï¼Ÿ [y/N] y

ğŸ“¦ æ­£åœ¨å®‰è£… echo-service...
  â”œâ”€ ğŸ“¦ ç¼“å­˜ proto æ–‡ä»¶ âœ…
  â”œâ”€ ğŸ”’ æ›´æ–°é”æ–‡ä»¶ âœ…
  â””â”€ âœ… å®‰è£…å®Œæˆ

ğŸ’¡ å»ºè®®: è¿è¡Œ 'actr gen' ç”Ÿæˆæœ€æ–°ä»£ç 
```

##### **å¤ç”¨ç»„ä»¶ä¼˜åŠ¿**
- âœ… **ä¸€è‡´éªŒè¯**: ä¸ `actr check` ä½¿ç”¨ç›¸åŒçš„éªŒè¯é€»è¾‘
- âœ… **åŸå­æ“ä½œ**: ä¸ `actr install` ä½¿ç”¨ç›¸åŒçš„å®‰è£…æµç¨‹
- âœ… **é…ç½®ä¿æŠ¤**: éªŒè¯å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šï¼Œé¿å…é…ç½®æ±¡æŸ“
- âœ… **ç”¨æˆ·å‹å¥½**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œè¿›åº¦æç¤º

æ­¤åŠŸèƒ½é›†æˆäº†æœåŠ¡å‘ç°ã€éªŒè¯å’Œå®‰è£…çš„å®Œæ•´å·¥ä½œæµï¼Œä¸ºå¼€å‘è€…æä¾›ä¸€ç«™å¼çš„æœåŠ¡ä¾èµ–ç®¡ç†ä½“éªŒã€‚

### 3.4. é…ç½®ç®¡ç†

#### **`actr config`**
é¡¹ç›®é…ç½®ç®¡ç†

```bash
# è®¾ç½®é…ç½®
actr config set build.output-dir "./generated"
actr config set signaling.url "wss://signal.company.com"

# æŸ¥çœ‹é…ç½®
actr config get signaling.url
actr config list

# æŸ¥çœ‹æ‰€æœ‰é…ç½®
actr config show

# åˆ é™¤é…ç½®
actr config unset build.output-dir
```

æ­¤å‘½ä»¤ç”¨äºç®¡ç†é¡¹ç›®çº§é…ç½®ï¼Œæ”¯æŒè®¾ç½®æ„å»ºé€‰é¡¹ã€ä¿¡ä»¤æœåŠ¡å™¨åœ°å€ç­‰å¼€å‘é…ç½®ã€‚é’ˆå¯¹ä¾èµ–å®‰è£…ä¸æœåŠ¡å‘ç°ç­‰ CLI å·¥ä½œæµï¼ˆå¦‚ `actr install`/`actr discovery`ï¼‰ï¼Œå½“éœ€è¦è®¤è¯æ—¶ï¼ŒCLI ä¼šæç¤ºåœ¨ `Actr.toml` çš„ `[system.signaling]`ï¼ˆæˆ– `[signaling]` å…¼å®¹æ®µï¼‰é…ç½®è®¤è¯ä¸åœ°å€ç­‰ä¿¡æ¯ã€‚æ³¨æ„ï¼šSDK ä½œä¸ºåº“ä¸ç›´æ¥è¯»å–é…ç½®æ–‡ä»¶ï¼Œåº”ç”¨åº”åœ¨å¯åŠ¨æ—¶è‡ªè¡Œè§£æå¹¶é€šè¿‡æ„å»ºå™¨æ³¨å…¥å‡­è¯ä¸è¿æ¥å‚æ•°ã€‚

### 3.5. å¼€å‘å·¥å…·

#### **`actr check`**
é…ç½®å’Œä¾èµ–éªŒè¯å·¥å…·

```bash
# æ£€æŸ¥æ‰€æœ‰é…ç½®çš„ä¾èµ–é¡¹
actr check

# æ£€æŸ¥ç‰¹å®šä¾èµ–é¡¹
actr check user-service notification-service

# ä½¿ç”¨ç‰¹å®šé…ç½®æ–‡ä»¶
actr check --file prod.toml

# æ˜¾ç¤ºè¯¦ç»†éªŒè¯è¿‡ç¨‹
actr check --verbose

# éªŒè¯ Actr.lock.toml é”å®šä¸€è‡´æ€§
actr check --lock

# è®¾ç½®è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
actr check --timeout 10

# TODO: æ”¯æŒå¹¶è¡Œæ£€æŸ¥å‚æ•° --parallel 5
```

`actr check` é€šè¿‡ç»Ÿä¸€çš„æœåŠ¡å®¹å™¨æä¾›å¤šç»´åº¦çš„é¡¹ç›®éªŒè¯ï¼š

##### **éªŒè¯ç»´åº¦**
1.  **ç¯å¢ƒé¢„æ£€**ï¼šéªŒè¯ `Actr.toml` é…ç½®è¯­æ³•åŠä¿¡ä»¤æœåŠ¡å™¨ï¼ˆSignaling Serverï¼‰çš„å…¨å±€å¯è¾¾æ€§ã€‚
2.  **é”å®šéªŒè¯**ï¼ˆå¯é€‰ï¼‰ï¼šé€šè¿‡ `--lock` å‚æ•°ç¡®ä¿æœ¬åœ°é…ç½®ä¸ `Actr.lock.toml` è®°å½•çš„æŒ‡çº¹å®Œå…¨ä¸€è‡´ï¼Œé˜²æ­¢éé¢„æœŸçš„ä¾èµ–æ¼‚ç§»ã€‚
3.  **æœåŠ¡å‘ç°ä¸ç½‘ç»œéªŒè¯**ï¼š
    - **å­˜åœ¨æ€§ç¡®è®¤**ï¼šéªŒè¯ä¾èµ–æœåŠ¡æ˜¯å¦å·²åœ¨ä¿¡ä»¤ç½‘ç»œä¸­æ³¨å†Œã€‚
    - **è¿é€šæ€§æµ‹è¯•**ï¼šæ‰§è¡Œç«¯åˆ°ç«¯çš„ç½‘ç»œé“¾è·¯è´¨é‡æ¢æµ‹ã€‚
4.  **æŒ‡çº¹æ·±åº¦æ ¡éªŒ**ï¼šé€šè¿‡ `FingerprintValidator` éªŒè¯è¿œç¨‹æœåŠ¡çš„è¯­ä¹‰æŒ‡çº¹æ˜¯å¦ç¬¦åˆæœ¬åœ° proto å®šä¹‰çš„å¥‘çº¦ã€‚

##### **æ ¸å¿ƒç»„ä»¶æ¶æ„**
`actr check` æ·±åº¦é›†æˆä»¥ä¸‹å¤ç”¨ç»„ä»¶ï¼š
- `ConfigManager`: å¤„ç†é…ç½®æ–‡ä»¶åŠ è½½ä¸è¯­æ³•éªŒè¯ã€‚
- `DependencyResolver`: è§£æå¤æ‚çš„ç‰ˆæœ¬ä¸æŒ‡çº¹ä¾èµ–å…³ç³»ã€‚
- `ServiceDiscovery`: è´Ÿè´£åœ¨ä¿¡ä»¤ç½‘ç»œä¸­å®šä½ç›®æ ‡æœåŠ¡ã€‚
- `NetworkValidator`: æ‰§è¡Œä½å»¶è¿Ÿçš„ç½‘ç»œè¿é€šæ€§æµ‹è¯•ã€‚
- `FingerprintValidator`: è¿›è¡ŒåŸºäºè¯­ä¹‰çš„åŠ å¯†æŒ‡çº¹æ¯”å¯¹ã€‚

##### **ä¸å…¶ä»–å‘½ä»¤çš„å…³ç³»**
- `actr install`: **å¤ç”¨**ç›¸åŒçš„é…ç½®å’Œç½‘ç»œéªŒè¯æœåŠ¡ï¼Œåœ¨å®‰è£…å‰è¿›è¡ŒéªŒè¯
- `actr discovery`: **æ‰©å±•**ç½‘ç»œæœåŠ¡ï¼Œæ·»åŠ äº¤äº’å¼æœåŠ¡é€‰æ‹©
- `config test`: **å­é›†**ï¼Œä»…éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•ï¼Œä¸æ¶‰åŠç½‘ç»œéªŒè¯

**ä½¿ç”¨åœºæ™¯**ï¼š
- éƒ¨ç½²å‰ç¯å¢ƒéªŒè¯
- ç½‘ç»œè¿æ¥é—®é¢˜è¯Šæ–­  
- æƒé™é…ç½®éªŒè¯
- CI/CDç®¡é“ä¸­çš„ä¾èµ–æ£€æŸ¥

#### **`actr doc`**
ç”Ÿæˆé¡¹ç›®æ–‡æ¡£

```bash
# ç”Ÿæˆæ–‡æ¡£
actr doc

# æŒ‡å®šè¾“å‡ºç›®å½•
actr doc --output ./docs
```

æ­¤å‘½ä»¤é’ˆå¯¹ actr é¡¹ç›®ç»“æ„ç”Ÿæˆæ–‡æ¡£ï¼Œç”Ÿæˆå›ºå®šçš„ HTML æ–‡ä»¶ï¼š
- `index.html` - é¡¹ç›®æ¦‚è§ˆï¼ˆåŒ…å«è‡ªåŠ¨ç”Ÿæˆçš„é¡¹ç›®ç»“æ„æ ‘ï¼‰
- `api.html` - API æ¥å£æ–‡æ¡£ï¼ˆåŸºäº proto å®šä¹‰ï¼‰
- `config.html` - é…ç½®è¯´æ˜ï¼ˆå±•ç¤ºå½“å‰ Actr.toml çŠ¶æ€ï¼‰

**æ™ºèƒ½ç‰¹æ€§ï¼š**
- **å¤šè¯­è¨€ç»“æ„è¯†åˆ«**ï¼šè‡ªåŠ¨æ„ŸçŸ¥ Rust, Swift, Kotlin, Python ç¯å¢ƒï¼Œå¹¶å±•ç¤ºå¯¹åº”çš„å·¥ç¨‹ç›®å½•è§„èŒƒã€‚
- **å…ƒæ•°æ®æå–**ï¼šè‡ªåŠ¨ä» `Cargo.toml`, `project.yml`, `build.gradle` æˆ– `pyproject.toml` ä¸­æå–é¡¹ç›®ç‰ˆæœ¬å·ï¼Œç¡®ä¿æ–‡æ¡£ä¿¡æ¯ä¸ä»£ç åŒæ­¥ã€‚


### 3.6. é«˜çº§å·¥å…·

#### **`actr fingerprint`**
è®¡ç®—é¡¹ç›®å’ŒæœåŠ¡æŒ‡çº¹

```bash
# è®¡ç®—å½“å‰é¡¹ç›®æŒ‡çº¹
actr fingerprint

# è®¡ç®—ç‰¹å®šprotoæ–‡ä»¶æŒ‡çº¹
actr fingerprint --proto path/to/service.proto

# è¾“å‡ºJSONæ ¼å¼
actr fingerprint --format json

# è®¡ç®—æœåŠ¡çº§æŒ‡çº¹
actr fingerprint --service-level
```

æ­¤å‘½ä»¤ç”¨äºè®¡ç®—å’ŒéªŒè¯é¡¹ç›®çš„åŠ å¯†æŒ‡çº¹ï¼Œæ”¯æŒï¼š
- **Proto çº§æŒ‡çº¹**: åŸºäº proto-sign è¯­ä¹‰è§£æçš„å†…å®¹æŒ‡çº¹ï¼ˆæ ¼å¼: `semantic:hash`ï¼‰
- **æœåŠ¡çº§æŒ‡çº¹**: åŸºäºè¯­ä¹‰æŒ‡çº¹çš„ç¡®å®šæ€§ç»„åˆå“ˆå¸Œï¼ˆæ ¼å¼: `service_semantic:hash`ï¼‰
- **å¤šç§è¾“å‡ºæ ¼å¼**: text, json, yaml
- **æŒ‡çº¹éªŒè¯**: ä¸ç¼“å­˜æŒ‡çº¹å¯¹æ¯”éªŒè¯ä¸€è‡´æ€§


---

## 2.x åˆ«åå‘½åè§„èŒƒä¸å†²çªå¤„ç†

ä¸ºç¡®ä¿ä»£ç ç”Ÿæˆåœ¨ Context ä¸Šçš„å®¢æˆ·ç«¯æ–¹æ³•å…·å¤‡ç¨³å®šã€å¯é¢„æµ‹çš„å‘½åï¼Œactr å¯¹ä¾èµ–åˆ«å alias é‡‡ç”¨å¼ºçº¦æŸï¼š

- å¿…é¡»æ˜¾å¼æŒ‡å®šåˆ«åï¼šæ¯ä¸ªä¾èµ–éƒ½éœ€è¦åœ¨ Actr.toml çš„ [dependencies] ä¸‹ä»¥â€œé”®â€ä¸ºåˆ«åè¿›è¡Œå£°æ˜ã€‚
- åˆ«åå”¯ä¸€ï¼šåŒä¸€é¡¹ç›®å†…åˆ«åå…¨å±€å”¯ä¸€ï¼Œå¦‚é‡å¤å°†ç›´æ¥åœ¨é…ç½®é˜¶æ®µæŠ¥é”™å¹¶ä¸­æ­¢ã€‚
- æ–¹æ³•åå³åˆ«åï¼šContext ä¸Šç”Ÿæˆçš„å®¢æˆ·ç«¯æ–¹æ³•åä¸¥æ ¼ç­‰äºåˆ«åï¼Œä¸åšé¢å¤–è§„èŒƒåŒ–/é‡å‘½åï¼ˆä¾‹å¦‚åˆ«å user_api -> ctx.user_api()ï¼‰ã€‚

åˆ«ååˆæ³•æ€§æ ¡éªŒ
- è¯­æ³•çº¦æŸï¼ˆæ­£åˆ™ï¼‰ï¼š^[a-zA-Z_][a-zA-Z0-9_]*$
- ä¸å…è®¸åŒ…å«ä¸å¯è§å­—ç¬¦ï¼ˆé›¶å®½ã€æ§åˆ¶å­—ç¬¦ç­‰ï¼‰
- é•¿åº¦å»ºè®®ï¼š<= 64 ä¸ªå­—ç¬¦ï¼ˆè¶…å‡ºå°†ç»™å‡ºè­¦å‘Šï¼‰

ä¿ç•™åä¸æ¡†æ¶ API å†²çª
- ä¸å…è®¸ä¸æ¡†æ¶/ä¸Šä¸‹æ–‡å·²æœ‰æ–¹æ³•åæˆ–ä¿ç•™åå†²çªï¼Œä¾‹å¦‚ï¼šcall, tell, start, stop, run, logger, config, runtime, attach, claim, echo_client ç­‰
- ä¸å…è®¸ä¸ Rust å…³é”®å­—/ä¿ç•™åå†²çªï¼Œä¾‹å¦‚ï¼šfn, mod, type, async, await, match, self, super, crate ç­‰
- ä¸€æ—¦å†²çªï¼ŒCLI ç›´æ¥æŠ¥é”™å¹¶ç»™å‡ºä¿®æ”¹å»ºè®®ï¼ˆè¯·æ›´æ¢åˆ«åï¼‰

å¤§å°å†™ä¸å¹³å°æç¤º
- åˆ«åæ¯”å¯¹åŒºåˆ†å¤§å°å†™ï¼›ä½†åœ¨å¤§å°å†™ä¸æ•æ„Ÿå¹³å°ï¼ˆå¦‚éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿï¼‰ä¸Šä¼šé™„åŠ è­¦å‘Šï¼šä»…å¤§å°å†™ä¸åŒçš„åˆ«åå¯èƒ½é€ æˆåç»­å·¥å…·/æ¨¡å—åå†²çªï¼Œè¯·è°ƒæ•´ä¸ºæ˜¾å¼ä¸åŒçš„åç§°

é”™è¯¯ä¸æç¤ºç¤ºä¾‹
- Duplicate alias: 'user_api' already exists. Please choose a unique alias.
- Illegal alias: 'user-api' does not match ^[a-zA-Z_][a-zA-Z0-9_]*$.
- Reserved name: alias 'call' conflicts with framework API. Please choose a different alias.

ç”Ÿæˆç‰©ç¨³å®šæ€§
- å› ä¸ºâ€œæ–¹æ³•åå³åˆ«åâ€ï¼Œä¸€æ—¦ä¿®æ”¹åˆ«åå°†å¯¼è‡´è°ƒç”¨ç«¯ä»£ç åŒæ­¥æ›´æ–°ï¼›å»ºè®®åœ¨å›¢é˜Ÿå†…çº¦å®šå‘½åè§„èŒƒï¼ˆsnake_caseï¼Œæ˜ç¡®è¯­ä¹‰ï¼‰å¹¶å°½é‡ä¿æŒç¨³å®š

ç‰¹åˆ«è¯´æ˜ï¼šä¸å†éœ€è¦å¤„ç†çš„å†²çªç±»å‹
- ç”±äºåˆ«åæ˜¯å¼ºåˆ¶å”¯ä¸€ä¸”ä¸åšè§„èŒƒåŒ–ï¼Œä»¥ä¸‹å†å²å¸¸è§å†²çªä¸å†å‡ºç°ï¼š
  - å¤šæœåŠ¡åè§„èŒƒåŒ–ååŒåï¼ˆä¾‹å¦‚ UserService ä¸ user-serviceï¼‰
  - åˆ«åä¸æœåŠ¡åè§„èŒƒåŒ–å†²çª
  - ç”±è‡ªåŠ¨æ¶ˆæ­§ï¼ˆè¿½åŠ å‚å•†åç¼€/ç¼–å·ï¼‰å¯¼è‡´çš„ä¸ç¨³å®šå‘½å

---

## 3. æ ¸å¿ƒæœºåˆ¶ä¸ç›¸å…³æ–‡ä»¶

`actr` çš„å·¥ä½œæµå›´ç»•ç€å‡ ä¸ªæ ¸å¿ƒæœºåˆ¶å’Œæ–‡ä»¶å±•å¼€ã€‚

### 3.1. æœåŠ¡æŒ‡çº¹ (Service Fingerprint)

ä¸ºäº†è®©æœåŠ¡ç½‘ç»œä¸­çš„æ¯ä¸€ä¸ª Actor éƒ½æœ‰ä¸€ä¸ªå¯éªŒè¯çš„èº«ä»½æ ‡è¯†ï¼Œ`actr gen` å‘½ä»¤ä¼šå¼•å…¥"æœåŠ¡æŒ‡çº¹"æœºåˆ¶ã€‚

*   **å®šä¹‰**: ä¸€ä¸ª Actor çš„"æœåŠ¡æŒ‡çº¹"æ˜¯ä¸€ä¸ª**åŸºäºè¯­ä¹‰æŒ‡çº¹çš„ç¡®å®šæ€§ç»„åˆå“ˆå¸Œ**ï¼Œå®ƒæ ¹æ® `Actr.toml` ä¸­ `exports` å­—æ®µçš„æ‰€æœ‰ proto æ–‡ä»¶å†…å®¹æ¥è®¡ç®—ã€‚
*   **ä½œç”¨**: ç”¨äºæœåŠ¡æ³¨å†Œã€ç²¾ç¡®å‘ç°å’Œå…¼å®¹æ€§åå•†ã€‚
*   **è®¡ç®—æ–¹å¼**:
    1. å¯¹æ¯ä¸ª proto æ–‡ä»¶ä½¿ç”¨ `proto-sign` è®¡ç®—è¯­ä¹‰æŒ‡çº¹ï¼ˆå¿½ç•¥æ ¼å¼å·®å¼‚ï¼‰
    2. å°†æ‰€æœ‰æ–‡ä»¶çš„è¯­ä¹‰æŒ‡çº¹æŒ‰æ–‡ä»¶åæ’åºç»„åˆ
    3. å¯¹ç»„åˆç»“æœè®¡ç®— SHA256ï¼Œå¾—åˆ°æœåŠ¡çº§æŒ‡çº¹
    4. æ ¼å¼: `service_semantic:{sha256-hash}`

### 3.2. ä¾èµ–é”å®š (`actr.lock.toml`)

`actr install` å‘½ä»¤çš„äº§ç‰©ï¼Œç¡®ä¿äº†ä¾èµ–çš„ä¸€è‡´æ€§å’Œæ„å»ºçš„å¯é‡ç°æ€§ã€‚å®ƒè®°å½•äº†æ‰€æœ‰**æœåŠ¡çº§ä¾èµ–**çš„ç²¾ç¡®æ¥æºã€ç‰ˆæœ¬å’ŒæŒ‡çº¹ã€‚è¯¥æ–‡ä»¶**åº”æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶**ã€‚

```toml
# actr.lock.toml (æœåŠ¡çº§ä¾èµ–é”å®š)
# This file is auto-generated by `actr install`. DO NOT EDIT.

[metadata]
version = 1
generated_at = "2024-01-15T10:30:00Z"

[[dependency]]
name = "user-service"
actr_type = "acme+user-service"
description = "User management service"
fingerprint = "service_semantic:a1b2c3d4e5f6..."  # åŸºäºè¯­ä¹‰æŒ‡çº¹çš„ç»„åˆå“ˆå¸Œï¼ˆä¸»è¦æ ‡è¯†ç¬¦ï¼‰
published_at = 1705315800  # å‘å¸ƒæ—¶é—´æˆ³
tags = ["latest", "stable"]
cached_at = "2024-01-15T10:30:00Z"

  [[dependency.files]]
  path = "user-service/user.v1.proto"
  fingerprint = "semantic:abc123..."

  [[dependency.files]]
  path = "user-service/common.v1.proto"
  fingerprint = "semantic:def456..."

[[dependency]]
name = "notification-service"
actr_type = "acme+notification-service"
description = "Notification service"
fingerprint = "service_semantic:b7c8d9e0f1a2..."
published_at = 1705315860
tags = ["latest"]
cached_at = "2024-01-15T10:31:00Z"

  [[dependency.files]]
  path = "notification-service/notification.v1.proto"
  fingerprint = "semantic:ghi789..."
```

### 3.3. è¿è¡Œæ—¶åå•†ç¼“å­˜ (`compat.lock.toml`)

VCS ç­–ç•¥ï¼šä¸åº”æäº¤åˆ°ç‰ˆæœ¬åº“ï¼ˆSHOULD NOTï¼‰ï¼Œè¯·åœ¨é¡¹ç›®æ¨¡æ¿çš„ .gitignore ä¸­åŒ…å« `compat.lock.toml`ã€‚

è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œç”¨äºè®°å½•å’Œåæ˜ ç³»ç»Ÿçš„è¿è¡Œæ—¶çŠ¶æ€ï¼Œå®ƒçš„è®¾è®¡å“²å­¦ä¸ `actr.lock.toml` å®Œå…¨ä¸åŒã€‚

*   **æ€§è´¨**: ä¸€ä¸ªä¸´æ—¶çš„**è¿è¡Œæ—¶çŠ¶æ€ç¼“å­˜**ä¸**å®¡è®¡æ—¥å¿—**ã€‚
*   **ä½ç½®ä¸å‘½å**: ç”± SDK åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºäº**æ“ä½œç³»ç»Ÿçš„ä¸´æ—¶ç›®å½•**ä¸­ã€‚ä¸ºäº†é˜²æ­¢åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œå¤šä¸ª Actor æ—¶äº§ç”Ÿå†²çªï¼ŒSDK ä¼šæ ¹æ®é¡¹ç›®æ ¹ç›®å½•çš„ç»å¯¹è·¯å¾„ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„å“ˆå¸Œå€¼ (`project_hash`)ï¼Œå¹¶ä»¥æ­¤åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„å­ç›®å½•æ¥å­˜æ”¾è¯¥æ–‡ä»¶ã€‚
    *   **ç¤ºä¾‹è·¯å¾„ (Linux)**: `/tmp/actr/<project_hash>/compat.lock`
    *   è¿™ç§è®¾è®¡ç¡®ä¿äº†æ¯ä¸ª Actor å®ä¾‹éƒ½æœ‰å…¶ç‹¬ç«‹çš„è¿è¡Œæ—¶ç¼“å­˜ï¼ŒåŒæ—¶é¿å…äº†æ±¡æŸ“é¡¹ç›®ç›®å½•æˆ–éœ€è¦ç‰¹æ®Šæ–‡ä»¶æƒé™ã€‚
*   **ç”Ÿå‘½å‘¨æœŸ**:
    *   **åˆ›å»º**: å½“ SDK åœ¨è¿è¡Œæ—¶æ— æ³•æ‰¾åˆ°æŒ‡çº¹å®Œå…¨åŒ¹é…çš„æœåŠ¡ï¼Œä½†æˆåŠŸåå•†å¹¶è¿æ¥åˆ°ä¸€ä¸ªå‘åå…¼å®¹çš„ç‰ˆæœ¬æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ­¤æ–‡ä»¶ã€‚
    *   **è¯»å–**: å½“ Actor è¿›ç¨‹é‡å¯æ—¶ï¼ŒSDK ä¼šå°è¯•è¯»å–æ­¤æ–‡ä»¶ä»¥åŠ é€Ÿä¸‹ä¸€æ¬¡è¿æ¥ï¼Œé¿å…é‡æ–°è¿›è¡Œå®Œæ•´çš„æœåŠ¡å‘ç°å’Œåå•†æµç¨‹ã€‚
    *   **æ¸…ç†**: æ­¤æ–‡ä»¶æ˜¯çŸ­æš‚çš„ (ephemeral)ï¼Œå¯èƒ½ä¼šåœ¨ç³»ç»Ÿé‡å¯æ—¶è¢«æ“ä½œç³»ç»Ÿæ¸…ç†ã€‚SDK å¿…é¡»èƒ½ä¼˜é›…å¤„ç†æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µï¼ˆåªéœ€é‡æ–°åå•†å³å¯ï¼‰ã€‚
*   **æ ¸å¿ƒç”¨é€”**:
    1.  **ä½œä¸ºå‘Šè­¦ä¿¡å·**: å®ƒçš„**å­˜åœ¨**æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ˜ç¡®çš„**â€œäºšå¥åº·â€æˆ–â€œæŠ€æœ¯å€ºâ€**ä¿¡å·ã€‚è¿ç»´ç›‘æ§ç³»ç»Ÿåº”è¯¥é…ç½®å‘Šè­¦ï¼Œä¸€æ—¦å‘ç°æ­¤æ–‡ä»¶ï¼Œå°±åº”é€šçŸ¥å¼€å‘å›¢é˜Ÿè¿›è¡Œå¹²é¢„ã€‚
    2.  **ä½œä¸ºå®¡è®¡æ—¥å¿—**: æ–‡ä»¶å†…å®¹è®°å½•äº†è¯·æ±‚çš„æŒ‡çº¹å’Œå®é™…è¿æ¥çš„æŒ‡çº¹ï¼Œä¸ºé—®é¢˜æ’æŸ¥æä¾›äº†çº¿ç´¢ã€‚
    3.  **ä½œä¸ºé‡å¯ç¼“å­˜**: åœ¨ä¸€ä¸ªâ€œäºšå¥åº·â€çš„ç³»ç»Ÿè¢«ä¿®å¤ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ `actr install --update` å¹¶é‡æ–°éƒ¨ç½²ï¼‰ä¹‹å‰ï¼Œå®ƒå¯ä»¥å¸®åŠ©ä¸ç¨³å®šçš„æœåŠ¡åœ¨é‡å¯åæ›´å¿«åœ°æ¢å¤è¿æ¥ã€‚
*   **ç‰ˆæœ¬æ§åˆ¶**: **ç»å¯¹ä¸åº”è¯¥**è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œ`compat.lock.toml` æ˜¯ä¸€ä¸ªåº”æ€¥å’Œç›‘æ§æœºåˆ¶ã€‚å®ƒé€šè¿‡ç‰ºç‰²ç‰ˆæœ¬çš„ç²¾ç¡®åŒ¹é…æ¥ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§ï¼ŒåŒæ—¶ç•™ä¸‹æ¸…æ™°çš„ç—•è¿¹ï¼Œç£ä¿ƒå¼€å‘è€…å°½å¿«ä¿®å¤åº•å±‚çš„ç‰ˆæœ¬ä¸ä¸€è‡´é—®é¢˜ã€‚

### 3.4. é…ç½®è¯»å–æ‘˜è¦

ä¸ºäº†æ¸…æ™°åœ°å±•ç¤º CLI ä¸ SDK çš„èŒè´£ï¼Œä¸‹è¡¨æ€»ç»“äº†ä¸åŒç»„ä»¶åœ¨ä¸åŒé˜¶æ®µå¯¹é…ç½®æ–‡ä»¶çš„è¯»å–æƒ…å†µï¼š

| é…ç½®æ–‡ä»¶ | TOML éƒ¨åˆ† | æ„å»ºæ—¶ (CLI) | å¯åŠ¨æ—¶ (SDK) |
| :--- | :--- | :--- | :--- |
| `Actr.toml` | `[package]` | âœ… è¯»å– `name` ç”¨äºäº§ç‰©å‘½å | âŒ |
| | `exports` | âœ… è¯»å–ä»¥è®¡ç®—æœåŠ¡æŒ‡çº¹ | âŒ |
| | `[dependencies]`| âœ… è¯»å–ä»¥æ‰§è¡Œ `install` | âŒ |
| | `[scripts]` | âœ… è¯»å–ä»¥æ‰§è¡Œ `build`/`run` | âŒ |
| | `[system.signaling]` | âŒ | âœ… è¯»å–ä»¥è¿æ¥ä¿¡ä»¤æœåŠ¡ |
| `actr.lock.toml` | (å…¨éƒ¨) | âœ… è¯»å–ä»¥è·å–ä¾èµ–çš„ç²¾ç¡®æŒ‡çº¹ | âŒ |
| `compat.lock.toml` | (å…¨éƒ¨) | âŒ | âœ… è¯»/å†™ä»¥ç¼“å­˜åå•†ç»“æœ |

> **æ³¨**ï¼šåœ¨â€œåº“æ¨¡å¼â€ä¸‹ï¼ŒSDK è¿è¡Œæ—¶æœ¬èº«ä¸ç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿè¯»å– `Actr.toml`ã€‚å¼€å‘è€…éœ€è¦åœ¨ `main.rs` ä¸­è‡ªè¡Œè§£æé…ç½®æ–‡ä»¶ï¼Œå¹¶é€šè¿‡æ„å»ºå™¨æ¨¡å¼å°†é…ç½®æ³¨å…¥ `ActrSystem`ã€‚

---

## 4. ä¿¡ä»¤åè®®ä¸æœåŠ¡å‘ç°æœºåˆ¶

### 4.1. DiscoveryRequest ä¸æœåŠ¡ç›®å½•

æœåŠ¡å‘ç°ä¸ä¾èµ–ç®¡ç†å®Œå…¨åŸºäº `actr-protocol/proto/signaling.proto` ä¸­å®šä¹‰çš„æ¶ˆæ¯ã€‚`actr` é€šè¿‡å‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€ `actr.DiscoveryRequest` å’Œ `actr.RouteCandidatesRequest` ç­‰æ¶ˆæ¯ï¼Œè·å–æ‰€éœ€çš„æœåŠ¡ç›®å½•å’Œè·¯ç”±å€™é€‰ã€‚

#### **DiscoveryRequest æ¶ˆæ¯ç»“æ„**

```protobuf
message DiscoveryRequest {
  optional string manufacturer = 1;
  optional uint32 limit = 2 [default = 64];
}

message DiscoveryResponse {
  message DiscoveryOk {
    message TypeEntry {
      required ActrType actr_type = 1;
      optional string description = 2;
      required string service_fingerprint = 3;
      optional int64 published_at = 4;
      repeated string tags = 5;
    }
    repeated TypeEntry entries = 1;
  }

  oneof result {
    DiscoveryOk success = 1;
    ErrorResponse error = 2;
  }
}
```

> **æ³¨æ„**ï¼šä¿¡ä»¤æœåŠ¡å™¨è¿”å›çš„ `DiscoveryOk` æ¶ˆæ¯ä¸­åŒ…å«äº† `entries` åˆ—è¡¨ï¼Œå…¶ä¸­æœ‰æœåŠ¡ç±»å‹ã€æŒ‡çº¹ã€å‘å¸ƒæ—¶é—´å’Œæ ‡ç­¾ä¿¡æ¯ã€‚`actr` ä½¿ç”¨è¿™äº›ä¿¡æ¯è¿›è¡Œä¾èµ–è§£æï¼Œæ”¯æŒäº¤äº’å¼é€‰æ‹©æˆ–è‡ªåŠ¨é€‰æ‹© `latest` æ ‡ç­¾çš„æœåŠ¡ã€‚

#### **RouteCandidatesRequest æ¶ˆæ¯ç»“æ„**

åœ¨æ‰§è¡Œè·¯ç”±é€‰æ‹©æ—¶ï¼ŒCLI ä¼šåœ¨ç¡®è®¤ç›®æ ‡æœåŠ¡ç±»å‹åï¼Œå†å‘ä¿¡ä»¤æœåŠ¡å™¨å‘é€ `RouteCandidatesRequest`ï¼Œä»¥è·å–æœ€ä¼˜çš„æœåŠ¡å®ä¾‹å€™é€‰åˆ—è¡¨ã€‚

```protobuf
message RouteCandidatesRequest {
  message NodeSelectionCriteria {
    enum ServiceDependencyState {
      HEALTHY = 0;
      WARNING = 1;
      BROKEN = 2;
    }

    required uint32 candidate_count = 1;
    repeated NodeRankingFactor ranking_factors = 2;
    optional ServiceDependencyState minimal_dependency_requirement = 3;
    optional ServiceAvailabilityState minimal_health_requirement = 4;
  }
  required ActrType target_type = 1;
  optional NodeSelectionCriteria criteria = 2;
}
```

é€šè¿‡è¿™ç»„æ¶ˆæ¯çš„ç»„åˆï¼ŒCLI å¯ä»¥å…ˆå‘ç°æ‰€æœ‰å¯ç”¨çš„æœåŠ¡ç±»å‹ï¼Œå†åœ¨å¿…è¦æ—¶è¿›ä¸€æ­¥ç­›é€‰ã€é€‰æ‹©æœ€åˆé€‚çš„å…·ä½“å®ä¾‹ï¼Œå®ŒæˆæœåŠ¡ä¾èµ–ç®¡ç†çš„å…¨æµç¨‹ã€‚

### 4.2. æœåŠ¡çº§è¯­ä¹‰æŒ‡çº¹è®¡ç®—

æœåŠ¡æŒ‡çº¹åŸºäºæ‰€æœ‰ proto æ–‡ä»¶çš„**è¯­ä¹‰æŒ‡çº¹**è®¡ç®—ç»„åˆå“ˆå¸Œï¼ˆä¸¥æ ¼éµå¾ª [actr-version](https://github.com/actor-rtc/actr-version) å®šä¹‰ï¼‰ï¼š

```rust
// åŸºäºè¯­ä¹‰æŒ‡çº¹è®¡ç®—æœåŠ¡çº§æŒ‡çº¹ï¼ˆä½¿ç”¨ actr-versionï¼‰
use actr_version::Fingerprint;

pub fn calculate_service_fingerprint(proto_files: &[ProtoFile]) -> Result<String> {
    // ç›´æ¥ä½¿ç”¨ actr-version æä¾›çš„æ ‡å‡†å®ç°
    Fingerprint::calculate_service_semantic_fingerprint(proto_files)
}

// ä»¥ä¸‹æ˜¯ actr-version çš„å®ç°é€»è¾‘ï¼ˆä¾›å‚è€ƒï¼‰ï¼š
fn calculate_service_semantic_fingerprint_impl(proto_files: &[ProtoFile]) -> Result<String> {
    // 1. æŒ‰æ–‡ä»¶åæ’åºç¡®ä¿ç¡®å®šæ€§
    let mut sorted_files = proto_files.to_vec();
    sorted_files.sort_by(|a, b| a.name.cmp(&b.name));

    // 2. ä¸ºæ¯ä¸ªæ–‡ä»¶è®¡ç®—è¯­ä¹‰æŒ‡çº¹ï¼ˆä½¿ç”¨ proto-signï¼‰
    let mut semantic_fingerprints = Vec::new();
    for file in &sorted_files {
        let spec = proto_sign::Spec::try_from(file.content.as_str())?;
        // æ ¼å¼: filename:semantic-fingerprint
        semantic_fingerprints.push(format!("{}:{}", file.name, spec.fingerprint));
    }

    // 3. ç»„åˆæ‰€æœ‰è¯­ä¹‰æŒ‡çº¹å¹¶è®¡ç®— SHA256
    let combined = semantic_fingerprints.join("\n");
    let hash = sha2::Sha256::digest(combined.as_bytes());
    Ok(format!("service_semantic:{:x}", hash))
}
```

---

## 5. ä»£ç ç”Ÿæˆå™¨æ’ä»¶

### 5.1 protoc-gen-actorframework

ä½äº `actr/protoc-gen-actorframework/`ï¼Œæ˜¯ protoc çš„æ’ä»¶ã€‚

**å·¥ä½œåŸç†**ï¼š
```mermaid
graph TD
    A[protoc] --> B[è§£æ .proto æ–‡ä»¶]
    B --> C[ç”Ÿæˆ FileDescriptorSet]
    C --> D[protoc-gen-actorframework]
    D --> E[åˆ†æ service å’Œ message]
    E --> F[ç”ŸæˆæœåŠ¡ Handler Trait]
    F --> G[ç”Ÿæˆ MessageHandler blanket impl]
    G --> H[ç”Ÿæˆ Workload blanket impl]
    H --> I[ç”Ÿæˆ WorkloadRouting ZST]
    I --> J[ç”Ÿæˆ Context æ‰©å±•æ–¹æ³•]
    J --> K[è¾“å‡º Rust ä»£ç ]
```

**ç”Ÿæˆçš„ä»£ç ç¤ºä¾‹**ï¼š

è¾“å…¥ Protoï¼š
```protobuf
service EchoService {
    rpc Echo(EchoRequest) returns (EchoResponse);
}
```

ç”Ÿæˆçš„ Rust ä»£ç ï¼š
```rust
// 1. Message Trait å®ç°ï¼ˆè¯·æ±‚-å“åº”ç±»å‹å…³è”ï¼‰
impl Message for EchoRequest {
    type Response = EchoResponse;
}

// 2. æœåŠ¡ Handler Trait å®šä¹‰ï¼ˆç”¨æˆ·å®ç°çš„æ¥å£ï¼‰
#[async_trait]
pub trait EchoServiceHandler: Send + Sync + 'static {
    async fn echo(
        &self,
        req: EchoRequest,
        ctx: &Context
    ) -> ActorResult<EchoResponse>;
}

// 3. MessageHandler<M> blanket implï¼ˆæ¡¥æ¥å±‚ï¼‰
#[async_trait]
impl<T: EchoServiceHandler> MessageHandler<EchoRequest> for T {
    async fn handle(&self, msg: EchoRequest, ctx: &Context) -> ActorResult<EchoResponse> {
        self.echo(msg, ctx).await
    }
}

// 4. Workload blanket implï¼ˆæ ‡è¯†å·¥ä½œå•å…ƒï¼‰
impl<T: EchoServiceHandler> Workload for T {
    type Routing = EchoServiceRouting;

    fn claim(&self) -> ActrType {
        // ä» Actr.toml è¯»å–
        ActrType::from_config()
    }
}

// 5. WorkloadRouting ZST å®ç°ï¼ˆè·¯ç”±é…ç½®å™¨ï¼‰
pub struct EchoServiceRouting;

impl<T: EchoServiceHandler> WorkloadRouting<T> for EchoServiceRouting {
    fn configure(workload: Arc<T>, registry: &mut HandlerRegistry) {
        // æ³¨å†Œæ‰€æœ‰ RPC æ–¹æ³•çš„ MessageHandler
        registry.register::<EchoRequest, T>(workload.clone());
        // å¦‚æœæœ‰æ›´å¤š RPC æ–¹æ³•ï¼Œç»§ç»­æ³¨å†Œ...
    }
}

// 6. Context æ‰©å±•æ–¹æ³•ï¼ˆå®¢æˆ·ç«¯è°ƒç”¨ï¼‰
impl Context {
    pub fn echo_client(&self) -> echo_client::EchoServiceClient {
        // è¿”å›ç±»å‹å®‰å…¨çš„å®¢æˆ·ç«¯å®ä¾‹
        echo_client::EchoServiceClient::new(self.clone())
    }
}
```
