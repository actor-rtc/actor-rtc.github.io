# **ä¸“é¢˜è§£æï¼šè‡ªåŠ¨æµç»‘å®š â€” ä¼˜é›…çš„å¿«è½¦é“API**

> **âš ï¸ å®ç°çŠ¶æ€è¯´æ˜**ï¼šå½“å‰ç‰ˆæœ¬ä¸­ï¼Œ**æ¥æ”¶æ–¹æµ (Server Streaming)** åŠŸèƒ½å·²å®Œå…¨å®ç°ã€‚**å¯¹ç­‰æ–¹æµ**å’Œ**åŒå‘æµ**åŠŸèƒ½å°šåœ¨å¼€å‘ä¸­ã€‚
> 
> **ğŸ“ æœ¯è¯­è¯´æ˜**ï¼šWebRTC æœ¬è´¨ä¸Šæ˜¯å¯¹ç­‰ç½‘ç»œï¼Œä¸ä¸¥æ ¼åŒºåˆ†"æ¥æ”¶æ–¹"/"å¯¹ç­‰æ–¹"ã€‚è¿™é‡Œçš„æœ¯è¯­æ˜¯ä»å…·ä½“ä¸šåŠ¡è§’è‰²è§’åº¦æè¿°çš„ï¼šæµçš„**å‘èµ·è€…**vs**æ¥æ”¶è€…**ï¼Œä½†åº•å±‚éƒ½æ˜¯å»ºç«‹åœ¨ ActrNode/Peer åŸºç¡€ä¸Šçš„å¯¹ç­‰è¿æ¥ã€‚

### **è®¾è®¡æƒè¡¡ï¼šé€æ˜æ€§ vs. ä¾¿åˆ©æ€§**

åœ¨æ ¸å¿ƒæ¶æ„ä¸­ï¼Œæˆ‘ä»¬å¼ºè°ƒäº†â€œçŠ¶æ€è·¯å¾„â€ä¸â€œå¿«è½¦é“â€çš„æ˜ç¡®åˆ†ç¦»ã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šæµå¼åœºæ™¯ä¸‹ï¼Œå¼€å‘è€…æ€»æ˜¯éœ€è¦é‡å¤ç¼–å†™â€œå‘é€ä¸€ä¸ª `OpenStream` æ§åˆ¶ä¿¡ä»¤ -> æ³¨å†Œå›è°ƒ -> å¼€å§‹ä¼ è¾“æ•°æ®â€çš„æ ·æ¿ä»£ç ã€‚

ä¸ºäº†æå‡å¼€å‘è€…ä½“éªŒï¼Œæ¡†æ¶åœ¨ä¸¥æ ¼çš„åº•å±‚æœºåˆ¶ä¹‹ä¸Šï¼Œæä¾›äº†ä¸€å¥—æ›´é«˜çº§ã€æ›´ä¾¿æ·çš„â€œè‡ªåŠ¨æµç»‘å®šâ€åŠŸèƒ½ã€‚

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œæ­¤åŠŸèƒ½å¹¶éå¯¹åŒè·¯å¾„æ ¸å¿ƒåŸåˆ™çš„ç ´åï¼Œè€Œæ˜¯å…¶ä¸Šå±‚çš„ä¸€ä¸ªä¾¿åˆ©å°è£…ã€‚å®ƒå°† `3.8 å¿«è½¦é“å†…æ ¸` ä¸­æè¿°çš„æ‰‹åŠ¨æ¨¡å¼è‡ªåŠ¨åŒ–ï¼Œæ—¨åœ¨ä¸ºæœ€å¸¸è§çš„ç”¨ä¾‹æä¾›é›¶é…ç½®çš„ã€ç¬¦åˆç›´è§‰çš„é»˜è®¤è¡Œä¸ºï¼Œè®©å¼€å‘è€…èƒ½æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘æœ¬èº«ã€‚

é‡è¦çº¦æŸï¼š
- è‡ªåŠ¨æµç»‘å®šä¸ä¼šåˆ›å»ºæ–°çš„ Lane å®ä¾‹ã€‚æ ¹æ®ç»Ÿä¸€çº¦æŸï¼ŒSignal/Reliable/Latency-First ä¸º 0 æˆ– 1 æ¡ï¼ˆOptionï¼‰ï¼ŒMediaTrack å¯å¤šæ¡ï¼ˆVecï¼‰ã€‚è‡ªåŠ¨ç»‘å®šåœ¨æ—¢æœ‰ Lane ä¸Šè¿›è¡Œå¤šè·¯å¤ç”¨ï¼ˆlogical stream_idï¼‰ï¼Œä¸æ”¹å˜ Lane æ¡æ•°ã€‚
- é¦–æ¬¡è°ƒç”¨è§¦å‘çš„å†…éƒ¨æ¡æ‰‹ç»ç”±â€œçŠ¶æ€è·¯å¾„â€ï¼Œå¹¶åœ¨ä¿¡ä»¤/ACL çº¦æŸå†…æ‰§è¡Œï¼›ä¸ä¼šåœ¨ DataChannel å»ºç«‹å‰èµ°æ•°æ®é¢ã€‚
- èµ„æº/ä¼šè¯ç”±æ¡†æ¶åˆ†é… stream_id å¹¶ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œåº”ç”¨å¯é€šè¿‡æ³¨è§£å¾®è°ƒé»˜è®¤è¡Œä¸ºï¼ˆQoS/ä¼˜å…ˆçº§/é™é€Ÿç­‰ï¼‰ã€‚

æœ¬ç¯‡æ–‡æ¡£å°†æ·±å…¥æ¢è®¨è¿™ä¸€é«˜çº§ç‰¹æ€§ã€‚

### 1. è®¾è®¡å“²å­¦ï¼šâ€œçº¦å®šä¼˜äºé…ç½®â€

æœ¬ç‰¹æ€§çš„æ ¸å¿ƒè®¾è®¡å“²å­¦æ˜¯â€œ**çº¦å®šä¼˜äºé…ç½® (Convention over Configuration)**â€ã€‚æˆ‘ä»¬æ—¨åœ¨ä¸ºæœ€å¸¸è§çš„ç”¨ä¾‹æä¾›é›¶é…ç½®çš„ã€ç¬¦åˆç›´è§‰çš„é»˜è®¤è¡Œä¸ºï¼ŒåŒæ—¶ä¸ºç½•è§çš„ä¾‹å¤–æƒ…å†µæä¾›æ˜ç¡®çš„é…ç½®é€‰é¡¹ã€‚

*   **çº¦å®š (Convention)**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•åœ¨ `.proto` æ–‡ä»¶ä¸­ä½¿ç”¨äº† `stream` å…³é”®å­—çš„ RPC æ–¹æ³•ï¼Œéƒ½å°†è¢«æ¡†æ¶**è‡ªåŠ¨è§†ä¸ºä¸€ä¸ªå¿«è½¦é“æµ**ï¼Œå¹¶ä¸ºå…¶è‡ªåŠ¨åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
*   **é…ç½® (Configuration)**ï¼šå¦‚æœå¼€å‘è€…ç¡®å®éœ€è¦ä¸€ä¸ªæµå¼ RPC ä¿è¯ä¸¥æ ¼çš„é¡ºåºï¼ˆå³é€šè¿‡â€œçŠ¶æ€è·¯å¾„â€å¤„ç†ï¼‰ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ª Protobuf è‡ªå®šä¹‰é€‰é¡¹æ¥**æ˜¾å¼åœ°è¦†ç›–**è¿™ä¸ªé»˜è®¤è¡Œä¸ºã€‚

### 2. æœºåˆ¶è¯¦è§£

#### 2.1. çº¦å®šï¼š`stream` å…³é”®å­—ä½œä¸ºé»˜è®¤è§¦å‘å™¨

åœ¨æœ€å¸¸è§çš„æƒ…å†µä¸‹ï¼Œå¼€å‘è€…åªéœ€åƒå®šä¹‰æ™®é€š gRPC æµå¼æœåŠ¡ä¸€æ ·å®šä¹‰ `.proto` æ–‡ä»¶å³å¯ã€‚

**`proto/media_service.proto`**
```protobuf
syntax = "proto2";
package media;

message VideoChunk { optional bytes data = 1; }
message StreamingStatus { optional bool success = 1; }

service MediaStreamer {
  // çº¦å®šï¼šå› ä¸ºå…¥å‚æ˜¯ stream ç±»å‹ï¼Œæ¡†æ¶å°†è‡ªåŠ¨å°†å…¶ç»‘å®šåˆ°å¿«è½¦é“ã€‚
  rpc UploadVideo(stream VideoChunk) returns (StreamingStatus);
}
```
å½“å¯¹ç­‰æ–¹è°ƒç”¨ `UploadVideo` æ—¶ï¼Œå¼€å‘è€…æ— éœ€å†æ‰‹åŠ¨ç¼–å†™ `OpenStream` ä¹‹ç±»çš„ RPCã€‚æ¡†æ¶ä¼šè‡ªåŠ¨è¯†åˆ«è¿™æ˜¯ä¸€ä¸ªéœ€è¦è‡ªåŠ¨ç»‘å®šçš„å¿«è½¦é“æµã€‚

#### 2.2. é…ç½®ï¼š`force_state_path` é€‰é¡¹ä½œä¸ºä¾‹å¤–

å¯¹äºéœ€è¦èµ°çŠ¶æ€è·¯å¾„çš„ç‰¹æ®Šæµï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªéœ€è¦ä¸æ ¸å¿ƒçŠ¶æ€è¿›è¡ŒåŸå­æ€§äº¤äº’çš„å‘½ä»¤æµï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é€‰é¡¹æ¥è¦†ç›–é»˜è®¤çº¦å®šã€‚

**ç¬¬ä¸€æ­¥ï¼šå®šä¹‰é€‰é¡¹ (`proto/framework_options.proto`)**
```protobuf
syntax = "proto2";
package actor_framework.options;
import "google/protobuf/descriptor.proto";

extend google.protobuf.MethodOptions {
  // å½“è®¾ä¸º true æ—¶ï¼Œå³ä½¿æ˜¯ stream RPC ä¹Ÿå¼ºåˆ¶å…¶èµ° State Path
  optional bool force_state_path = 50001;
}
```

**ç¬¬äºŒæ­¥ï¼šåœ¨ä¸šåŠ¡ proto ä¸­ä½¿ç”¨**
```protobuf
syntax = "proto2";
package admin;
import "framework_options.proto";

message AdminCommand { optional string command = 1; }
message CommandResult { optional string result = 1; }

service AdminService {
  // é…ç½®ï¼šè¿™æ˜¯ä¸€ä¸ªæµï¼Œä½†æˆ‘ä»¬å¼ºåˆ¶å®ƒèµ°çŠ¶æ€è·¯å¾„ä»¥ä¿è¯ä¸¥æ ¼é¡ºåº
  rpc ExecuteCommandStream(stream AdminCommand) returns (CommandResult) {
    option (actor_framework.options.force_state_path) = true;
  }
}
```

#### 2.3. æ¡†æ¶çš„è‡ªåŠ¨åŒ–å·¥ä½œæµ

å½“ä¸€ä¸ªè¢«çº¦å®šä¸ºè‡ªåŠ¨ç»‘å®šçš„æµï¼ˆå¦‚ `UploadVideo`ï¼‰ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œæ¡†æ¶åœ¨å¹•åä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant ClientSDK as å¯¹ç­‰æ–¹ SDK
    participant ServerFramework as æ¥æ”¶æ–¹æ¡†æ¶
    participant FastPathRegistry as å¿«è½¦é“æ³¨å†Œè¡¨
    participant ActorLogic as Actor ä¸šåŠ¡é€»è¾‘

    ClientSDK->>ServerFramework: 1. [State Path] å‘é€å†…éƒ¨ OpenStream(target=UploadVideo)
    ServerFramework->>ServerFramework: 2. ç”Ÿæˆ stream_id
    ServerFramework->>FastPathRegistry: 3. æ³¨å†Œ "UploadVideo" çš„å¤„ç†å™¨åˆ° stream_id
    ServerFramework-->>ClientSDK: 4. [State Path] è¿”å› stream_id

    loop æ•°æ®ä¼ è¾“
        ClientSDK->>ServerFramework: 5. [Fast Path] å‘é€ VideoChunk + stream_id
        ServerFramework->>FastPathRegistry: 6. æŒ‰ stream_id æŸ¥æ‰¾
        FastPathRegistry->>ActorLogic: 7. ç›´æ¥è°ƒç”¨å·²æ³¨å†Œçš„ "UploadVideo" é€»è¾‘
    end
```

1.  **æ‹¦æˆªä¸æ¡æ‰‹**: å¯¹ç­‰æ–¹ SDK æ‹¦æˆªç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œè‡ªåŠ¨é€šè¿‡â€œçŠ¶æ€è·¯å¾„â€å‘é€ä¸€ä¸ªå†…éƒ¨çš„ã€å¯¹ç”¨æˆ·é€æ˜çš„ `OpenStream` ä¿¡ä»¤ã€‚æ­¤ä¿¡ä»¤ä¸­åŒ…å«äº†å®ƒçœŸæ­£æƒ³è¦è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åã€‚
2.  **è‡ªåŠ¨æ³¨å†Œ**: æ¥æ”¶æ–¹æ¡†æ¶æ¥æ”¶åˆ°è¿™ä¸ªå†…éƒ¨ä¿¡ä»¤åï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª `stream_id`ï¼Œå¹¶ä»å¤„ç†å™¨æ³¨å†Œè¡¨ä¸­æ‰¾åˆ°ç›®æ ‡æ–¹æ³•çš„å¤„ç†å™¨ï¼Œç„¶åå°† `stream_id` å’Œè¯¥å¤„ç†å™¨æ³¨å†Œåˆ°"å¿«è½¦é“æ³¨å†Œè¡¨"ä¸­ã€‚
3.  **å¼€å§‹ä¼ è¾“**: æ¥æ”¶æ–¹å°† `stream_id` è¿”å›ç»™å¯¹ç­‰æ–¹ã€‚ä¹‹åï¼Œå¯¹ç­‰æ–¹SDK å°±å¼€å§‹é€šè¿‡â€œå¿«è½¦é“â€å‘é€æ‰€æœ‰å®é™…çš„æ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å—éƒ½æºå¸¦ç€è¿™ä¸ª `stream_id`ï¼Œä»è€Œè¢«æ­£ç¡®åœ°ç›´æ¥æ´¾å‘åˆ°ä¸šåŠ¡é€»è¾‘ã€‚

### 3. å¼€å‘è€…ä½“éªŒä¸æ”¶ç›Š

é€šè¿‡â€œè‡ªåŠ¨æµç»‘å®šâ€ï¼Œå¼€å‘è€…çš„å¿ƒæ™ºè´Ÿæ‹…è¢«æå¤§å‡è½»ï¼š

*   **ä¹‹å‰ (æ‰‹åŠ¨æ¨¡å¼)**: å¼€å‘è€…éœ€è¦æ€è€ƒå¹¶å®ç° `OpenStream` -> `SendData` -> `CloseStream` çš„å®Œæ•´çŠ¶æ€æœºã€‚
*   **ç°åœ¨ (è‡ªåŠ¨æ¨¡å¼)**: å¼€å‘è€…åªéœ€åœ¨ `Actor` ä¸­å®ç° `UploadVideo` çš„æµå¤„ç†é€»è¾‘å³å¯ï¼Œä»¿ä½›åœ¨å†™ä¸€ä¸ªæ™®é€šçš„ RPC æ–¹æ³•ã€‚æµçš„åˆ›å»ºã€ç®¡ç†å’Œé”€æ¯å®Œå…¨ç”±æ¡†æ¶è´Ÿè´£ã€‚

è¿™ä¸ªæœºåˆ¶æ˜¯å®ç° `2.1 åª’ä½“æºä¸è½¨é“` ä¸­ `client.publish(track)` è¿™ç§é«˜çº§å£°æ˜å¼ API çš„å…³é”®åŸºçŸ³ã€‚

### 4. åº”ç”¨å®ä¾‹ï¼šä¸‰ç§æµæ¨¡å¼çš„å®ç°å‰–æ

â€œè‡ªåŠ¨æµç»‘å®šâ€æœºåˆ¶å¯ä»¥æå¤§åœ°ç®€åŒ–æ‰€æœ‰ gRPC æµæ¨¡å¼çš„å¼€å‘ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¢è®¨ä¸‰ç§å…¸å‹æµæ¨¡å¼çš„å®ç°ï¼Œç”±ç®€åˆ°ç¹ã€‚

#### 4.1. æ¨¡å¼ä¸€ï¼šå¯¹ç­‰æ–¹æµ (Client Streaming)

è¿™æ˜¯æœ€ç®€å•çš„æµæ¨¡å¼ï¼Œå…¸å‹åœºæ™¯æ˜¯**æ–‡ä»¶ä¸Šä¼ **ã€‚å¯¹ç­‰æ–¹æŒç»­å‘é€æ•°æ®æµï¼Œæ¥æ”¶æ–¹æ¥æ”¶å¤„ç†ï¼Œå¹¶åœ¨æµç»“æŸåè¿”å›ä¸€ä¸ª**å•ä¸€çš„å“åº”**ã€‚

*   **.proto å®šä¹‰**:
    ```protobuf
    service FileService {
      rpc UploadFile(stream FileChunk) returns (UploadStatus);
    }
    ```
*   **æ¥æ”¶æ–¹ Actor å®ç°**:
    **æ³¨æ„ï¼šå¯¹ç­‰æ–¹æµåŠŸèƒ½å½“å‰å°šæœªå®ç°**ã€‚ä»£ç ç”Ÿæˆå™¨ä¸ºæ­¤ç±»æ–¹æ³•ç”Ÿæˆå ä½ç¬¦å®ç°ï¼š
    # ä¸“é¢˜è§£æï¼šè‡ªåŠ¨æµç»‘å®š

### 1. è®¾è®¡å“²å­¦ï¼šâ€œçº¦å®šä¼˜äºé…ç½®â€

æœ¬ç‰¹æ€§çš„æ ¸å¿ƒè®¾è®¡å“²å­¦æ˜¯â€œ**çº¦å®šä¼˜äºé…ç½® (Convention over Configuration)**â€ã€‚

*   **çº¦å®š (Convention)**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•åœ¨ `.proto` æ–‡ä»¶ä¸­ä½¿ç”¨äº† `stream` å…³é”®å­—çš„ RPC æ–¹æ³•ï¼Œéƒ½å°†è¢«æ¡†æ¶**è‡ªåŠ¨è§†ä¸ºä¸€ä¸ªå¿«è½¦é“æµ**ï¼Œå¹¶ä¸ºå…¶è‡ªåŠ¨åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
*   **é…ç½® (Configuration)**ï¼šå¦‚æœå¼€å‘è€…éœ€è¦ä¸€ä¸ªæµå¼ RPC ä¿è¯ä¸¥æ ¼çš„é¡ºåºï¼ˆå³é€šè¿‡â€œçŠ¶æ€è·¯å¾„â€å¤„ç†ï¼‰ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ª Protobuf è‡ªå®šä¹‰é€‰é¡¹æ¥**æ˜¾å¼åœ°è¦†ç›–**è¿™ä¸ªé»˜è®¤è¡Œä¸ºã€‚

### 2. æœºåˆ¶è¯¦è§£

#### 2.1. çº¦å®šï¼š`stream` å…³é”®å­—ä½œä¸ºé»˜è®¤è§¦å‘å™¨

å¼€å‘è€…åªéœ€åƒå®šä¹‰æ™®é€š gRPC æµå¼æœåŠ¡ä¸€æ ·å®šä¹‰ `.proto` æ–‡ä»¶å³å¯ã€‚

**`proto/media_service.proto`**
```protobuf
syntax = "proto2";
package media;

message VideoChunk { optional bytes data = 1; }
message StreamingStatus { optional bool success = 1; }

service MediaStreamer {
  // çº¦å®šï¼šå› ä¸ºå…¥å‚æ˜¯ stream ç±»å‹ï¼Œæ¡†æ¶å°†è‡ªåŠ¨å°†å…¶ç»‘å®šåˆ°å¿«è½¦é“ã€‚
  rpc UploadVideo(stream VideoChunk) returns (StreamingStatus);
}
```
å½“å¯¹ç­‰æ–¹è°ƒç”¨ `UploadVideo` æ—¶ï¼Œå¼€å‘è€…æ— éœ€å†æ‰‹åŠ¨ç¼–å†™ `OpenStream` ä¹‹ç±»çš„ RPCã€‚æ¡†æ¶ä¼šè‡ªåŠ¨è¯†åˆ«è¿™æ˜¯ä¸€ä¸ªéœ€è¦è‡ªåŠ¨ç»‘å®šçš„å¿«è½¦é“æµã€‚

#### 2.2. æ¡†æ¶çš„è‡ªåŠ¨åŒ–å·¥ä½œæµ

å½“ä¸€ä¸ªè¢«çº¦å®šä¸ºè‡ªåŠ¨ç»‘å®šçš„æµï¼ˆå¦‚ `UploadVideo`ï¼‰ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œæ¡†æ¶åœ¨å¹•åä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant ClientSDK as å¯¹ç­‰æ–¹ SDK
    participant ServerFramework as æ¥æ”¶æ–¹æ¡†æ¶
    participant FastPathRegistry as å¿«è½¦é“æ³¨å†Œè¡¨
    participant ActorLogic as Actor ä¸šåŠ¡é€»è¾‘

    ClientSDK->>ServerFramework: 1. [State Path] å‘é€å†…éƒ¨ OpenStream(target=UploadVideo)
    ServerFramework->>ServerFramework: 2. ç”Ÿæˆ stream_id
    ServerFramework->>FastPathRegistry: 3. æ³¨å†Œ "UploadVideo" çš„å¤„ç†å™¨åˆ° stream_id
    ServerFramework-->>ClientSDK: 4. [State Path] è¿”å› stream_id

    loop æ•°æ®ä¼ è¾“
        ClientSDK->>ServerFramework: 5. [Fast Path] å‘é€ VideoChunk + stream_id
        ServerFramework->>FastPathRegistry: 6. æŒ‰ stream_id æŸ¥æ‰¾
        FastPathRegistry->>ActorLogic: 7. ç›´æ¥è°ƒç”¨å·²æ³¨å†Œçš„ "UploadVideo" é€»è¾‘
    end
```

1.  **æ‹¦æˆªä¸æ¡æ‰‹**: å¯¹ç­‰æ–¹ SDK æ‹¦æˆªç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œè‡ªåŠ¨é€šè¿‡â€œçŠ¶æ€è·¯å¾„â€å‘é€ä¸€ä¸ªå†…éƒ¨çš„ã€å¯¹ç”¨æˆ·é€æ˜çš„ `OpenStream` ä¿¡ä»¤ã€‚
2.  **è‡ªåŠ¨æ³¨å†Œ**: æ¥æ”¶æ–¹æ¡†æ¶æ¥æ”¶åˆ°è¿™ä¸ªå†…éƒ¨ä¿¡ä»¤åï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª `stream_id`ï¼Œå¹¶ä»å¤„ç†å™¨æ³¨å†Œè¡¨ä¸­æ‰¾åˆ°ç›®æ ‡æ–¹æ³•çš„å¤„ç†å™¨ï¼Œç„¶åå°† `stream_id` å’Œè¯¥å¤„ç†å™¨æ³¨å†Œåˆ°"å¿«è½¦é“æ³¨å†Œè¡¨"ä¸­ã€‚
3.  **å¼€å§‹ä¼ è¾“**: æ¥æ”¶æ–¹å°† `stream_id` è¿”å›ç»™å¯¹ç­‰æ–¹ã€‚ä¹‹åï¼Œå¯¹ç­‰æ–¹ SDK å°±å¼€å§‹é€šè¿‡â€œå¿«è½¦é“â€å‘é€æ‰€æœ‰å®é™…çš„æ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å—éƒ½æºå¸¦ç€è¿™ä¸ª `stream_id`ï¼Œä»è€Œè¢«æ­£ç¡®åœ°ç›´æ¥æ´¾å‘åˆ°ä¸šåŠ¡é€»è¾‘ã€‚

### 3. åº”ç”¨å®ä¾‹ï¼šæµæ•°æ®å‘é€æ–¹ (Data Producer Streaming)

ç›®å‰ï¼Œ**æµæ•°æ®å‘é€æ–¹ (Data Producer Streaming)** åŠŸèƒ½å·²å®Œå…¨å®ç°ã€‚å…¸å‹åœºæ™¯æ˜¯**è§†é¢‘æ’­æ”¾**æˆ–**æ—¥å¿—è®¢é˜…**ï¼šæ¥æ”¶æ–¹å‘é€è¯·æ±‚ï¼Œå‘é€æ–¹è¿”å›æ•°æ®æµã€‚

*   **.proto å®šä¹‰**:
    ```protobuf
    service VideoService {
      rpc PlayVideo(PlayRequest) returns (stream VideoChunk);
    }
    ```
*   **å‘é€æ–¹ Actor å®ç°**ï¼š
    è¿™ç§å®ç°éœ€è¦åˆ›å»ºä¸€ä¸ªå†…å­˜é€šé“ (`mpsc::channel`)ã€‚Actor åœ¨ä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡ä¸­å°†æ•°æ®å†™å…¥é€šé“ï¼Œç„¶åå°†é€šé“çš„â€œæ¥æ”¶ç«¯â€ä½œä¸ºæµè¿”å›ç»™å¯¹ç­‰æ–¹ã€‚
    ```rust
    use tokio::sync::mpsc;
    use tokio_stream::wrappers::ReceiverStream;
    use std::time::Duration;

    #[async_trait]
    impl IVideoService for MyVideoActor {
        // è¿™é‡Œçš„ Self::PlayVideoStream æ˜¯ç”±æ¡†æ¶ä»£ç ç”Ÿæˆå™¨è‡ªåŠ¨ç”Ÿæˆçš„å…³è”ç±»å‹
        type PlayVideoStream = std::pin::Pin<Box<dyn futures_util::Stream<Item = actr_rtc_framework::error::ActorResult<VideoChunk>> + Send>>;

        async fn play_video(
            &self,
            request: PlayRequest,
            context: std::sync::Arc<actor_rtc_framework::context::Context>,
        ) -> actr_rtc_framework::error::ActorResult<Self::PlayVideoStream> {
            
            let (tx, rx) = mpsc::channel(128); // 1. åˆ›å»ºä¸€ä¸ªå†…å­˜é€šé“

            tokio::spawn(async move {
                // 2. åœ¨ä¸€ä¸ªæ–°ä»»åŠ¡ä¸­ï¼Œå‡†å¤‡è¦å‘é€çš„æ•°æ®
                for i in 0..10 {
                    let chunk = VideoChunk { data: format!("chunk-{}", i).into_bytes() };
                    // 3. å°†æ•°æ®å—å‘é€åˆ°é€šé“
                    if tx.send(Ok(chunk)).await.is_err() {
                        // å‘é€å¤±è´¥ï¼Œè¯´æ˜å¯¹ç­‰æ–¹å·²ç»æ–­å¼€è¿æ¥
                        break;
                    }
                    tokio::time::sleep(Duration::from_millis(100)).await; // æ¨¡æ‹Ÿè€—æ—¶
                }
            });

            // 4. å°†é€šé“çš„æ¥æ”¶ç«¯åŒ…è£…æˆæµå¹¶è¿”å›
            let output_stream = ReceiverStream::new(rx);
            Ok(Box::pin(output_stream) as Self::PlayVideoStream)
        }
    }
    ```

### 4. å·²è§„åˆ’çš„åŠŸèƒ½

å¯¹**å¯¹ç­‰æ–¹æµ (Client Streaming)** å’Œ**åŒå‘æµ (Bi-directional Streaming)** çš„æ”¯æŒå·²åœ¨è§„åˆ’ä¸­ï¼Œå°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­æä¾›ã€‚

### 5. æ€»ç»“

â€œè‡ªåŠ¨æµç»‘å®šâ€æ˜¯æ¡†æ¶â€œå¼€å‘è€…ä½“éªŒä¼˜å…ˆâ€è®¾è®¡å“²å­¦çš„é‡è¦ä½“ç°ã€‚å®ƒé€šè¿‡â€œçº¦å®šä¼˜äºé…ç½®â€çš„åŸåˆ™ï¼Œå°†åº•å±‚çš„å¿«è½¦é“æœºåˆ¶è¿›è¡Œäº†è‡ªåŠ¨åŒ–å°è£…ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥ä»ç¹ççš„æµç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸­è§£æ”¾å‡ºæ¥ï¼Œæ›´ä¸“æ³¨äºä¸šåŠ¡åŠŸèƒ½çš„å®ç°ã€‚

    
    **æœªæ¥å®ç°æ—¶çš„é¢„æœŸæ¥å£**ï¼š
    ```rust
    // TODO: å¯¹ç­‰æ–¹æµåŠŸèƒ½å½“å‰å°šæœªå®ç°ã€‚æ­¤ä¸ºé¢„æœŸçš„ API è®¾è®¡ï¼Œå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æä¾›ã€‚
    async fn upload_file(
        &self,
        stream: impl futures_util::Stream<Item = FileChunk>,
        context: std::sync::Arc<actor_rtc_framework::context::Context>,
    ) -> actor_rtc_framework::error::ActorResult<UploadStatus> {
        // å¤„ç†æµæ•°æ®çš„é€»è¾‘
    }
    ```

#### 4.2. æ¨¡å¼äºŒï¼šæ¥æ”¶æ–¹æµ (Server Streaming)

å…¸å‹åœºæ™¯æ˜¯**è§†é¢‘æ’­æ”¾**æˆ–**æ—¥å¿—è®¢é˜…**ã€‚å¯¹ç­‰æ–¹å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œæ¥æ”¶æ–¹è¿”å›ä¸€ä¸ªæ•°æ®æµã€‚

*   **.proto å®šä¹‰**:
    ```protobuf
    service VideoService {
      rpc PlayVideo(PlayRequest) returns (stream VideoChunk);
    }
    ```
*   **æ¥æ”¶æ–¹ Actor å®ç°**:
    è¿™ç§å®ç°éœ€è¦åˆ›å»ºä¸€ä¸ªå†…å­˜é€šé“ (`mpsc::channel`)ã€‚Actor åœ¨ä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡ä¸­å°†æ•°æ®å†™å…¥é€šé“ï¼Œç„¶åå°†é€šé“çš„â€œæ¥æ”¶ç«¯â€ä½œä¸ºæµè¿”å›ç»™å¯¹ç­‰æ–¹ã€‚
    ```rust
    use tokio::sync::mpsc;
    use tokio_stream::wrappers::ReceiverStream;
    use std::time::Duration;

    #[async_trait]
    impl IVideoService for MyVideoActor {
        // è¿™é‡Œçš„ Self::PlayVideoStream æ˜¯ç”±æ¡†æ¶ä»£ç ç”Ÿæˆå™¨è‡ªåŠ¨ç”Ÿæˆçš„å…³è”ç±»å‹
        type PlayVideoStream = std::pin::Pin<Box<dyn futures_util::Stream<Item = actor_rtc_framework::error::ActorResult<VideoChunk>> + Send>>;

        async fn play_video(
            &self,
            request: PlayRequest,
            context: std::sync::Arc<actor_rtc_framework::context::Context>,
        ) -> actor_rtc_framework::error::ActorResult<Self::PlayVideoStream> {
            
            let (tx, rx) = mpsc::channel(128); // 1. åˆ›å»ºä¸€ä¸ªå†…å­˜é€šé“

            tokio::spawn(async move {
                // 2. åœ¨ä¸€ä¸ªæ–°ä»»åŠ¡ä¸­ï¼Œå‡†å¤‡è¦å‘é€çš„æ•°æ®
                for i in 0..10 {
                    let chunk = VideoChunk { data: format!("chunk-{}", i).into_bytes() };
                    // 3. å°†æ•°æ®å—å‘é€åˆ°é€šé“
                    if tx.send(Ok(chunk)).await.is_err() {
                        // å‘é€å¤±è´¥ï¼Œè¯´æ˜å¯¹ç­‰æ–¹å·²ç»æ–­å¼€è¿æ¥
                        break;
                    }
                    tokio::time::sleep(Duration::from_millis(100)).await; // æ¨¡æ‹Ÿè€—æ—¶
                }
            });

            // 4. å°†é€šé“çš„æ¥æ”¶ç«¯åŒ…è£…æˆæµå¹¶è¿”å›
            let output_stream = ReceiverStream::new(rx);
            Ok(Box::pin(output_stream) as Self::PlayVideoStream)
        }
    }
    ```

#### 4.3. æ¨¡å¼ä¸‰ï¼šåŒå‘æµ (Bi-directional Streaming)

è¿™æ˜¯æœ€å¤æ‚çš„æ¨¡å¼ï¼Œå¯¹ç­‰æ–¹å’Œæ¥æ”¶æ–¹å¯ä»¥åŒæ—¶ã€ç‹¬ç«‹åœ°å‘å¯¹æ–¹å‘é€æ•°æ®æµã€‚è¿™åœ¨éœ€è¦å®æ—¶äº¤äº’çš„åœºæ™¯ä¸­å¾ˆå¸¸è§ï¼Œæ¯”å¦‚ä¸€ä¸ªéœ€è¦æ¥æ”¶ RTP åŒ…ã€åŒæ—¶å‘é€ RTCP æ§åˆ¶åŒ…çš„åª’ä½“æœåŠ¡ã€‚

*   **.proto å®šä¹‰**:
    ```protobuf
    service MediaPlane {
      rpc HandleTrack(stream RtpPacket) returns (stream RtcpPacket);
    }
    ```
*   **æ¥æ”¶æ–¹ Actor å®ç°**:
    å®ƒçš„å®ç°æ˜¯æ¨¡å¼ä¸€å’Œæ¨¡å¼äºŒçš„ç»“åˆï¼šæ—¢è¦å¤„ç†ä¸€ä¸ªè¾“å…¥æµï¼Œåˆè¦åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµã€‚
    ```rust
    use tokio::sync::mpsc;
    use tokio_stream::wrappers::ReceiverStream;

    #[async_trait]
    impl IMediaPlane for MyMediaActor {
        async fn handle_track(
            &self, 
            _request: RtpPacket,
            _context: std::sync::Arc<actor_rtc_framework::context::Context>,
        ) -> actor_rtc_framework::error::ActorResult<RtcpPacket> {
            // åŒå‘æµåŠŸèƒ½å°šæœªå®ç°
            Err(actor_rtc_framework::error::ActorError::Protocol(
                "Streaming method not yet implemented".to_string()
            ))
        }
    }
    ```

### 5. æ€»ç»“

â€œè‡ªåŠ¨æµç»‘å®šâ€æ˜¯æ¡†æ¶â€œå¼€å‘è€…ä½“éªŒä¼˜å…ˆâ€è®¾è®¡å“²å­¦çš„é‡è¦ä½“ç°ã€‚å®ƒå¹¶æ²¡æœ‰å‘æ˜æ–°çš„åº•å±‚æŠ€æœ¯ï¼Œè€Œæ˜¯å·§å¦™åœ°è¿ç”¨â€œçº¦å®šä¼˜äºé…ç½®â€çš„åŸåˆ™ï¼Œå°† `3.8` å’Œ `3.10` ä¸­æè¿°çš„åº•å±‚å¿«è½¦é“æœºåˆ¶è¿›è¡Œäº†è‡ªåŠ¨åŒ–å°è£…ã€‚

è¿™ä½¿å¾—å¼€å‘è€…å¯ä»¥ä»ç¹ççš„æµç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸­è§£æ”¾å‡ºæ¥ï¼Œæ›´ä¸“æ³¨äºä¸šåŠ¡åŠŸèƒ½çš„å®ç°ï¼Œä»è€Œåœ¨ä¸æŸå¤±æ€§èƒ½çš„å‰æä¸‹ï¼Œè·å¾—æ›´ä¼˜é›…ã€æ›´ç®€æ´çš„ç¼–ç¨‹æ¨¡å‹ã€‚
