# **ä¸“é¢˜è§£æä¹‹äºŒï¼š`Input Handler` çš„è‰ºæœ¯ â€” æµé‡åˆ†è¯Šä¸å‹åŠ›ä¼ å¯¼**

> **âš ï¸ å®ç°çŠ¶æ€**ï¼š
> - âœ… **å·²å®ç°**ï¼šWebRtcGate æ¶ˆæ¯è·¯ç”±ï¼ˆåŸºäº PayloadTypeï¼‰
> - âš ï¸ **æ¦‚å¿µæ˜ å°„**ï¼šæ–‡æ¡£ä¸­çš„ "Input Handler" æ¦‚å¿µåœ¨ä»£ç ä¸­ç”± `WebRtcGate`ï¼ˆè·¨è¿›ç¨‹ï¼‰ä¸ `ActrNode` ä¸­çš„ Inproc æ¥æ”¶å¾ªç¯å…±åŒå®Œæˆ
> - ğŸ“‹ **è§„åˆ’ä¸­**ï¼šç»Ÿä¸€çš„èƒŒå‹æœºåˆ¶
>
> æœ¬æ–‡æ¡£æè¿°å…¥ç«™æ¶ˆæ¯å¤„ç†çš„è®¾è®¡ç†å¿µï¼Œå…·ä½“å®ç°ç»†èŠ‚è¯·å‚è€ƒ `WebRtcGate` æºç ã€‚

> [!WARNING]
> **ä¸“å®¶ç‰¹æ€§ï¼šè¯·è°¨æ…ä¿®æ”¹**
>
> æœ¬æ–‡æ¡£é˜è¿°çš„å…¥ç«™å¤„ç†æœºåˆ¶æ˜¯ä¿éšœæ¡†æ¶æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚ Actor çš„å•çº¿ç¨‹æ‰§è¡Œæ¨¡å‹ã€æ¶ˆæ¯è·¯ç”±æ­£ç¡®æ€§ï¼‰çš„åŸºçŸ³ã€‚è‡ªå®šä¹‰å…¥ç«™å¤„ç†é€»è¾‘æ˜¯ä¸€ä¸ªæå…¶é«˜çº§ä¸”å±é™©çš„æ“ä½œã€‚
>
> **åœ¨ 99% çš„æƒ…å†µä¸‹ï¼Œæ‚¨éƒ½<u>ä¸åº”è¯¥</u>å°è¯•æ›¿æ¢æˆ–ä¿®æ”¹æ­¤ç»„ä»¶ã€‚**
>
> åªæœ‰åœ¨æ‚¨éœ€è¦å®ç°ä¸€ä¸ªå…¨æ–°çš„åº•å±‚ä¼ è¾“åè®®ï¼Œæˆ–è€…éœ€è¦å¯¹æµé‡åˆ†è¯Šæœºåˆ¶è¿›è¡Œæ ¹æœ¬æ€§é‡æ„æ—¶ï¼Œæ‰åº”è€ƒè™‘æ­¤æ“ä½œã€‚ä»»ä½•ä¸æ­£ç¡®çš„ä¿®æ”¹éƒ½å¯èƒ½è½»æ˜“åœ°ç ´å Actor çš„å¹¶å‘å®‰å…¨ä¿è¯ï¼Œæˆ–å¯¼è‡´ç³»ç»Ÿå‡ºç°æ¶ˆæ¯è·¯ç”±é”™è¯¯ã€‚
>
> åœ¨å°è¯•è‡ªå®šä¹‰å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²å®Œå…¨ç†è§£æœ¬æ–‡æ¡£æè¿°çš„æ‰€æœ‰æœºåˆ¶ï¼Œå¹¶å‚è€ƒå®é™…ä»£ç å®ç°ã€‚

`Input Handler` æ˜¯ `ActrSystem` çš„â€œå‰é—¨â€ï¼Œæ‰€æœ‰æ¥è‡ªå¤–éƒ¨ä¸–ç•Œçš„ç½‘ç»œæµé‡éƒ½å¿…é¡»å…ˆç»è¿‡å®ƒçš„å¤„ç†ã€‚å®ƒçœ‹ä¼¼åªæ˜¯ä¸€ä¸ªç®€å•çš„æ•°æ®åŒ…è½¬å‘å™¨ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒæ˜¯æ¡†æ¶å®ç°**é«˜æ€§èƒ½**ä¸**ç¨³å®šæ€§**ä¸¤å¤§åŸºçŸ³çš„å…³é”®æ‰€åœ¨ã€‚

`Input Handler` çš„è‰ºæœ¯ä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š
1.  **é«˜æ•ˆçš„æµé‡åˆ†è¯Š (Triage)**: å®ƒå¿…é¡»ä»¥æœ€ä½çš„å¼€é”€ï¼Œå¿«é€ŸåŒºåˆ†å‡ºéœ€è¦ä¸¥æ ¼é¡ºåºä¿è¯çš„**çŠ¶æ€ç±»æ¶ˆæ¯**å’Œéœ€è¦æè‡´æ€§èƒ½çš„**æµå¼æ•°æ®**ï¼Œå¹¶å°†å®ƒä»¬é€å¾€æ­£ç¡®çš„å†…éƒ¨å¤„ç†è·¯å¾„ã€‚
2.  **çµæ•çš„å‹åŠ›ä¼ å¯¼ (Pressure Propagation)**: å®ƒå¿…é¡»èƒ½å¤Ÿæ„ŸçŸ¥åˆ°æ¡†æ¶å†…éƒ¨ï¼ˆåº”ç”¨å±‚ï¼‰çš„å¤„ç†å‹åŠ›ï¼Œå¹¶å°†å…¶æ­£ç¡®åœ°â€œç¿»è¯‘â€å’Œä¼ å¯¼ç»™å¤–éƒ¨ç½‘ç»œï¼ˆä¼ è¾“å±‚ï¼‰ï¼Œå½¢æˆä¸€å¥—å®Œæ•´çš„ç«¯åˆ°ç«¯**èƒŒå‹ (Backpressure)** æœºåˆ¶ã€‚

æœ¬ç¯‡æ–‡ç« å°†æ·±å…¥è¿™ä¸¤ä¸ªä¸»é¢˜ï¼Œæ­ç¤º `Input Handler` çš„å†…éƒ¨å·¥ä½œåŸç†ã€‚

### **1. æµé‡åˆ†è¯Šï¼šç³»ç»Ÿçš„æ™ºèƒ½è·¯ç”±å™¨**

å½“ä¸€ä¸ªæ•°æ®åŒ…ä» WebRTC `DataChannel` åˆ°è¾¾æ—¶ï¼Œ`Input Handler` çš„é¦–è¦èŒè´£å°±æ˜¯å›ç­”ä¸€ä¸ªé—®é¢˜ï¼šâ€œè¿™ä¸ªåŒ…è¦å»å“ªé‡Œï¼Ÿâ€

```mermaid
graph TD
    subgraph g1
        direction LR
        
        Packet["fa:fa-box-open <b>åŸå§‹æ•°æ®åŒ…</b><br/><i>(Bytes from DataChannel)</i>"]
        
        subgraph g2
            InputHandler["<b>Input Handler</b><br/><i>(The Triage Point)</i>"]
        end

        subgraph g3
            StatePath["fa:fa-cogs <b>çŠ¶æ€è·¯å¾„</b><br/><i>(To Mailbox)</i>"]
            FastPath["fa:fa-bolt <b>å¿«è½¦é“ (Fast Path)</b><br/><i>(Direct Callback)</i>"]
        end
    end
    
    Packet -- "è¿›å…¥" --> InputHandler
    InputHandler -- "<b>çŠ¶æ€ç±»æ¶ˆæ¯</b>" --> StatePath
    InputHandler -- "<b>æµå¼æ•°æ®</b>" --> FastPath
    
    style Packet fill:#fbe9e7,stroke:#d84315
    style InputHandler fill:#fff3e0,stroke:#f57c00
    style StatePath fill:#f0f4f8,stroke:#546e7a
    style FastPath fill:#e8f5e9,stroke:#388e3c
```
*å›¾ 1: Input Handler ä½œä¸ºæµé‡åˆ†è¯Šç‚¹*

ä¸ºäº†åšå‡ºè¿™ä¸ªå†³å®šï¼Œ`Handler` ä¾èµ–äºåœ¨é€šä¿¡å»ºç«‹æ—¶å°±çº¦å®šå¥½çš„ç­–ç•¥ã€‚

*   **ç­–ç•¥ A: åŸºäº `DataChannel` æ ‡ç­¾**
    è¿™æ˜¯ä¸€ç§ç‰©ç†éš”ç¦»çš„ç­–ç•¥ã€‚æ¡†æ¶å¯ä»¥çº¦å®šï¼š
    *   æ‰€æœ‰**çŠ¶æ€ç±»æ¶ˆæ¯**éƒ½é€šè¿‡ä¸€ä¸ªåä¸º `"control"` çš„å¯é ã€æœ‰åº `DataChannel` ä¼ è¾“ã€‚
    *   æ¯ä¸ª**æµå¼æ•°æ®**ï¼ˆå¦‚æ–‡ä»¶ä¼ è¾“ï¼‰åˆ™ä¼šåŠ¨æ€åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ã€ä¸å¯é ã€æ— åºçš„ `DataChannel`ï¼Œå…¶æ ‡ç­¾å°±æ˜¯æµçš„ `stream_id`ã€‚

*   **ç­–ç•¥ B: åŸºäºæ¶ˆæ¯ä¿¡å°**
    è¿™æ˜¯ä¸€ç§é€»è¾‘éš”ç¦»çš„ç­–ç•¥ã€‚æ‰€æœ‰æµé‡éƒ½é€šè¿‡åŒä¸€ä¸ª `DataChannel`ï¼Œä½†æ¯ä¸ªæ¶ˆæ¯éƒ½è¢«ä¸€ä¸ªç»Ÿä¸€çš„ä¿¡å°åŒ…è£¹ã€‚
    ```
    // æ¶ˆæ¯ä¿¡å°ç»“æ„ (ä¼ªä»£ç )
    [ 1 byte: Type ] [ N bytes: Destination ID ] [ ... Payload ... ]
    - Type: 0x01 è¡¨ç¤ºçŠ¶æ€ç±»æ¶ˆæ¯, 0x02 è¡¨ç¤ºæµå¼æ•°æ®
    - Destination ID: å¦‚æœæ˜¯çŠ¶æ€ç±»æ¶ˆæ¯ï¼Œè¿™é‡Œæ˜¯æ–¹æ³•åï¼›å¦‚æœæ˜¯æµå¼æ•°æ®ï¼Œè¿™é‡Œæ˜¯ stream_id
    ```

æ— è®ºé‡‡ç”¨å“ªç§ç­–ç•¥ï¼Œ`Input Handler` çš„åˆ†è¯Šé€»è¾‘éƒ½å¿…é¡»æå…¶è½»é‡ã€‚

#### **åˆ†è¯Šé€»è¾‘ä¼ªä»£ç **

```rust
// Input Handler çš„ä¸»å¤„ç†å¾ªç¯ (ä¼ªä»£ç )
async fn handle_incoming_datachannel(
    channel: Arc<DataChannel>,
    state_path_tx: mpsc::Sender<StateMessage>,
    fast_path_registry: Arc<DashMap<StreamId, Callback>>,
) {
    // ç›‘å¬æ•°æ®é€šé“çš„æ¶ˆæ¯äº‹ä»¶
    channel.on_message(|msg: Message| {
        // --- åˆ†è¯Šé€»è¾‘å¼€å§‹ ---

        // ç­–ç•¥ A: æ£€æŸ¥ DataChannel æ ‡ç­¾
        let label = channel.label();
        if label == "control" {
            // è¿™æ˜¯ä¸€ä¸ªçŠ¶æ€ç±»æ¶ˆæ¯
            let state_msg = StateMessage::decode(msg.data); // è§£æ
            // å‘é€åˆ°çŠ¶æ€è·¯å¾„çš„æœ‰ç•Œ channel
            state_path_tx.send(state_msg).await; // <-- èƒŒå‹ç‚¹ 1
        } else {
            // è¿™æ˜¯ä¸€ä¸ªæµå¼æ•°æ®æ¶ˆæ¯ï¼Œæ ‡ç­¾å³ stream_id
            let stream_id = StreamId::from(label);
            
            // åœ¨å¿«è½¦é“æ³¨å†Œè¡¨ä¸­æŸ¥æ‰¾å›è°ƒ
            if let Some(callback) = fast_path_registry.get(&stream_id) {
                // ç›´æ¥è°ƒç”¨å›è°ƒï¼Œä¸ç»è¿‡ä»»ä½• channel
                callback(msg.data);
            }
        }
    });
}
```

### **2. å‹åŠ›ä¼ å¯¼ï¼šåš WebRTC èƒŒå‹æœºåˆ¶çš„â€œå¥½é˜Ÿå‹â€**

ä½ å¯¹èƒŒå‹çš„ç†è§£æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼šæ¡†æ¶çš„è´£ä»»æ˜¯**å°† `ActrSystem` å†…éƒ¨çš„å‹åŠ›å‡†ç¡®åœ°å‘â€œæ›´åæ–¹â€çš„ WebRTC ç³»ç»Ÿä¼ é€’ï¼Œé›†åˆ WebRTC è‡ªå·±çš„èƒŒå‹é€»è¾‘ï¼Œæœ€ç»ˆå®Œæˆæ•´ä¸ªç³»ç»Ÿçš„å‹åŠ›åé¦ˆã€‚**

WebRTC `DataChannel` è‡ªèº«å·²ç»å®ç°äº†ä¸€å¥—åŸºäº `bufferedAmount` å’Œ `bufferedAmountLowThreshold` çš„ã€éå¸¸æˆç†Ÿçš„èƒŒå‹æœºåˆ¶ã€‚å¦‚æœæ¥æ”¶æ–¹å¤„ç†ä¸è¿‡æ¥ï¼Œå®ƒçš„æ¥æ”¶ç¼“å†²åŒºä¼šè¢«å¡«æ»¡ï¼Œåè®®æ ˆä¼šè‡ªåŠ¨é€šçŸ¥å‘é€æ–¹é™ä½å‘é€é€Ÿç‡æˆ–æš‚åœå‘é€ã€‚

æˆ‘ä»¬æ¡†æ¶çš„**å”¯ä¸€ä»»åŠ¡**ï¼Œå°±æ˜¯**ä¸è¦ç ´å**è¿™ä¸ªé“¾æ¡ã€‚

#### **å‹åŠ›ä¼ å¯¼é“¾æ¡è¯¦è§£**

```mermaid
sequenceDiagram
    participant Peer as WebRTC Peer (Sender)
    participant WT as WebRTC Transport (Receiver)
    participant IH as Input Handler
    participant MB as Mailbox (Bounded Channel)
    participant ActorLogic as Actor Logic

    Note over Peer,ActorLogic: ç«¯åˆ°ç«¯èƒŒå‹çš„å®Œæ•´æµç¨‹
    
    ActorLogic->>MB: å¤„ç†ç¼“æ…¢ (Slow processing)
    MB->>MB: å†…éƒ¨ Channel è¢«å¡«æ»¡ (Channel full)
    
    IH->>MB: .send(msg).await
    Note right of IH: å¼‚æ­¥ send æ“ä½œè¢«é˜»å¡<br/>(Pressure Point)
    
    WT->>IH: æš‚åœä» DataChannel è¯»å–<br/>(Stop reading bytes)
    WT->>WT: æ¥æ”¶ç¼“å†²åŒºè¢«å¡«æ»¡<br/>(Rx Buffer full)
    
    WT-->>Peer: å‘é€æµæ§ä¿¡å·<br/>(SCTP WINDOW_UPDATE)
    
    Peer->>Peer: æš‚åœå‘é€<br/>(Stop sending)
```
*å›¾ 2: èƒŒå‹ä» Actor é€»è¾‘åå‘ä¼ æ’­åˆ°ç½‘ç»œå‘é€æ–¹çš„è¿‡ç¨‹*

è¿™ä¸ªé“¾æ¡å¾—ä»¥æˆç«‹çš„å…³é”®åœ¨äºä¸¤ç‚¹ï¼š

1.  **æœ‰ç•Œé€šé“ (Bounded Channels)**: `Input Handler` ä¸ `Mailbox` ä¹‹é—´é€šä¿¡çš„ `mpsc::channel` **å¿…é¡»**æ˜¯æœ‰å›ºå®šå®¹é‡çš„ï¼ˆä¾‹å¦‚ `mpsc::channel(128)`ï¼‰ã€‚ä¸€ä¸ªæ— ç•Œçš„ channel ä¼šæ— é™ç¼“å†²æ¶ˆæ¯ï¼Œç›´åˆ°è€—å°½ç³»ç»Ÿå†…å­˜ï¼Œä»è€Œåˆ‡æ–­äº†å‹åŠ›ä¼ å¯¼é“¾ã€‚

2.  **å¼‚æ­¥ `send` æ“ä½œ**: `Input Handler` åœ¨è°ƒç”¨ `state_path_tx.send(msg).await` æ—¶ï¼Œå¦‚æœ channel å·²æ»¡ï¼Œ`.await` ä¼šå¼‚æ­¥åœ°æš‚åœå½“å‰ä»»åŠ¡çš„æ‰§è¡Œï¼Œç›´åˆ° channel ä¸­æœ‰ç©ºé—´ä¸ºæ­¢ã€‚

#### **ä¼ªä»£ç ä¸­çš„å…³é”®**

è®©æˆ‘ä»¬å†æ¬¡å®¡è§† `Input Handler` çš„ä¼ªä»£ç ï¼Œå¹¶èšç„¦äºèƒŒå‹çš„å…³é”®ç‚¹ã€‚

```rust
async fn handle_incoming_datachannel(
    channel: Arc<DataChannel>,
    // è¿™æ˜¯ä¸€ä¸ª **æœ‰ç•Œ** channel çš„å‘é€ç«¯
    state_path_tx: mpsc::Sender<StateMessage>,
    // ...
) {
    channel.on_message(|msg: Message| {
        // ...
        if is_state_message {
            // ...
            
            // --- è¿™æ˜¯æ•´ä¸ªèƒŒå‹æœºåˆ¶çš„â€œæ‰³æœºâ€ ---
            // å¦‚æœçŠ¶æ€è·¯å¾„ç¹å¿™ï¼Œå¯¼è‡´ state_path_tx çš„ channel æ»¡äº†ï¼Œ
            // è¿™é‡Œçš„ .await æ“ä½œå°†ä¼šæš‚åœï¼Œä¸ä¼šç«‹å³è¿”å›ã€‚
            //
            // å› ä¸ºè¿™ä¸ª on_message å›è°ƒè¢«æš‚åœäº†ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå»ä»
            // åº•å±‚çš„ DataChannel è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®åŒ…ã€‚
            // è¿™å°±è®© DataChannel çš„æ¥æ”¶ç¼“å†²åŒºæœ‰æœºä¼šè¢«å¡«æ»¡ï¼Œ
            // ä»è€Œè§¦å‘ WebRTC åè®®è‡ªèº«çš„èƒŒå‹æœºåˆ¶ã€‚
            // å‹åŠ›è¢«æˆåŠŸä¼ å¯¼äº†ï¼
            state_path_tx.send(state_msg).await;
            
        } else {
            // ... å¿«è½¦é“é€»è¾‘ ...
            // æ³¨æ„ï¼šå¿«è½¦é“é€»è¾‘æ˜¯ç›´æ¥è°ƒç”¨ï¼Œå¦‚æœå®ƒæœ¬èº«æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œ
            // åŒæ ·ä¼šé˜»å¡ on_message å›è°ƒï¼Œä¹Ÿèƒ½ä¼ å¯¼å‹åŠ›ã€‚
        }
    });
}
```

### **3. æ€»ç»“**

`Input Handler` æ˜¯æ¡†æ¶ä¸­ä¸€ä¸ªçœ‹ä¼¼ç®€å•å´è‡³å…³é‡è¦çš„ç»„ä»¶ã€‚å®ƒé€šè¿‡è½»é‡çº§çš„åˆ†è¯Šé€»è¾‘ï¼Œå°†æµé‡é«˜æ•ˆåœ°å¯¼å…¥çŠ¶æ€è·¯å¾„å’Œæµå¼æ•°æ®è·¯å¾„ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒé€šè¿‡**æœ‰ç•Œå†…éƒ¨é€šé“**å’Œ**å¼‚æ­¥å‘é€æ“ä½œ**ï¼Œæ„å»ºäº†ä¸€ä¸ªçµæ•çš„â€œå‹åŠ›é˜€é—¨â€ã€‚è¿™ä¸ªé˜€é—¨ä¸ä¼šè‡ªå·±å¤„ç†å‹åŠ›ï¼Œè€Œæ˜¯å·§å¦™åœ°åˆ©ç”¨å¼‚æ­¥è¿è¡Œæ—¶çš„æš‚åœæœºåˆ¶ï¼Œå°†å†…éƒ¨æ‹¥å µçš„â€œä¿¡å·â€åå‘ä¼ æ’­ç»™ WebRTC ä¼ è¾“å±‚ï¼Œè®©ä¸“ä¸šï¼ˆä¸”åœ¨åè®®å±‚å®ç°ï¼Œæ•ˆç‡æé«˜ï¼‰çš„æµé‡æ§åˆ¶æœºåˆ¶æ¥å®ŒæˆçœŸæ­£çš„å·¥ä½œã€‚

æ­£æ˜¯è¿™ç§å¯¹åº•å±‚æœºåˆ¶çš„å°Šé‡å’Œå·§å¦™åˆ©ç”¨ï¼Œä½¿å¾—æ¡†æ¶åœ¨æä¾›é«˜çº§æŠ½è±¡çš„åŒæ—¶ï¼Œä¾ç„¶èƒ½ä¿æŒç³»ç»Ÿçš„ç¨³å®šæ€§å’Œé«˜æ€§èƒ½ã€‚
